(()=>{var e={521:(e,t)=>{"use strict";function i(e){var t=void 0;return"undefined"!=typeof Reflect&&"function"==typeof Reflect.ownKeys?t=Reflect.ownKeys(e.prototype):(t=Object.getOwnPropertyNames(e.prototype),"function"==typeof Object.getOwnPropertySymbols&&(t=t.concat(Object.getOwnPropertySymbols(e.prototype)))),t.forEach((function(t){if("constructor"!==t){var i=Object.getOwnPropertyDescriptor(e.prototype,t);"function"==typeof i.value&&Object.defineProperty(e.prototype,t,n(e,t,i))}})),e}function n(e,t,i){var n=i.value;if("function"!=typeof n)throw new Error("@autobind decorator can only be applied to methods not: "+typeof n);var s=!1;return{configurable:!0,get:function(){if(s||this===e.prototype||this.hasOwnProperty(t))return n;var i=n.bind(this);return s=!0,Object.defineProperty(this,t,{value:i,configurable:!0,writable:!0}),s=!1,i}}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return 1===t.length?i.apply(void 0,t):n.apply(void 0,t)},e.exports=t.default},703:(e,t,i)=>{"use strict";var n=i(414);function s(){}function a(){}a.resetWarningCache=s,e.exports=function(){function e(e,t,i,s,a,r){if(r!==n){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function t(){return e}e.isRequired=e;var i={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:a,resetWarningCache:s};return i.PropTypes=i,i}},697:(e,t,i)=>{e.exports=i(703)()},414:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},322:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=i(288),a=(n=s)&&n.__esModule?n:{default:n};t.default=a.default,e.exports=t.default},203:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default={activeTrack:"input-range__track input-range__track--active",disabledInputRange:"input-range input-range--disabled",inputRange:"input-range",labelContainer:"input-range__label-container",maxLabel:"input-range__label input-range__label--max",minLabel:"input-range__label input-range__label--min",slider:"input-range__slider",sliderContainer:"input-range__slider-container",track:"input-range__track input-range__track--background",valueLabel:"input-range__label input-range__label--value"},e.exports=t.default},288:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=v(i(363)),r=v(i(697)),o=v(i(521)),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(232)),h=v(i(203)),c=v(i(191)),u=v(i(807)),p=v(i(97)),d=v(i(737)),m=v(i(752)),f=i(302),g=i(878);function v(e){return e&&e.__esModule?e:{default:e}}function b(e,t,i,n,s){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),a),s&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(s):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var _=(n=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.startValue=null,i.node=null,i.trackNode=null,i.isSliderDragging=!1,i.lastKeyMoved=null,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),s(t,null,[{key:"propTypes",get:function(){return{allowSameValues:r.default.bool,ariaLabelledby:r.default.string,ariaControls:r.default.string,classNames:r.default.objectOf(r.default.string),disabled:r.default.bool,draggableTrack:r.default.bool,formatLabel:r.default.func,maxValue:u.default,minValue:u.default,name:r.default.string,onChangeStart:r.default.func,onChange:r.default.func.isRequired,onChangeComplete:r.default.func,step:r.default.number,value:p.default}}},{key:"defaultProps",get:function(){return{allowSameValues:!1,classNames:h.default,disabled:!1,maxValue:10,minValue:0,step:1}}}]),s(t,[{key:"componentWillUnmount",value:function(){this.removeDocumentMouseUpListener(),this.removeDocumentTouchEndListener()}},{key:"getComponentClassName",value:function(){return this.props.disabled?this.props.classNames.disabledInputRange:this.props.classNames.inputRange}},{key:"getTrackClientRect",value:function(){return this.trackNode.getClientRect()}},{key:"getKeyByPosition",value:function(e){var t=l.getValueFromProps(this.props,this.isMultiValue()),i=l.getPositionsFromValues(t,this.props.minValue,this.props.maxValue,this.getTrackClientRect());if(this.isMultiValue()&&(0,f.distanceTo)(e,i.min)<(0,f.distanceTo)(e,i.max))return"min";return"max"}},{key:"getKeys",value:function(){return this.isMultiValue()?["min","max"]:["max"]}},{key:"hasStepDifference",value:function(e){var t=l.getValueFromProps(this.props,this.isMultiValue());return(0,f.length)(e.min,t.min)>=this.props.step||(0,f.length)(e.max,t.max)>=this.props.step}},{key:"isMultiValue",value:function(){return(0,f.isObject)(this.props.value)}},{key:"isWithinRange",value:function(e){return this.isMultiValue()?e.min>=this.props.minValue&&e.max<=this.props.maxValue&&this.props.allowSameValues?e.min<=e.max:e.min<e.max:e.max>=this.props.minValue&&e.max<=this.props.maxValue}},{key:"shouldUpdate",value:function(e){return this.isWithinRange(e)&&this.hasStepDifference(e)}},{key:"updatePosition",value:function(e,t){var i=l.getValueFromProps(this.props,this.isMultiValue()),n=l.getPositionsFromValues(i,this.props.minValue,this.props.maxValue,this.getTrackClientRect());n[e]=t,this.lastKeyMoved=e,this.updatePositions(n)}},{key:"updatePositions",value:function(e){var t={min:l.getValueFromPosition(e.min,this.props.minValue,this.props.maxValue,this.getTrackClientRect()),max:l.getValueFromPosition(e.max,this.props.minValue,this.props.maxValue,this.getTrackClientRect())},i={min:l.getStepValueFromValue(t.min,this.props.step),max:l.getStepValueFromValue(t.max,this.props.step)};this.updateValues(i)}},{key:"updateValue",value:function(e,t){var i=l.getValueFromProps(this.props,this.isMultiValue());i[e]=t,this.updateValues(i)}},{key:"updateValues",value:function(e){this.shouldUpdate(e)&&this.props.onChange(this.isMultiValue()?e:e.max)}},{key:"incrementValue",value:function(e){var t=l.getValueFromProps(this.props,this.isMultiValue())[e]+this.props.step;this.updateValue(e,t)}},{key:"decrementValue",value:function(e){var t=l.getValueFromProps(this.props,this.isMultiValue())[e]-this.props.step;this.updateValue(e,t)}},{key:"addDocumentMouseUpListener",value:function(){this.removeDocumentMouseUpListener(),this.node.ownerDocument.addEventListener("mouseup",this.handleMouseUp)}},{key:"addDocumentTouchEndListener",value:function(){this.removeDocumentTouchEndListener(),this.node.ownerDocument.addEventListener("touchend",this.handleTouchEnd)}},{key:"removeDocumentMouseUpListener",value:function(){this.node.ownerDocument.removeEventListener("mouseup",this.handleMouseUp)}},{key:"removeDocumentTouchEndListener",value:function(){this.node.ownerDocument.removeEventListener("touchend",this.handleTouchEnd)}},{key:"handleSliderDrag",value:function(e,t){var i=this;if(!this.props.disabled){var n=l.getPositionFromEvent(e,this.getTrackClientRect());this.isSliderDragging=!0,requestAnimationFrame((function(){return i.updatePosition(t,n)}))}}},{key:"handleTrackDrag",value:function(e,t){if(!this.props.disabled&&this.props.draggableTrack&&!this.isSliderDragging){var i=this.props,n=i.maxValue,s=i.minValue,a=i.value,r=a.max,o=a.min,h=l.getPositionFromEvent(e,this.getTrackClientRect()),c=l.getValueFromPosition(h,s,n,this.getTrackClientRect()),u=l.getStepValueFromValue(c,this.props.step),p=l.getPositionFromEvent(t,this.getTrackClientRect()),d=l.getValueFromPosition(p,s,n,this.getTrackClientRect()),m=l.getStepValueFromValue(d,this.props.step)-u,f={min:o-m,max:r-m};this.updateValues(f)}}},{key:"handleSliderKeyDown",value:function(e,t){if(!this.props.disabled)switch(e.keyCode){case g.LEFT_ARROW:case g.DOWN_ARROW:e.preventDefault(),this.decrementValue(t);break;case g.RIGHT_ARROW:case g.UP_ARROW:e.preventDefault(),this.incrementValue(t)}}},{key:"handleTrackMouseDown",value:function(e,t){if(!this.props.disabled){var i=this.props,n=i.maxValue,s=i.minValue,a=i.value,r=a.max,o=a.min;e.preventDefault();var h=l.getValueFromPosition(t,s,n,this.getTrackClientRect()),c=l.getStepValueFromValue(h,this.props.step);(!this.props.draggableTrack||c>r||c<o)&&this.updatePosition(this.getKeyByPosition(t),t)}}},{key:"handleInteractionStart",value:function(){this.props.onChangeStart&&this.props.onChangeStart(this.props.value),this.props.onChangeComplete&&!(0,f.isDefined)(this.startValue)&&(this.startValue=this.props.value)}},{key:"handleInteractionEnd",value:function(){this.isSliderDragging&&(this.isSliderDragging=!1),this.props.onChangeComplete&&(0,f.isDefined)(this.startValue)&&(this.startValue!==this.props.value&&this.props.onChangeComplete(this.props.value),this.startValue=null)}},{key:"handleKeyDown",value:function(e){this.handleInteractionStart(e)}},{key:"handleKeyUp",value:function(e){this.handleInteractionEnd(e)}},{key:"handleMouseDown",value:function(e){this.handleInteractionStart(e),this.addDocumentMouseUpListener()}},{key:"handleMouseUp",value:function(e){this.handleInteractionEnd(e),this.removeDocumentMouseUpListener()}},{key:"handleTouchStart",value:function(e){this.handleInteractionStart(e),this.addDocumentTouchEndListener()}},{key:"handleTouchEnd",value:function(e){this.handleInteractionEnd(e),this.removeDocumentTouchEndListener()}},{key:"renderSliders",value:function(){var e=this,t=l.getValueFromProps(this.props,this.isMultiValue()),i=l.getPercentagesFromValues(t,this.props.minValue,this.props.maxValue);return(this.props.allowSameValues&&"min"===this.lastKeyMoved?this.getKeys().reverse():this.getKeys()).map((function(n){var s=t[n],r=i[n],o=e.props,l=o.maxValue,h=o.minValue;return"min"===n?l=t.max:h=t.min,a.default.createElement(d.default,{ariaLabelledby:e.props.ariaLabelledby,ariaControls:e.props.ariaControls,classNames:e.props.classNames,formatLabel:e.props.formatLabel,key:n,maxValue:l,minValue:h,onSliderDrag:e.handleSliderDrag,onSliderKeyDown:e.handleSliderKeyDown,percentage:r,type:n,value:s})}))}},{key:"renderHiddenInputs",value:function(){var e=this;if(!this.props.name)return[];var t=this.isMultiValue(),i=l.getValueFromProps(this.props,t);return this.getKeys().map((function(n){var s=i[n],r=t?""+e.props.name+(0,f.captialize)(n):e.props.name;return a.default.createElement("input",{key:n,type:"hidden",name:r,value:s})}))}},{key:"render",value:function(){var e=this,t=this.getComponentClassName(),i=l.getValueFromProps(this.props,this.isMultiValue()),n=l.getPercentagesFromValues(i,this.props.minValue,this.props.maxValue);return a.default.createElement("div",{"aria-disabled":this.props.disabled,ref:function(t){e.node=t},className:t,onKeyDown:this.handleKeyDown,onKeyUp:this.handleKeyUp,onMouseDown:this.handleMouseDown,onTouchStart:this.handleTouchStart},a.default.createElement(c.default,{classNames:this.props.classNames,formatLabel:this.props.formatLabel,type:"min"},this.props.minValue),a.default.createElement(m.default,{classNames:this.props.classNames,draggableTrack:this.props.draggableTrack,ref:function(t){e.trackNode=t},percentages:n,onTrackDrag:this.handleTrackDrag,onTrackMouseDown:this.handleTrackMouseDown},this.renderSliders()),a.default.createElement(c.default,{classNames:this.props.classNames,formatLabel:this.props.formatLabel,type:"max"},this.props.maxValue),this.renderHiddenInputs())}}]),t}(a.default.Component),b(n.prototype,"handleSliderDrag",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleSliderDrag"),n.prototype),b(n.prototype,"handleTrackDrag",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTrackDrag"),n.prototype),b(n.prototype,"handleSliderKeyDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleSliderKeyDown"),n.prototype),b(n.prototype,"handleTrackMouseDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTrackMouseDown"),n.prototype),b(n.prototype,"handleInteractionStart",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleInteractionStart"),n.prototype),b(n.prototype,"handleInteractionEnd",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleInteractionEnd"),n.prototype),b(n.prototype,"handleKeyDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleKeyDown"),n.prototype),b(n.prototype,"handleKeyUp",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleKeyUp"),n.prototype),b(n.prototype,"handleMouseDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseDown"),n.prototype),b(n.prototype,"handleMouseUp",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseUp"),n.prototype),b(n.prototype,"handleTouchStart",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTouchStart"),n.prototype),b(n.prototype,"handleTouchEnd",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTouchEnd"),n.prototype),n);t.default=_,e.exports=t.default},878:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.DOWN_ARROW=40,t.LEFT_ARROW=37,t.RIGHT_ARROW=39,t.UP_ARROW=38},191:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;var n=a(i(363)),s=a(i(697));function a(e){return e&&e.__esModule?e:{default:e}}function r(e){var t=e.formatLabel?e.formatLabel(e.children,e.type):e.children;return n.default.createElement("span",{className:e.classNames[e.type+"Label"]},n.default.createElement("span",{className:e.classNames.labelContainer},t))}r.propTypes={children:s.default.node.isRequired,classNames:s.default.objectOf(s.default.string).isRequired,formatLabel:s.default.func,type:s.default.string.isRequired},e.exports=t.default},807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=e.maxValue,i=e.minValue;if(!(0,n.isNumber)(i)||!(0,n.isNumber)(t))return new Error('"minValue" and "maxValue" must be a number');if(i>=t)return new Error('"minValue" must be smaller than "maxValue"')};var n=i(302);e.exports=t.default},737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=h(i(363)),r=h(i(697)),o=h(i(521)),l=h(i(191));function h(e){return e&&e.__esModule?e:{default:e}}function c(e,t,i,n,s){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),a),s&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(s):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var u=(n=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.node=null,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),s(t,null,[{key:"propTypes",get:function(){return{ariaLabelledby:r.default.string,ariaControls:r.default.string,classNames:r.default.objectOf(r.default.string).isRequired,formatLabel:r.default.func,maxValue:r.default.number,minValue:r.default.number,onSliderDrag:r.default.func.isRequired,onSliderKeyDown:r.default.func.isRequired,percentage:r.default.number.isRequired,type:r.default.string.isRequired,value:r.default.number.isRequired}}}]),s(t,[{key:"componentWillUnmount",value:function(){this.removeDocumentMouseMoveListener(),this.removeDocumentMouseUpListener(),this.removeDocumentTouchEndListener(),this.removeDocumentTouchMoveListener()}},{key:"getStyle",value:function(){return{position:"absolute",left:100*(this.props.percentage||0)+"%"}}},{key:"addDocumentMouseMoveListener",value:function(){this.removeDocumentMouseMoveListener(),this.node.ownerDocument.addEventListener("mousemove",this.handleMouseMove)}},{key:"addDocumentMouseUpListener",value:function(){this.removeDocumentMouseUpListener(),this.node.ownerDocument.addEventListener("mouseup",this.handleMouseUp)}},{key:"addDocumentTouchMoveListener",value:function(){this.removeDocumentTouchMoveListener(),this.node.ownerDocument.addEventListener("touchmove",this.handleTouchMove)}},{key:"addDocumentTouchEndListener",value:function(){this.removeDocumentTouchEndListener(),this.node.ownerDocument.addEventListener("touchend",this.handleTouchEnd)}},{key:"removeDocumentMouseMoveListener",value:function(){this.node.ownerDocument.removeEventListener("mousemove",this.handleMouseMove)}},{key:"removeDocumentMouseUpListener",value:function(){this.node.ownerDocument.removeEventListener("mouseup",this.handleMouseUp)}},{key:"removeDocumentTouchMoveListener",value:function(){this.node.ownerDocument.removeEventListener("touchmove",this.handleTouchMove)}},{key:"removeDocumentTouchEndListener",value:function(){this.node.ownerDocument.removeEventListener("touchend",this.handleTouchEnd)}},{key:"handleMouseDown",value:function(){this.addDocumentMouseMoveListener(),this.addDocumentMouseUpListener()}},{key:"handleMouseUp",value:function(){this.removeDocumentMouseMoveListener(),this.removeDocumentMouseUpListener()}},{key:"handleMouseMove",value:function(e){this.props.onSliderDrag(e,this.props.type)}},{key:"handleTouchStart",value:function(){this.addDocumentTouchEndListener(),this.addDocumentTouchMoveListener()}},{key:"handleTouchMove",value:function(e){this.props.onSliderDrag(e,this.props.type)}},{key:"handleTouchEnd",value:function(){this.removeDocumentTouchMoveListener(),this.removeDocumentTouchEndListener()}},{key:"handleKeyDown",value:function(e){this.props.onSliderKeyDown(e,this.props.type)}},{key:"render",value:function(){var e=this,t=this.getStyle();return a.default.createElement("span",{className:this.props.classNames.sliderContainer,ref:function(t){e.node=t},style:t},a.default.createElement(l.default,{classNames:this.props.classNames,formatLabel:this.props.formatLabel,type:"value"},this.props.value),a.default.createElement("div",{"aria-labelledby":this.props.ariaLabelledby,"aria-controls":this.props.ariaControls,"aria-valuemax":this.props.maxValue,"aria-valuemin":this.props.minValue,"aria-valuenow":this.props.value,className:this.props.classNames.slider,draggable:"false",onKeyDown:this.handleKeyDown,onMouseDown:this.handleMouseDown,onTouchStart:this.handleTouchStart,role:"slider",tabIndex:"0"}))}}]),t}(a.default.Component),c(n.prototype,"handleMouseDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseDown"),n.prototype),c(n.prototype,"handleMouseUp",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseUp"),n.prototype),c(n.prototype,"handleMouseMove",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseMove"),n.prototype),c(n.prototype,"handleTouchStart",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTouchStart"),n.prototype),c(n.prototype,"handleTouchMove",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTouchMove"),n.prototype),c(n.prototype,"handleTouchEnd",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTouchEnd"),n.prototype),c(n.prototype,"handleKeyDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleKeyDown"),n.prototype),n);t.default=u,e.exports=t.default},752:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=l(i(363)),r=l(i(697)),o=l(i(521));function l(e){return e&&e.__esModule?e:{default:e}}function h(e,t,i,n,s){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),a),s&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(s):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var c=(n=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.node=null,i.trackDragEvent=null,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),s(t,null,[{key:"propTypes",get:function(){return{children:r.default.node.isRequired,classNames:r.default.objectOf(r.default.string).isRequired,draggableTrack:r.default.bool,onTrackDrag:r.default.func,onTrackMouseDown:r.default.func.isRequired,percentages:r.default.objectOf(r.default.number).isRequired}}}]),s(t,[{key:"getClientRect",value:function(){return this.node.getBoundingClientRect()}},{key:"getActiveTrackStyle",value:function(){var e=100*(this.props.percentages.max-this.props.percentages.min)+"%";return{left:100*this.props.percentages.min+"%",width:e}}},{key:"addDocumentMouseMoveListener",value:function(){this.removeDocumentMouseMoveListener(),this.node.ownerDocument.addEventListener("mousemove",this.handleMouseMove)}},{key:"addDocumentMouseUpListener",value:function(){this.removeDocumentMouseUpListener(),this.node.ownerDocument.addEventListener("mouseup",this.handleMouseUp)}},{key:"removeDocumentMouseMoveListener",value:function(){this.node.ownerDocument.removeEventListener("mousemove",this.handleMouseMove)}},{key:"removeDocumentMouseUpListener",value:function(){this.node.ownerDocument.removeEventListener("mouseup",this.handleMouseUp)}},{key:"handleMouseMove",value:function(e){this.props.draggableTrack&&(null!==this.trackDragEvent&&this.props.onTrackDrag(e,this.trackDragEvent),this.trackDragEvent=e)}},{key:"handleMouseUp",value:function(){this.props.draggableTrack&&(this.removeDocumentMouseMoveListener(),this.removeDocumentMouseUpListener(),this.trackDragEvent=null)}},{key:"handleMouseDown",value:function(e){var t={x:(e.touches?e.touches[0].clientX:e.clientX)-this.getClientRect().left,y:0};this.props.onTrackMouseDown(e,t),this.props.draggableTrack&&(this.addDocumentMouseMoveListener(),this.addDocumentMouseUpListener())}},{key:"handleTouchStart",value:function(e){e.preventDefault(),this.handleMouseDown(e)}},{key:"render",value:function(){var e=this,t=this.getActiveTrackStyle();return a.default.createElement("div",{className:this.props.classNames.track,onMouseDown:this.handleMouseDown,onTouchStart:this.handleTouchStart,ref:function(t){e.node=t}},a.default.createElement("div",{style:t,className:this.props.classNames.activeTrack}),this.props.children)}}]),t}(a.default.Component),h(n.prototype,"handleMouseMove",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseMove"),n.prototype),h(n.prototype,"handleMouseUp",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseUp"),n.prototype),h(n.prototype,"handleMouseDown",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleMouseDown"),n.prototype),h(n.prototype,"handleTouchStart",[o.default],Object.getOwnPropertyDescriptor(n.prototype,"handleTouchStart"),n.prototype),n);t.default=c,e.exports=t.default},97:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var i=e.maxValue,s=e.minValue,a=e[t];if(!((0,n.isNumber)(a)||(0,n.isObject)(a)&&(0,n.isNumber)(a.min)&&(0,n.isNumber)(a.max)))return new Error('"'+t+'" must be a number or a range object');if((0,n.isNumber)(a)&&(a<s||a>i))return new Error('"'+t+'" must be in between "minValue" and "maxValue"');if((0,n.isObject)(a)&&(a.min<s||a.min>i||a.max<s||a.max>i))return new Error('"'+t+'" must be in between "minValue" and "maxValue"')};var n=i(302);e.exports=t.default},232:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e};t.getPercentageFromPosition=a,t.getValueFromPosition=function(e,t,i,n){var s=a(e,n);return t+(i-t)*s},t.getValueFromProps=function(e,t){if(t)return n({},e.value);return{min:e.minValue,max:e.value}},t.getPercentageFromValue=r,t.getPercentagesFromValues=function(e,t,i){return{min:r(e.min,t,i),max:r(e.max,t,i)}},t.getPositionFromValue=o,t.getPositionsFromValues=function(e,t,i,n){return{min:o(e.min,t,i,n),max:o(e.max,t,i,n)}},t.getPositionFromEvent=function(e,t){var i=t.width,n=(e.touches?e.touches[0]:e).clientX;return{x:(0,s.clamp)(n-t.left,0,i),y:0}},t.getStepValueFromValue=function(e,t){return Math.round(e/t)*t};var s=i(302);function a(e,t){var i=t.width;return e.x/i||0}function r(e,t,i){return((0,s.clamp)(e,t,i)-t)/(i-t)||0}function o(e,t,i,n){var s=n.width;return{x:r(e,t,i)*s,y:0}}},939:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},e.exports=t.default},426:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,i){return Math.min(Math.max(e,t),i)},e.exports=t.default},588:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var i=Math.pow(t.x-e.x,2),n=Math.pow(t.y-e.y,2);return Math.sqrt(i+n)},e.exports=t.default},302:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(939);Object.defineProperty(t,"captialize",{enumerable:!0,get:function(){return c(n).default}});var s=i(426);Object.defineProperty(t,"clamp",{enumerable:!0,get:function(){return c(s).default}});var a=i(588);Object.defineProperty(t,"distanceTo",{enumerable:!0,get:function(){return c(a).default}});var r=i(330);Object.defineProperty(t,"isDefined",{enumerable:!0,get:function(){return c(r).default}});var o=i(49);Object.defineProperty(t,"isNumber",{enumerable:!0,get:function(){return c(o).default}});var l=i(344);Object.defineProperty(t,"isObject",{enumerable:!0,get:function(){return c(l).default}});var h=i(359);function c(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"length",{enumerable:!0,get:function(){return c(h).default}})},330:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return null!=e},e.exports=t.default},49:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return"number"==typeof e},e.exports=t.default},344:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.default=function(e){return null!==e&&"object"===(void 0===e?"undefined":i(e))},e.exports=t.default},359:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return Math.abs(e-t)},e.exports=t.default},121:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n}),e=i.hmd(e);const n=function(e){var t,i=e.Symbol;return"function"==typeof i?i.observable?t=i.observable:(t=i("observable"),i.observable=t):t="@@observable",t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==i.g?i.g:e)},363:e=>{"use strict";e.exports=React}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={id:n,loaded:!1,exports:{}};return e[n](a,a.exports,i),a.loaded=!0,a.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var e=i(363);const t=ReactDOM,n=PIXI;class s extends Array{constructor(e=((e,t)=>e-t)){super(),this._comparator=e}insert(e){let t=0,i=this.length-1,n=0;for(;t<=i;){if(n=Math.floor((t+i)/2),e===this[n])return this.splice(n,0,e),n;this._comparator(e,this[n])>0?t=n+1:i=n-1}return this.splice(t,0,e),t}remove(e){let t=this.indexOf(e);if(-1===t)throw new Error("Element doesn't exist");return this.splice(t,1),t}removeAt(e){if(e<0||e>=this.length)throw new RangeError("Index out of range.");let t=this[e];return this.splice(e,1),t}exists(e){return-1!==this.binarySearch(e)}binarySearch(e,t=!1){let i=0,n=this.length-1,s=0;if(0==this.length)return-1;if(t&&this._comparator(e,this[n])>0)return n;for(;i<=n;){if(s=Math.floor((i+n)/2),0===this._comparator(e,this[s])){for(;s>0&&0===this._comparator(this[s],this[s-1]);)s-=1;return s}if(this._comparator(e,this[s])>0)i=s+1;else{if(t&&this._comparator(e,this[s-1]))return s-1;n=s-1}}return t?i:-1}}class a{static noteStringToFrequency(e){let t=a.extractOctave(e),i=a.notes.indexOf(e.slice(0,-1))+3;return i=i+12*(t-1)+1,440*Math.pow(2,(i-49)/12)}static distanceBetweenNotes(e,t){return a.noteStringToNoteNumber(e)-a.noteStringToNoteNumber(t)}static noteNumberToNoteString(e){if(e<0)throw new RangeError("Note value cannot be less than 0");return a.notes[e%12]+Math.floor(e/12).toString()}static noteStringToNoteNumber(e){return 12*a.extractOctave(e)+a.notes.indexOf(e.slice(0,-1))}static extractOctave(e){if(2==e.length)return parseInt(e.charAt(1));if(3===e.length)return parseInt(e.charAt(2));throw new RangeError("String is invalid (incorrect length): "+e)}}var r;a.notes=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];var o=new Uint8Array(16);function l(){if(!r&&!(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(o)}const h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const c=function(e){return"string"==typeof e&&h.test(e)};for(var u=[],p=0;p<256;++p)u.push((p+256).toString(16).substr(1));const d=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(u[e[t+0]]+u[e[t+1]]+u[e[t+2]]+u[e[t+3]]+"-"+u[e[t+4]]+u[e[t+5]]+"-"+u[e[t+6]]+u[e[t+7]]+"-"+u[e[t+8]]+u[e[t+9]]+"-"+u[e[t+10]]+u[e[t+11]]+u[e[t+12]]+u[e[t+13]]+u[e[t+14]]+u[e[t+15]]).toLowerCase();if(!c(i))throw TypeError("Stringified UUID is invalid");return i};const m=function(e,t,i){var n=(e=e||{}).random||(e.rng||l)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var s=0;s<16;++s)t[i+s]=n[s];return t}return d(n)};class f{constructor(){this._callbacks=[]}get callbacks(){return this._callbacks}addListener(e){this._callbacks.push(e)}removeListener(e){let t=this._callbacks.indexOf(e);-1!=t&&this._callbacks.splice(t,1)}hasListener(e){return-1!=this._callbacks.indexOf(e)}removeAt(e){this._callbacks.splice(e,1)}removeAllListeners(){this._callbacks=[]}emit(...e){this._callbacks.forEach((t=>{t(...e)}))}}class g{constructor(e,t){this._duration=0,this.startPosition=e,null!=t&&(this.duration=t),this.id=m(),this.removed=new f}get duration(){return this._duration}set duration(e){this._duration=e}get endPosition(){return this.startPosition+this.duration}eventRemoved(){this.removed.emit()}serialise(){return{eventType:"BaseEvent",startPosition:this.startPosition,duration:this.duration}}static comparator(e,t){return e.startPosition>t.startPosition?1:e.startPosition<t.startPosition?-1:e.duration>t.duration?1:e.duration<t.duration?-1:0}}class v extends g{constructor(e,t,i=0){super(e),this._metadata=t,this.secondsDuration=i}get duration(){return this._metadata.positionSecondsToQuarterNote(this._duration)}set duration(e){this._duration=this._metadata.positionQuarterNoteToSeconds(e)}get secondsDuration(){return this._duration}set secondsDuration(e){this._duration=e}serialise(){let e=super.serialise();return e.eventType="SecondsBaseEvent",e.duration=this._duration,e}}class b extends g{constructor(e,t,i){super(e),this.pitchString=t,this.duration="string"==typeof i?this._parseQuarterNoteLength(i):i}get pitchString(){return this._pitchString}set pitchString(e){this._pitchString=e,this.pitch=a.noteStringToFrequency(e)}get duration(){return this._duration}set duration(e){if(e<0)throw new Error("Invalid duration value");this._duration=e}setDurationString(e){if(!b.durationPattern.test(e))throw new Error("Invalid duration value");this._duration=this._parseQuarterNoteLength(e)}serialise(){let e=super.serialise();return e.eventType="NoteEvent",e.pitch=this.pitch,e.pitchString=this.pitchString,e}_parseQuarterNoteLength(e){let t=parseInt(e.slice(0,e.length-1));switch(e.charAt(e.length-1)){case"n":return 4/t;case".":return 4/t*1.5;case"t":return 4/t/1.5;default:throw new Error("Invalid note.")}}toString(){return"(NoteEvent: Duration: "+this.duration+" Pitch: "+this.pitch+" startPosition: "+this.startPosition+")\n"}}b.durationPattern=new RegExp("^(1|2|4|8|16|32|64)(t|n|\\.)$");class _{constructor(e,t,i){this.startPosition=e,this.originalStartPosition=e,this.bpm=t,this.timeSignature=i}get bpm(){return this._bpm}set bpm(e){if(e<0)throw new Error("Invalid BPM: cannot be negative.");this._bpm=e,this._secondsPerBeat=60/this._bpm}get secondsPerBeat(){return this._secondsPerBeat}get timeSignature(){return this._timeSignature}set timeSignature(e){if(2!=e.length)throw new RangeError("Incorrect number of values in array.");if(e[0]<0||e[1]<0)throw new RangeError("Numbers must be greater than 0.");if(e[1]%2!=0)throw new RangeError("Second number must be a power of two.");this._timeSignature=e,this._quarterNoteMultiplier=this._timeSignature[1]/4}get quarterNoteMultiplier(){return this._quarterNoteMultiplier}static comparator(e,t){return"number"==typeof e?e-t.startPosition:e.startPosition-t.startPosition}serialise(){return{eventType:"MetadataEvent",startPosition:this.startPosition,bpm:this.bpm,timeSignature:this.timeSignature}}}class y{constructor(e=60,t=[4,4]){this._metaEvents=new s(_.comparator),this._metaEventSecondLengths=[],this._metaEventBarLengths=[],this._metaEventBeatLengths=[],this.addMetadataEvent(0,e,t)}get events(){return this._metaEvents}getBPM(e){return this._metaEvents[this._metaEvents.binarySearch(e,!0)].bpm}getSecondsPerBeat(e){return this._metaEvents[this._metaEvents.binarySearch(e,!0)].secondsPerBeat}getTimeSignature(e){return this._metaEvents[this._metaEvents.binarySearch(e,!0)].timeSignature}getQuarterNoteMultiplier(e){return this._metaEvents[this._metaEvents.binarySearch(e,!0)].quarterNoteMultiplier}positionQuarterNoteToSeconds(e){if(void 0===e||e<0)throw new RangeError("Time is invalid");let t=this._metaEvents.binarySearch(e,!0);return 0==t?e*this._metaEvents[t].quarterNoteMultiplier*this._metaEvents[t].secondsPerBeat:this._metaEventSecondLengths[t]+(e-this._metaEvents[t].startPosition)*this._metaEvents[t].quarterNoteMultiplier*this._metaEvents[t].secondsPerBeat}positionSecondsToQuarterNote(e){for(let t=this._metaEventSecondLengths.length-1;t>=0;t--)if(e>=this._metaEventSecondLengths[t])return this._metaEvents[t].startPosition+(e-this._metaEventSecondLengths[t])/this._metaEvents[t].secondsPerBeat/this._metaEvents[t].quarterNoteMultiplier}positionQuarterNoteToBars(e){if(void 0===e||e<0)throw new RangeError("Time is invalid");let t=this._metaEvents.binarySearch(e,!0);return 0==t?e*this._metaEvents[t].quarterNoteMultiplier/this._metaEvents[t].timeSignature[0]:this._metaEventBarLengths[t]+(e-this._metaEvents[t].startPosition)*this._metaEvents[t].quarterNoteMultiplier/this._metaEvents[t].timeSignature[0]}positionBarsToQuarterNote(e){for(let t=this._metaEventBarLengths.length-1;t>=0;t--)if(e>=this._metaEventBarLengths[t])return this._metaEvents[t].startPosition+(e-this._metaEventBarLengths[t])*this._metaEvents[t].timeSignature[0]/this._metaEvents[t].quarterNoteMultiplier}positionQuarterNoteToBeats(e){if(void 0===e||e<0)throw new RangeError("Time is invalid");let t=this._metaEvents.binarySearch(e,!0);return 0==t?e*this._metaEvents[t].quarterNoteMultiplier:this._metaEventBeatLengths[t]+(e-this._metaEvents[t].startPosition)*this._metaEvents[t].quarterNoteMultiplier}positionBeatsToQuarterNote(e){for(let t=this._metaEventBeatLengths.length-1;t>=0;t--)if(e>=this._metaEventBeatLengths[t])return this._metaEvents[t].startPosition+(e-this._metaEventBeatLengths[t])/this._metaEvents[t].quarterNoteMultiplier}addMetadataEvent(e,t,i){let n=this._metaEvents.binarySearch(e);-1===n?n=this._metaEvents.insert(new _(e,t,i)):(this._metaEvents[n].originalStartPosition=e,this._metaEvents[n].bpm=t,this._metaEvents[n].timeSignature=i),this.precalculateLengths();let s=[];for(let e=n+1;e<this._metaEvents.length;e++){let t=this._metaEvents[e-1],i=Math.round((this._metaEvents[e].originalStartPosition-t.startPosition)*t.quarterNoteMultiplier/t.timeSignature[0]),n=t.startPosition+i*t.timeSignature[0]/t.quarterNoteMultiplier;n!=this._metaEvents[e].startPosition&&-1!=this._metaEvents.binarySearch(n)?s.push(e):(this._metaEvents[e].startPosition=n,this.precalculateLengths())}return s.length>0&&(s.forEach((e=>{this._metaEvents.removeAt(e)})),this.precalculateLengths()),this._metaEvents[n]}removeMetadataEvent(e){if(0==e)throw new RangeError("Cannot remove initial event.");let t=this._metaEvents.binarySearch(e);if(-1==t)throw new RangeError("Event does not exist at this time.");this._metaEvents.removeAt(t),this.precalculateLengths()}precalculateLengths(){this._metaEventSecondLengths=[0],this._metaEventBarLengths=[0],this._metaEventBeatLengths=[0];let e=0,t=0,i=0;for(let n=1;n<this._metaEvents.length;n++){let s=this._metaEvents[n].startPosition-this._metaEvents[n-1].startPosition;e+=s*this._metaEvents[n-1].quarterNoteMultiplier*this._metaEvents[n-1].secondsPerBeat,this._metaEventSecondLengths.push(e),t+=s*this._metaEvents[n-1].quarterNoteMultiplier/this._metaEvents[n-1].timeSignature[0],this._metaEventBarLengths.push(t),i+=s*this._metaEvents[n-1].quarterNoteMultiplier,this._metaEventBeatLengths.push(i)}}serialise(){let e=[];return this._metaEvents.forEach((t=>{e.push(t.serialise())})),e}deserialise(e){this._metaEvents=new s,this.addMetadataEvent(0,60,[4,4]),e.forEach((e=>{"MetadataEvent"===e.eventType?this.addMetadataEvent(e.startPosition,e.bpm,e.timeSignature):console.log("SongMetadata does not support this event type.")}))}}class C{constructor(e,t=C.createDefaults()){this._settings=t,this.id=m(),this._context=e,this._masterGain=e.createGain(),this._masterGain.gain.value=this._settings.gain,this._sources=[C.newOscillator(e,t,this._masterGain)]}get oscillatorType(){return this._sources[0].oscillator.type}set oscillatorType(e){if(-1==["sine","square","sawtooth","triangle"].indexOf(e))throw new Error("Invalid oscillator type");this._settings.oscillatorType=e;for(let t=0;t<this._sources.length;t++)this._sources[t].oscillator.type=e}get masterGain(){return this._masterGain.gain.value}set masterGain(e){if(!(e>=0&&e<=1))throw new RangeError("Invalid Gain Value");this._settings.gain=e,this._masterGain.gain.setValueAtTime(e,this._context.currentTime)}get envelopeEnabled(){return this._settings.envelopeEnabled}set envelopeEnabled(e){this._settings.envelopeEnabled=e}get envelope(){return this._settings.envelope}set envelope(e){this._settings.envelope=e}connect(e){e instanceof AudioNode?this._masterGain.connect(e):this._masterGain.connect(e.input)}disconnect(e){e instanceof AudioNode?this._masterGain.disconnect(e):this._masterGain.disconnect(e.input)}disconnectAll(){this._masterGain.disconnect()}playNote(e,t,i){let n=null;for(let t=0;t<this._sources.length;t++){let i=!0,s=this._sources[t];for(let t=s.usage.length-1;t>=0;t--){let n=s.usage[t];if(this._context.currentTime>n[1])s.usage.splice(t,1);else if(e<=n[1]){i=!1;break}}if(i){n=s;break}}null===n&&(n=C.newOscillator(this._context,this._settings,this._masterGain),n.oscillator.frequency.setValueAtTime(i,0),this._sources.push(n)),n.usage.push([e,t]),this.scheduleNote(e,i,t,n.oscillator,n.gain)}scheduleNote(e,t,i,n,s,a=.999){e<this._context.currentTime&&(e=this._context.currentTime),n.frequency.setValueAtTime(t,e);let r=e+.001,o=i-.001;this._settings.envelopeEnabled&&(o=i-this._settings.envelope.release,r=e+this._settings.envelope.attack),o=Math.max(i-this._settings.envelope.release,e),r=Math.min(e+this._settings.envelope.attack,i),r>o&&(r=o),s.gain.cancelScheduledValues(e),s.gain.setTargetAtTime(1e-4,e,.01),s.gain.linearRampToValueAtTime(a,r),s.gain.cancelScheduledValues(o),s.gain.setValueAtTime(a,o),s.gain.exponentialRampToValueAtTime(1e-5,i)}stop(){this._sources.forEach((e=>{e.gain.gain.cancelScheduledValues(this._context.currentTime),e.gain.gain.setTargetAtTime(1e-4,this._context.currentTime,.03)}))}serialise(){return this._settings}destroy(){this._masterGain=null,this._sources=[]}static newOscillator(e,t,i){let n=e.createOscillator();n.start(),n.type=t.oscillatorType;let s=e.createGain();return s.gain.value=0,n.connect(s),s.connect(i),{oscillator:n,gain:s,usage:[]}}static createDefaults(){return{type:"oscillator",oscillatorType:"sine",gain:.5,envelopeEnabled:!0,envelope:{attack:.1,release:.1}}}}class k{constructor(){this._events=new s(g.comparator),this._eventPosition=0,this.longestEventIndex=null,this.longestEventValue=0}get events(){return this._events}get playbackTime(){if(this._events.length>0){let e=this._events[this.longestEventIndex];return e.startPosition+e.duration}return 0}updatePlaybackTime(){this.longestEventIndex=null,this.longestEventValue=0;for(let e=0;e<this._events.length;e++)this._events[e].startPosition+this._events[e].duration>this.longestEventValue&&(this.longestEventIndex=e)}addEvent(e){let t=this._events.insert(e);return null!=this.longestEventIndex&&e.startPosition+e.duration>this.longestEventValue?this.longestEventIndex=t:this.longestEventIndex=0,t}editEvent(e,t,i){let n=this.events[e];return n.startPosition=t,null!=i&&(n.duration=i),this.removeAt(e),this.addEvent(n)}removeEvent(e){let t=this.getIndexOfEvent(e);if(-1==t)throw new Error("Event doesn't exist.");this.removeAt(t)}removeAt(e){this._events.splice(e,1),e===this.longestEventIndex?this._events.length>0?this.updatePlaybackTime():this.longestEventIndex=null:e<this.longestEventIndex&&(this.longestEventIndex-=1)}getIndexOfEvent(e){return this.events.map((function(e){return e.id})).indexOf(e.id)}start(e){for(let t=0;t<this._events.length;t++)if(this._events[t].startPosition+this._events[t].duration>e){this._eventPosition=t;break}}getEventsUntilTime(e){let t=[];for(;this._eventPosition<this._events.length&&this._events[this._eventPosition].startPosition<e;)t.push(this._events[this._eventPosition]),this._eventPosition+=1;return t}getEventsBetweenTimes(e,t){let i=0,n=[];for(;i<this._events.length&&this._events[i].endPosition<=e;)i++;for(;i<this._events.length&&this._events[i].startPosition<t;)this._events[i].startPosition<t&&this._events[i].endPosition>e&&n.push(this._events[i]),i++;return n}serialise(){let e=[];for(let t=0;t<this.events.length;t++)e.push(this.events[t].serialise());return e}deserialise(e,t){for(let i=0;i<e.length;i++)switch(e[i].eventType){case"BaseEvent":this._events.push(new g(e[i].startPosition,e[i].duration));break;case"NoteEvent":this._events.push(new b(e[i].startPosition,e[i].pitchString,e[i].duration));break;case"SecondsBaseEvent":this._events.push(new v(e[i].startPosition,t,e[i].duration))}this.updatePlaybackTime()}}class E{constructor(e,t,i,n,s,a){this._startTime=0,this._playing=!1,this._timeline=new k,this._context=t,this._metadata=e,this._scheduleEvent=i,this._connectionManager=s,this._scheduleEventFunc=function(e){this.scheduleSongEvents(e)}.bind(this),this._scheduleEvent.addListener(this._scheduleEventFunc),this.audioSource=n,null!=a?(this.id=a.id,this._timeline.deserialise(a.events,this._metadata),this._connectionManager.createConnections(this.audioSource,a.connections)):(this.id=m(),this._connectionManager.createConnections(this.audioSource,["Context"]))}get timeline(){return this._timeline}get connection(){return this._connectionManager.getConnections(this.audioSource)[0]}get possibleConnections(){return this._connectionManager.possibleConnectionStrings}start(e){this.stop(),this._startTime=0==e?this._context.currentTime:this._context.currentTime-this._metadata.positionQuarterNoteToSeconds(e),this._playing=!0,this._timeline.start(e)}stop(){this.audioSource.stop(),this._playing=!1}scheduleSongEvents(e){if(this._playing){this._timeline.getEventsUntilTime(e).forEach((e=>{this.songEventHandler(e)}))}}scheduleAllEvents(){this._startTime=this._context.currentTime;for(let e=0;e<this._timeline.events.length;e++)this.songEventHandler(this._timeline.events[e])}connectTo(e){e in this._connectionManager.possibleConnections&&(this._connectionManager.removeAllConnections(this.audioSource),this._connectionManager.addConnection(this.audioSource,e))}serialise(){return{id:this.id,source:this.audioSource.serialise(),events:this.timeline.serialise(),connections:this._connectionManager.getConnections(this.audioSource)}}destroy(){this.stop(),this.audioSource.destroy(),this._scheduleEvent.removeListener(this._scheduleEventFunc),this.audioSource=null}}class w extends E{constructor(e,t,i,n,s){super(e,t,i,new C(t,s?s.source:void 0),n,s),this._pitchStrings={},s&&s.events.forEach((e=>{e.pitchString in this._pitchStrings?this._pitchStrings[e.pitchString]+=1:this._pitchStrings[e.pitchString]=1}))}get highestPitch(){let e="C0";return Object.keys(this._pitchStrings).forEach((t=>{a.distanceBetweenNotes(t,e)>0&&(e=t)})),e}get lowestPitch(){let e="B9";return Object.keys(this._pitchStrings).forEach((t=>{a.distanceBetweenNotes(t,e)<0&&(e=t)})),e}addNote(e,t,i){let n=new b(e,t,i);return this._timeline.addEvent(n),t in this._pitchStrings?this._pitchStrings[t]+=1:this._pitchStrings[t]=1,n}removeNote(e){this.timeline.removeEvent(e),e.pitchString in this._pitchStrings&&(this._pitchStrings[e.pitchString]-=1,this._pitchStrings[e.pitchString]<1&&delete this._pitchStrings[e.pitchString])}removeNoteByIndex(e){this._timeline.events.removeAt(e)}songEventHandler(e){if(!(e instanceof b))throw new Error("OscillatorTrack cannot handle this event type:"+e.constructor.name);{let t=this._startTime+this._metadata.positionQuarterNoteToSeconds(e.startPosition),i=this._startTime+this._metadata.positionQuarterNoteToSeconds(e.startPosition+e.duration);this.audioSource.playNote(t,i,e.pitch)}}}var N=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((n=n.apply(e,t||[])).next())}))};class T{static create(e,t=T.createDefaults()){return N(this,void 0,void 0,(function*(){const i=new T(e,t);return yield i.initialise(),i}))}constructor(e,t=T.createDefaults()){this._settings=t,this.id=m(),this._context=e,this._playingNodes=[],this._masterGain=e.createGain(),this._masterGain.gain.value=this._settings.gain}initialise(){return N(this,void 0,void 0,(function*(){""!=this._settings.soundData&&(this._audioBuffer=yield this._context.decodeAudioData(yield T.getBlobFromBase64(this._settings.soundData).arrayBuffer()))}))}get duration(){return null!=this._audioBuffer?this._audioBuffer.duration:0}get masterGain(){return this._masterGain.gain.value}set masterGain(e){if(!(e>=0&&e<=1))throw new RangeError("Invalid Gain Value");this._settings.gain=e,this._masterGain.gain.setValueAtTime(e,this._context.currentTime)}connect(e){e instanceof AudioNode?this._masterGain.connect(e):this._masterGain.connect(e.input)}disconnect(e){e instanceof AudioNode?this._masterGain.disconnect(e):this._masterGain.disconnect(e.input)}disconnectAll(){this._masterGain.disconnect()}playOneShot(e,t,i=1){let n=T.createBufferSource(this._context,this._audioBuffer);if(this._playingNodes.push(n),1!=i){let e=this._context.createGain();e.gain.value=i,n.connect(e),e.connect(this._masterGain)}else n.connect(this._masterGain);t<0&&(t=0),e=Math.max(0,e),n.start(e,t)}stop(){this._playingNodes.forEach((e=>{e.stop()})),this._playingNodes=[]}setSoundFile(e){return N(this,void 0,void 0,(function*(){T.getBase64FromBlob(e,(e=>{this._settings.soundData=e})),this._audioBuffer=yield this._context.decodeAudioData(yield e.arrayBuffer())}))}serialise(){return this._settings}destroy(){this._masterGain=null,this._playingNodes=[],this._audioBuffer=null}static createBufferSource(e,t){let i=e.createBufferSource();return i.buffer=t,i}static getBase64FromBlob(e,t){let i=new FileReader;i.onload=function(){t(i.result)},i.readAsDataURL(e)}static getBlobFromBase64(e){for(var t=atob(e.split(",")[1]),i=new ArrayBuffer(t.length),n=new Uint8Array(i),s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return new Blob([i],{type:e.split(":").pop().split(";")[0]})}static createDefaults(){return{type:"soundFile",gain:1,soundData:""}}}var S=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((n=n.apply(e,t||[])).next())}))};class x extends E{static create(e,t,i,n,s){return S(this,void 0,void 0,(function*(){const a=new x(e,t,i,n,s);return yield a.initialise(),a}))}get soundFileDuration(){return this._metadata.positionSecondsToQuarterNote(this.audioSource.duration)}constructor(e,t,i,n,s){super(e,t,i,new T(t,s?s.source:void 0),n,s),this.allowOverlaps=!1,s&&(this.allowOverlaps=s.allowOverlaps)}initialise(){return S(this,void 0,void 0,(function*(){yield this.audioSource.initialise()}))}addOneShot(e){if(!this.allowOverlaps&&this._timeline.getEventsBetweenTimes(e,e+this._metadata.positionSecondsToQuarterNote(this.audioSource.duration)).length>0)throw new RangeError("Invalid location: a playback event already occurs in the duration of the new event. Disable allowOverlaps to suppress this error.");let t=new v(e,this._metadata,this.audioSource.duration);return this._timeline.addEvent(t),t}removeOneShot(e){this._timeline.removeEvent(e)}setSoundFile(e){return S(this,void 0,void 0,(function*(){if(yield this.audioSource.setSoundFile(e),this._timeline.events.forEach((e=>{e.secondsDuration=this.audioSource.duration})),!this.allowOverlaps){let e=0;for(;e<this._timeline.events.length;){let t=this._timeline.events[e];this._timeline.getEventsBetweenTimes(t.startPosition,t.endPosition).forEach((e=>{e!=t&&this._timeline.removeEvent(e)})),e++}}this._timeline.updatePlaybackTime()}))}serialise(){return{id:this.id,source:this.audioSource.serialise(),events:this.timeline.serialise(),connections:this._connectionManager.getConnections(this.audioSource),allowOverlaps:this.allowOverlaps}}songEventHandler(e){if(!(e instanceof v))throw new Error("SoundFileTrack cannot handle this event type: "+e.constructor.name);{let t=this._startTime+this._metadata.positionQuarterNoteToSeconds(e.startPosition);this.audioSource.playOneShot(t,this._context.currentTime-t)}}}var P,M,O=function(e,t){e.value=t},D=Object.create(null,{activate:{writable:!0,value:function(e){e?(this.input.disconnect(),this.input.connect(this.activateNode),this.activateCallback&&this.activateCallback(e)):(this.input.disconnect(),this.input.connect(this.output))}},bypass:{get:function(){return this._bypass},set:function(e){this._lastBypassValue!==e&&(this._bypass=e,this.activate(!e),this._lastBypassValue=e)}},connect:{value:function(e){this.output.connect(e)}},disconnect:{value:function(e){this.output.disconnect(e)}},connectInOrder:{value:function(e){for(var t=e.length-1;t--;){if(!e[t].connect)return console.error("AudioNode.connectInOrder: TypeError: Not an AudioNode.",e[t]);e[t+1].input?e[t].connect(e[t+1].input):e[t].connect(e[t+1])}}},getDefaults:{value:function(){var e={};for(var t in this.defaults)e[t]=this.defaults[t].value;return e}},automate:{value:function(e,t,i,n){var s,a=n?~~(n/1e3):P.currentTime,r=i?~~(i/1e3):0,o=this.defaults[e],l=this[e];l?o.automatable?(i?(s="linearRampToValueAtTime",l.cancelScheduledValues(a),l.setValueAtTime(l.value,a)):s="setValueAtTime",l[s](t,r+a)):l=t:console.error("Invalid Property for "+this.name)}}}),G="float",L="boolean",B="int";function R(e){if(!(this instanceof R))return new R(e);var t="undefined"==typeof window?{}:window;if(t.AudioContext||(t.AudioContext=t.webkitAudioContext),e||(console.log("tuna.js: Missing audio context! Creating a new context for you."),e=t.AudioContext&&new t.AudioContext),!e)throw new Error("Tuna cannot initialize because this environment does not support web audio.");!function(e){if(!0===e.__connectified__)return;var t=e.createGain(),i=Object.getPrototypeOf(Object.getPrototypeOf(t)),n=i.connect;function s(){var e=arguments[0];return arguments[0]=D.isPrototypeOf?D.isPrototypeOf(e)?e.input:e:e.input||e,n.apply(this,arguments),e}i.connect=s,e.__connectified__=!0}(e),P=e,M=this}function F(e){return Math.max(0,Math.round(100*Math.pow(2,e/6))/100)}function A(e,t){var i,n,s,a=0,r=0,o=0;return i=e.toExponential().match(/^.\.?(.*)e(.+)$/),a=parseInt(i[2],10)-(i[1]+"").length,i=t.toExponential().match(/^.\.?(.*)e(.+)$/),(s=parseInt(i[2],10)-(i[1]+"").length)>a&&(a=s),n=e%t,a<-100||a>20?(r=Math.round(Math.log(n)/Math.log(10)),(n/(o=Math.pow(10,r))).toFixed(r-a)*o):parseFloat(n.toFixed(-a))}function j(e){return 0===e?1:Math.abs(e)/e}function H(e){return(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function I(e,t){return void 0===e?t:e}R.prototype.Bitcrusher=function(e){e||(e=this.getDefaults()),this.bufferSize=e.bufferSize||this.defaults.bufferSize.value,this.input=P.createGain(),this.activateNode=P.createGain(),this.processor=P.createScriptProcessor(this.bufferSize,1,1),this.output=P.createGain(),this.activateNode.connect(this.processor),this.processor.connect(this.output);var t,i,n,s,a,r=0,o=0;this.processor.onaudioprocess=function(e){for(t=e.inputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(0),n=Math.pow(.5,this.bits),a=t.length,s=0;s<a;s++)(r+=this.normfreq)>=1&&(r-=1,o=n*Math.floor(t[s]/n+.5)),i[s]=o},this.bits=e.bits||this.defaults.bits.value,this.normfreq=I(e.normfreq,this.defaults.normfreq.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Bitcrusher.prototype=Object.create(D,{name:{value:"Bitcrusher"},defaults:{writable:!0,value:{bits:{value:4,min:1,max:16,automatable:!1,type:B},bufferSize:{value:4096,min:256,max:16384,automatable:!1,type:B},bypass:{value:!1,automatable:!1,type:L},normfreq:{value:.1,min:1e-4,max:1,automatable:!1,type:G}}},bits:{enumerable:!0,get:function(){return this.processor.bits},set:function(e){this.processor.bits=e}},normfreq:{enumerable:!0,get:function(){return this.processor.normfreq},set:function(e){this.processor.normfreq=e}}}),R.prototype.Cabinet=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.convolver=this.newConvolver(e.impulsePath||"../impulses/impulse_guitar.wav"),this.makeupNode=P.createGain(),this.output=P.createGain(),this.activateNode.connect(this.convolver.input),this.convolver.output.connect(this.makeupNode),this.makeupNode.connect(this.output),this.makeupNode.gain.value=I(e.makeupGain,this.defaults.makeupGain.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Cabinet.prototype=Object.create(D,{name:{value:"Cabinet"},defaults:{writable:!0,value:{makeupGain:{value:1,min:0,max:20,automatable:!0,type:G},bypass:{value:!1,automatable:!1,type:L}}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.setTargetAtTime(e,P.currentTime,.01)}},newConvolver:{value:function(e){return new M.Convolver({impulse:e,dryLevel:0,wetLevel:1})}}}),R.prototype.Chorus=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.attenuator=this.activateNode=P.createGain(),this.splitter=P.createChannelSplitter(2),this.delayL=P.createDelay(),this.delayR=P.createDelay(),this.feedbackGainNodeLR=P.createGain(),this.feedbackGainNodeRL=P.createGain(),this.merger=P.createChannelMerger(2),this.output=P.createGain(),this.lfoL=new M.LFO({target:this.delayL.delayTime,callback:O}),this.lfoR=new M.LFO({target:this.delayR.delayTime,callback:O}),this.input.connect(this.attenuator),this.attenuator.connect(this.output),this.attenuator.connect(this.splitter),this.splitter.connect(this.delayL,0),this.splitter.connect(this.delayR,1),this.delayL.connect(this.feedbackGainNodeLR),this.delayR.connect(this.feedbackGainNodeRL),this.feedbackGainNodeLR.connect(this.delayR),this.feedbackGainNodeRL.connect(this.delayL),this.delayL.connect(this.merger,0,0),this.delayR.connect(this.merger,0,1),this.merger.connect(this.output),this.feedback=I(e.feedback,this.defaults.feedback.value),this.rate=I(e.rate,this.defaults.rate.value),this.delay=I(e.delay,this.defaults.delay.value),this.depth=I(e.depth,this.defaults.depth.value),this.lfoR.phase=Math.PI/2,this.attenuator.gain.value=.6934,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Chorus.prototype=Object.create(D,{name:{value:"Chorus"},defaults:{writable:!0,value:{feedback:{value:.4,min:0,max:.95,automatable:!1,type:G},delay:{value:.0045,min:0,max:1,automatable:!1,type:G},depth:{value:.7,min:0,max:1,automatable:!1,type:G},rate:{value:1.5,min:0,max:8,automatable:!1,type:G},bypass:{value:!1,automatable:!1,type:L}}},delay:{enumerable:!0,get:function(){return this._delay},set:function(e){this._delay=2*Math.pow(10,e)*2e-4,this.lfoL.offset=this._delay,this.lfoR.offset=this._delay,this._depth=this._depth}},depth:{enumerable:!0,get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._depth*this._delay,this.lfoR.oscillation=this._depth*this._delay}},feedback:{enumerable:!0,get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeLR.gain.setTargetAtTime(this._feedback,P.currentTime,.01),this.feedbackGainNodeRL.gain.setTargetAtTime(this._feedback,P.currentTime,.01)}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}}}),R.prototype.Compressor=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.compNode=this.activateNode=P.createDynamicsCompressor(),this.makeupNode=P.createGain(),this.output=P.createGain(),this.compNode.connect(this.makeupNode),this.makeupNode.connect(this.output),this.automakeup=I(e.automakeup,this.defaults.automakeup.value),this.automakeup?this.makeupNode.gain.value=F(this.computeMakeup()):this.makeupNode.gain.value=F(I(e.makeupGain,this.defaults.makeupGain.value)),this.threshold=I(e.threshold,this.defaults.threshold.value),this.release=I(e.release,this.defaults.release.value),this.attack=I(e.attack,this.defaults.attack.value),this.ratio=e.ratio||this.defaults.ratio.value,this.knee=I(e.knee,this.defaults.knee.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Compressor.prototype=Object.create(D,{name:{value:"Compressor"},defaults:{writable:!0,value:{threshold:{value:-20,min:-60,max:0,automatable:!0,type:G},release:{value:250,min:10,max:2e3,automatable:!0,type:G},makeupGain:{value:1,min:1,max:100,automatable:!0,type:G},attack:{value:1,min:0,max:1e3,automatable:!0,type:G},ratio:{value:4,min:1,max:50,automatable:!0,type:G},knee:{value:5,min:0,max:40,automatable:!0,type:G},automakeup:{value:!1,automatable:!1,type:L},bypass:{value:!1,automatable:!1,type:L}}},computeMakeup:{value:function(){var e=this.compNode;return-(e.threshold.value-e.threshold.value/e.ratio.value)/4}},automakeup:{enumerable:!0,get:function(){return this._automakeup},set:function(e){this._automakeup=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},threshold:{enumerable:!0,get:function(){return this.compNode.threshold},set:function(e){this.compNode.threshold.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},ratio:{enumerable:!0,get:function(){return this.compNode.ratio},set:function(e){this.compNode.ratio.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},knee:{enumerable:!0,get:function(){return this.compNode.knee},set:function(e){this.compNode.knee.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},attack:{enumerable:!0,get:function(){return this.compNode.attack},set:function(e){this.compNode.attack.value=e/1e3}},release:{enumerable:!0,get:function(){return this.compNode.release},set:function(e){this.compNode.release.value=e/1e3}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.setTargetAtTime(F(e),P.currentTime,.01)}}}),R.prototype.Convolver=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.convolver=P.createConvolver(),this.dry=P.createGain(),this.filterLow=P.createBiquadFilter(),this.filterHigh=P.createBiquadFilter(),this.wet=P.createGain(),this.output=P.createGain(),this.activateNode.connect(this.filterLow),this.activateNode.connect(this.dry),this.filterLow.connect(this.filterHigh),this.filterHigh.connect(this.convolver),this.convolver.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.dry.gain.value=I(e.dryLevel,this.defaults.dryLevel.value),this.wet.gain.value=I(e.wetLevel,this.defaults.wetLevel.value),this.filterHigh.frequency.value=e.highCut||this.defaults.highCut.value,this.filterLow.frequency.value=e.lowCut||this.defaults.lowCut.value,this.output.gain.value=I(e.level,this.defaults.level.value),this.filterHigh.type="lowpass",this.filterLow.type="highpass",this.buffer=e.impulse||"../impulses/ir_rev_short.wav",this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Convolver.prototype=Object.create(D,{name:{value:"Convolver"},defaults:{writable:!0,value:{highCut:{value:22050,min:20,max:22050,automatable:!0,type:G},lowCut:{value:20,min:20,max:22050,automatable:!0,type:G},dryLevel:{value:1,min:0,max:1,automatable:!0,type:G},wetLevel:{value:1,min:0,max:1,automatable:!0,type:G},level:{value:1,min:0,max:1,automatable:!0,type:G},bypass:{value:!1,automatable:!1,type:L}}},lowCut:{get:function(){return this.filterLow.frequency},set:function(e){this.filterLow.frequency.setTargetAtTime(e,P.currentTime,.01)}},highCut:{get:function(){return this.filterHigh.frequency},set:function(e){this.filterHigh.frequency.setTargetAtTime(e,P.currentTime,.01)}},level:{get:function(){return this.output.gain},set:function(e){this.output.gain.setTargetAtTime(e,P.currentTime,.01)}},dryLevel:{get:function(){return this.dry.gain},set:function(e){this.dry.gain.setTargetAtTime(e,P.currentTime,.01)}},wetLevel:{get:function(){return this.wet.gain},set:function(e){this.wet.gain.setTargetAtTime(e,P.currentTime,.01)}},buffer:{enumerable:!1,get:function(){return this.convolver.buffer},set:function(e){var t=this.convolver,i=new XMLHttpRequest;e?(i.open("GET",e,!0),i.responseType="arraybuffer",i.onreadystatechange=function(){4===i.readyState&&(i.status<300&&i.status>199||302===i.status)&&P.decodeAudioData(i.response,(function(e){t.buffer=e}),(function(e){e&&console.log("Tuna.Convolver.setBuffer: Error decoding data"+e)}))},i.send(null)):console.log("Tuna.Convolver.setBuffer: Missing impulse path!")}}}),R.prototype.Delay=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.dry=P.createGain(),this.wet=P.createGain(),this.filter=P.createBiquadFilter(),this.delay=P.createDelay(10),this.feedbackNode=P.createGain(),this.output=P.createGain(),this.activateNode.connect(this.delay),this.activateNode.connect(this.dry),this.delay.connect(this.filter),this.filter.connect(this.feedbackNode),this.feedbackNode.connect(this.delay),this.feedbackNode.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.delayTime=e.delayTime||this.defaults.delayTime.value,this.feedbackNode.gain.value=I(e.feedback,this.defaults.feedback.value),this.wet.gain.value=I(e.wetLevel,this.defaults.wetLevel.value),this.dry.gain.value=I(e.dryLevel,this.defaults.dryLevel.value),this.filter.frequency.value=e.cutoff||this.defaults.cutoff.value,this.filter.type="lowpass",this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Delay.prototype=Object.create(D,{name:{value:"Delay"},defaults:{writable:!0,value:{delayTime:{value:100,min:20,max:1e3,automatable:!1,type:G},feedback:{value:.45,min:0,max:.9,automatable:!0,type:G},cutoff:{value:2e4,min:20,max:2e4,automatable:!0,type:G},wetLevel:{value:.5,min:0,max:1,automatable:!0,type:G},dryLevel:{value:1,min:0,max:1,automatable:!0,type:G},bypass:{value:!1,automatable:!1,type:L}}},delayTime:{enumerable:!0,get:function(){return this.delay.delayTime},set:function(e){this.delay.delayTime.value=e/1e3}},wetLevel:{enumerable:!0,get:function(){return this.wet.gain},set:function(e){this.wet.gain.setTargetAtTime(e,P.currentTime,.01)}},dryLevel:{enumerable:!0,get:function(){return this.dry.gain},set:function(e){this.dry.gain.setTargetAtTime(e,P.currentTime,.01)}},feedback:{enumerable:!0,get:function(){return this.feedbackNode.gain},set:function(e){this.feedbackNode.gain.setTargetAtTime(e,P.currentTime,.01)}},cutoff:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.setTargetAtTime(e,P.currentTime,.01)}}}),R.prototype.Filter=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.filter=P.createBiquadFilter(),this.output=P.createGain(),this.activateNode.connect(this.filter),this.filter.connect(this.output),this.filter.frequency.value=e.frequency||this.defaults.frequency.value,this.Q=e.resonance||this.defaults.Q.value,this.filterType=I(e.filterType,this.defaults.filterType.value),this.filter.gain.value=I(e.gain,this.defaults.gain.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Filter.prototype=Object.create(D,{name:{value:"Filter"},defaults:{writable:!0,value:{frequency:{value:800,min:20,max:22050,automatable:!0,type:G},Q:{value:1,min:.001,max:100,automatable:!0,type:G},gain:{value:0,min:-40,max:40,automatable:!0,type:G},bypass:{value:!1,automatable:!1,type:L},filterType:{value:"lowpass",automatable:!1,type:"string"}}},filterType:{enumerable:!0,get:function(){return this.filter.type},set:function(e){this.filter.type=e}},Q:{enumerable:!0,get:function(){return this.filter.Q},set:function(e){this.filter.Q.value=e}},gain:{enumerable:!0,get:function(){return this.filter.gain},set:function(e){this.filter.gain.setTargetAtTime(e,P.currentTime,.01)}},frequency:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.setTargetAtTime(e,P.currentTime,.01)}}}),R.prototype.Gain=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.gainNode=P.createGain(),this.output=P.createGain(),this.activateNode.connect(this.gainNode),this.gainNode.connect(this.output),this.gainNode.gain.value=I(e.gain,this.defaults.gain.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Gain.prototype=Object.create(D,{name:{value:"Gain"},defaults:{writable:!0,value:{bypass:{value:!1,automatable:!1,type:L},gain:{value:1,automatable:!0,type:G}}},gain:{enumerable:!0,get:function(){return this.gainNode.gain},set:function(e){this.gainNode.gain.setTargetAtTime(e,P.currentTime,.01)}}}),R.prototype.MoogFilter=function(e){var t,i,n,s,a,r,o,l,h,c,u,p,d,m,f;e||(e=this.getDefaults()),this.bufferSize=e.bufferSize||this.defaults.bufferSize.value,this.input=P.createGain(),this.activateNode=P.createGain(),this.processor=P.createScriptProcessor(this.bufferSize,1,1),this.output=P.createGain(),this.activateNode.connect(this.processor),this.processor.connect(this.output),t=i=n=s=a=r=o=l=0,this.processor.onaudioprocess=function(e){for(h=e.inputBuffer.getChannelData(0),c=e.outputBuffer.getChannelData(0),u=1.16*this.cutoff,f=u*u*.35013*(u*u),p=this.resonance*(1-.15*u*u),m=h.length,d=0;d<m;d++)h[d]-=l*p,h[d]*=f,a=h[d]+.3*t+(1-u)*a,t=h[d],r=a+.3*i+(1-u)*r,i=a,o=r+.3*n+(1-u)*o,n=r,l=o+.3*s+(1-u)*l,s=o,c[d]=l},this.cutoff=I(e.cutoff,this.defaults.cutoff.value),this.resonance=I(e.resonance,this.defaults.resonance.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.MoogFilter.prototype=Object.create(D,{name:{value:"MoogFilter"},defaults:{writable:!0,value:{bufferSize:{value:4096,min:256,max:16384,automatable:!1,type:B},bypass:{value:!1,automatable:!1,type:L},cutoff:{value:.065,min:1e-4,max:1,automatable:!1,type:G},resonance:{value:3.5,min:0,max:4,automatable:!1,type:G}}},cutoff:{enumerable:!0,get:function(){return this.processor.cutoff},set:function(e){this.processor.cutoff=e}},resonance:{enumerable:!0,get:function(){return this.processor.resonance},set:function(e){this.processor.resonance=e}}}),R.prototype.Overdrive=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.inputDrive=P.createGain(),this.waveshaper=P.createWaveShaper(),this.outputDrive=P.createGain(),this.output=P.createGain(),this.activateNode.connect(this.inputDrive),this.inputDrive.connect(this.waveshaper),this.waveshaper.connect(this.outputDrive),this.outputDrive.connect(this.output),this.ws_table=new Float32Array(this.k_nSamples),this.drive=I(e.drive,this.defaults.drive.value),this.outputGain=I(e.outputGain,this.defaults.outputGain.value),this.curveAmount=I(e.curveAmount,this.defaults.curveAmount.value),this.algorithmIndex=I(e.algorithmIndex,this.defaults.algorithmIndex.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Overdrive.prototype=Object.create(D,{name:{value:"Overdrive"},defaults:{writable:!0,value:{drive:{value:.197,min:0,max:1,automatable:!0,type:G,scaled:!0},outputGain:{value:-9.154,min:-46,max:0,automatable:!0,type:G,scaled:!0},curveAmount:{value:.979,min:0,max:1,automatable:!1,type:G},algorithmIndex:{value:0,min:0,max:5,automatable:!1,type:B},bypass:{value:!1,automatable:!1,type:L}}},k_nSamples:{value:8192},drive:{get:function(){return this.inputDrive.gain},set:function(e){this.inputDrive.gain.value=e}},curveAmount:{get:function(){return this._curveAmount},set:function(e){this._curveAmount=e,void 0===this._algorithmIndex&&(this._algorithmIndex=0),this.waveshaperAlgorithms[this._algorithmIndex](this._curveAmount,this.k_nSamples,this.ws_table),this.waveshaper.curve=this.ws_table}},outputGain:{get:function(){return this.outputDrive.gain},set:function(e){this._outputGain=F(e),this.outputDrive.gain.setValueAtTime(this._outputGain,P.currentTime,.01)}},algorithmIndex:{get:function(){return this._algorithmIndex},set:function(e){this._algorithmIndex=e,this.curveAmount=this._curveAmount}},waveshaperAlgorithms:{value:[function(e,t,i){var n,s,a=2*(e=Math.min(e,.9999))/(1-e);for(n=0;n<t;n++)s=2*n/t-1,i[n]=(1+a)*s/(1+a*Math.abs(s))},function(e,t,i){var n,s,a;for(n=0;n<t;n++)s=2*n/t-1,a=(.5*Math.pow(s+1.4,2)-1)*(a>=0?5.8:1.2),i[n]=H(a)},function(e,t,i){var n,s,a,r=1-e;for(n=0;n<t;n++)a=(s=2*n/t-1)<0?-Math.pow(Math.abs(s),r+.04):Math.pow(s,r),i[n]=H(2*a)},function(e,t,i){var n,s,a,r,o=1-e>.99?.99:1-e;for(n=0;n<t;n++)s=2*n/t-1,(r=Math.abs(s))<o?a=r:r>o?a=o+(r-o)/(1+Math.pow((r-o)/(1-o),2)):r>1&&(a=r),i[n]=j(s)*a*(1/((o+1)/2))},function(e,t,i){var n,s;for(n=0;n<t;n++)s=2*n/t-1,i[n]=s<-.08905?-3/4*(1-Math.pow(1-(Math.abs(s)-.032857),12)+1/3*(Math.abs(s)-.032847))+.01:s>=-.08905&&s<.320018?s*s*-6.153+3.9375*s:.630035},function(e,t,i){var n,s,a=2+Math.round(14*e),r=Math.round(Math.pow(2,a-1));for(n=0;n<t;n++)s=2*n/t-1,i[n]=Math.round(s*r)/r}]}}),R.prototype.Panner=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.panner=P.createStereoPanner(),this.output=P.createGain(),this.activateNode.connect(this.panner),this.panner.connect(this.output),this.pan=I(e.pan,this.defaults.pan.value),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Panner.prototype=Object.create(D,{name:{value:"Panner"},defaults:{writable:!0,value:{bypass:{value:!1,automatable:!1,type:L},pan:{value:0,min:-1,max:1,automatable:!0,type:G}}},pan:{enumerable:!0,get:function(){return this.panner.pan},set:function(e){this.panner.pan.value=e}}}),R.prototype.Phaser=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.splitter=this.activateNode=P.createChannelSplitter(2),this.filtersL=[],this.filtersR=[],this.feedbackGainNodeL=P.createGain(),this.feedbackGainNodeR=P.createGain(),this.merger=P.createChannelMerger(2),this.filteredSignal=P.createGain(),this.output=P.createGain(),this.lfoL=new M.LFO({target:this.filtersL,callback:this.callback}),this.lfoR=new M.LFO({target:this.filtersR,callback:this.callback});for(var t=this.stage;t--;)this.filtersL[t]=P.createBiquadFilter(),this.filtersR[t]=P.createBiquadFilter(),this.filtersL[t].type="allpass",this.filtersR[t].type="allpass";this.input.connect(this.splitter),this.input.connect(this.output),this.splitter.connect(this.filtersL[0],0,0),this.splitter.connect(this.filtersR[0],1,0),this.connectInOrder(this.filtersL),this.connectInOrder(this.filtersR),this.filtersL[this.stage-1].connect(this.feedbackGainNodeL),this.filtersL[this.stage-1].connect(this.merger,0,0),this.filtersR[this.stage-1].connect(this.feedbackGainNodeR),this.filtersR[this.stage-1].connect(this.merger,0,1),this.feedbackGainNodeL.connect(this.filtersL[0]),this.feedbackGainNodeR.connect(this.filtersR[0]),this.merger.connect(this.output),this.rate=I(e.rate,this.defaults.rate.value),this.baseModulationFrequency=e.baseModulationFrequency||this.defaults.baseModulationFrequency.value,this.depth=I(e.depth,this.defaults.depth.value),this.feedback=I(e.feedback,this.defaults.feedback.value),this.stereoPhase=I(e.stereoPhase,this.defaults.stereoPhase.value),this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Phaser.prototype=Object.create(D,{name:{value:"Phaser"},stage:{value:4},defaults:{writable:!0,value:{rate:{value:.1,min:0,max:8,automatable:!1,type:G},depth:{value:.6,min:0,max:1,automatable:!1,type:G},feedback:{value:.7,min:0,max:1,automatable:!1,type:G},stereoPhase:{value:40,min:0,max:180,automatable:!1,type:G},baseModulationFrequency:{value:700,min:500,max:1500,automatable:!1,type:G},bypass:{value:!1,automatable:!1,type:L}}},callback:{value:function(e,t){for(var i=0;i<4;i++)e[i].frequency.value=t}},depth:{get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._baseModulationFrequency*this._depth,this.lfoR.oscillation=this._baseModulationFrequency*this._depth}},rate:{get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},baseModulationFrequency:{enumerable:!0,get:function(){return this._baseModulationFrequency},set:function(e){this._baseModulationFrequency=e,this.lfoL.offset=this._baseModulationFrequency,this.lfoR.offset=this._baseModulationFrequency,this.depth=this._depth}},feedback:{get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeL.gain.setTargetAtTime(this._feedback,P.currentTime,.01),this.feedbackGainNodeR.gain.setTargetAtTime(this._feedback,P.currentTime,.01)}},stereoPhase:{get:function(){return this._stereoPhase},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=A(t,2*Math.PI),this.lfoR._phase=t}}}),R.prototype.PingPongDelay=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.wet=P.createGain(),this.stereoToMonoMix=P.createGain(),this.feedbackLevel=P.createGain(),this.output=P.createGain(),this.delayLeft=P.createDelay(10),this.delayRight=P.createDelay(10),this.activateNode=P.createGain(),this.splitter=P.createChannelSplitter(2),this.merger=P.createChannelMerger(2),this.activateNode.connect(this.splitter),this.splitter.connect(this.stereoToMonoMix,0,0),this.splitter.connect(this.stereoToMonoMix,1,0),this.stereoToMonoMix.gain.value=.5,this.stereoToMonoMix.connect(this.wet),this.wet.connect(this.delayLeft),this.feedbackLevel.connect(this.wet),this.delayLeft.connect(this.delayRight),this.delayRight.connect(this.feedbackLevel),this.delayLeft.connect(this.merger,0,0),this.delayRight.connect(this.merger,0,1),this.merger.connect(this.output),this.activateNode.connect(this.output),this.delayTimeLeft=void 0!==e.delayTimeLeft?e.delayTimeLeft:this.defaults.delayTimeLeft.value,this.delayTimeRight=void 0!==e.delayTimeRight?e.delayTimeRight:this.defaults.delayTimeRight.value,this.feedbackLevel.gain.value=void 0!==e.feedback?e.feedback:this.defaults.feedback.value,this.wet.gain.value=void 0!==e.wetLevel?e.wetLevel:this.defaults.wetLevel.value,this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.PingPongDelay.prototype=Object.create(D,{name:{value:"PingPongDelay"},delayTimeLeft:{enumerable:!0,get:function(){return this._delayTimeLeft},set:function(e){this._delayTimeLeft=e,this.delayLeft.delayTime.value=e/1e3}},delayTimeRight:{enumerable:!0,get:function(){return this._delayTimeRight},set:function(e){this._delayTimeRight=e,this.delayRight.delayTime.value=e/1e3}},wetLevel:{enumerable:!0,get:function(){return this.wet.gain},set:function(e){this.wet.gain.setTargetAtTime(e,P.currentTime,.01)}},feedback:{enumerable:!0,get:function(){return this.feedbackLevel.gain},set:function(e){this.feedbackLevel.gain.setTargetAtTime(e,P.currentTime,.01)}},defaults:{writable:!0,value:{delayTimeLeft:{value:200,min:1,max:1e4,automatable:!1,type:B},delayTimeRight:{value:400,min:1,max:1e4,automatable:!1,type:B},feedback:{value:.3,min:0,max:1,automatable:!0,type:G},wetLevel:{value:.5,min:0,max:1,automatable:!0,type:G},bypass:{value:!1,automatable:!1,type:L}}}}),R.prototype.Tremolo=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.splitter=this.activateNode=P.createChannelSplitter(2),this.amplitudeL=P.createGain(),this.amplitudeR=P.createGain(),this.merger=P.createChannelMerger(2),this.output=P.createGain(),this.lfoL=new M.LFO({target:this.amplitudeL.gain,callback:O}),this.lfoR=new M.LFO({target:this.amplitudeR.gain,callback:O}),this.input.connect(this.splitter),this.splitter.connect(this.amplitudeL,0),this.splitter.connect(this.amplitudeR,1),this.amplitudeL.connect(this.merger,0,0),this.amplitudeR.connect(this.merger,0,1),this.merger.connect(this.output),this.rate=e.rate||this.defaults.rate.value,this.intensity=I(e.intensity,this.defaults.intensity.value),this.stereoPhase=I(e.stereoPhase,this.defaults.stereoPhase.value),this.lfoL.offset=1-this.intensity/2,this.lfoR.offset=1-this.intensity/2,this.lfoL.phase=this.stereoPhase*Math.PI/180,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.Tremolo.prototype=Object.create(D,{name:{value:"Tremolo"},defaults:{writable:!0,value:{intensity:{value:.3,min:0,max:1,automatable:!1,type:G},stereoPhase:{value:0,min:0,max:180,automatable:!1,type:G},rate:{value:5,min:.1,max:11,automatable:!1,type:G},bypass:{value:!1,automatable:!1,type:L}}},intensity:{enumerable:!0,get:function(){return this._intensity},set:function(e){this._intensity=e,this.lfoL.offset=1-this._intensity/2,this.lfoR.offset=1-this._intensity/2,this.lfoL.oscillation=this._intensity,this.lfoR.oscillation=this._intensity}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},stereoPhase:{enumerable:!0,get:function(){return this._stereoPhase},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=A(t,2*Math.PI),this.lfoR.phase=t}}}),R.prototype.WahWah=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.activateNode=P.createGain(),this.envelopeFollower=new M.EnvelopeFollower({target:this,callback:function(e,t){e.sweep=t}}),this.filterBp=P.createBiquadFilter(),this.filterPeaking=P.createBiquadFilter(),this.output=P.createGain(),this.activateNode.connect(this.filterBp),this.filterBp.connect(this.filterPeaking),this.filterPeaking.connect(this.output),this.init(),this.automode=I(e.automode,this.defaults.automode.value),this.resonance=e.resonance||this.defaults.resonance.value,this.sensitivity=I(e.sensitivity,this.defaults.sensitivity.value),this.baseFrequency=I(e.baseFrequency,this.defaults.baseFrequency.value),this.excursionOctaves=e.excursionOctaves||this.defaults.excursionOctaves.value,this.sweep=I(e.sweep,this.defaults.sweep.value),this.activateNode.gain.value=2,this.envelopeFollower.activate(!0),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.WahWah.prototype=Object.create(D,{name:{value:"WahWah"},defaults:{writable:!0,value:{automode:{value:!0,automatable:!1,type:L},baseFrequency:{value:.153,min:0,max:1,automatable:!1,type:G},excursionOctaves:{value:3.3,min:1,max:6,automatable:!1,type:G},sweep:{value:.35,min:0,max:1,automatable:!1,type:G},resonance:{value:19,min:1,max:100,automatable:!1,type:G},sensitivity:{value:-.5,min:-1,max:1,automatable:!1,type:G},bypass:{value:!1,automatable:!1,type:L}}},automode:{get:function(){return this._automode},set:function(e){this._automode=e,e?(this.activateNode.connect(this.envelopeFollower.input),this.envelopeFollower.activate(!0)):(this.envelopeFollower.activate(!1),this.activateNode.disconnect(),this.activateNode.connect(this.filterBp))}},filterFreqTimeout:{writable:!0,value:0},setFilterFreq:{value:function(){try{this.filterBp.frequency.value=Math.min(22050,this._baseFrequency+this._excursionFrequency*this._sweep),this.filterPeaking.frequency.value=Math.min(22050,this._baseFrequency+this._excursionFrequency*this._sweep)}catch(e){clearTimeout(this.filterFreqTimeout),this.filterFreqTimeout=setTimeout(function(){this.setFilterFreq()}.bind(this),0)}}},sweep:{enumerable:!0,get:function(){return this._sweep},set:function(e){this._sweep=Math.pow(e>1?1:e<0?0:e,this._sensitivity),this.setFilterFreq()}},baseFrequency:{enumerable:!0,get:function(){return this._baseFrequency},set:function(e){this._baseFrequency=50*Math.pow(10,2*e),this._excursionFrequency=Math.min(P.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.setFilterFreq()}},excursionOctaves:{enumerable:!0,get:function(){return this._excursionOctaves},set:function(e){this._excursionOctaves=e,this._excursionFrequency=Math.min(P.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.setFilterFreq()}},sensitivity:{enumerable:!0,get:function(){return this._sensitivity},set:function(e){this._sensitivity=Math.pow(10,e)}},resonance:{enumerable:!0,get:function(){return this._resonance},set:function(e){this._resonance=e,this.filterPeaking.Q.value=this._resonance}},init:{value:function(){this.output.gain.value=1,this.filterPeaking.type="peaking",this.filterBp.type="bandpass",this.filterPeaking.frequency.value=100,this.filterPeaking.gain.value=20,this.filterPeaking.Q.value=5,this.filterBp.frequency.value=100,this.filterBp.Q.value=1}}}),R.prototype.EnvelopeFollower=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.jsNode=this.output=P.createScriptProcessor(this.buffersize,1,1),this.input.connect(this.output),this.attackTime=I(e.attackTime,this.defaults.attackTime.value),this.releaseTime=I(e.releaseTime,this.defaults.releaseTime.value),this._envelope=0,this.target=e.target||{},this.callback=e.callback||function(){},this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.EnvelopeFollower.prototype=Object.create(D,{name:{value:"EnvelopeFollower"},defaults:{value:{attackTime:{value:.003,min:0,max:.5,automatable:!1,type:G},releaseTime:{value:.5,min:0,max:.5,automatable:!1,type:G},bypass:{value:!1,automatable:!1,type:L}}},buffersize:{value:256},envelope:{value:0},sampleRate:{value:44100},attackTime:{enumerable:!0,get:function(){return this._attackTime},set:function(e){this._attackTime=e,this._attackC=Math.exp(-1/this._attackTime*this.sampleRate/this.buffersize)}},releaseTime:{enumerable:!0,get:function(){return this._releaseTime},set:function(e){this._releaseTime=e,this._releaseC=Math.exp(-1/this._releaseTime*this.sampleRate/this.buffersize)}},callback:{get:function(){return this._callback},set:function(e){"function"==typeof e?this._callback=e:console.error("tuna.js: "+this.name+": Callback must be a function!")}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){this.activated=e,e?(this.jsNode.connect(P.destination),this.jsNode.onaudioprocess=this.returnCompute(this)):(this.jsNode.disconnect(),this.jsNode.onaudioprocess=null),this.activateCallback&&this.activateCallback(e)}},returnCompute:{value:function(e){return function(t){e.compute(t)}}},compute:{value:function(e){var t,i,n,s,a=e.inputBuffer.getChannelData(0).length,r=e.inputBuffer.numberOfChannels;for(i=n=s=0,i=0;i<r;++i)for(s=0;s<a;++s)n+=(t=e.inputBuffer.getChannelData(i)[s])*t;n=Math.sqrt(n/r),this._envelope<n?(this._envelope*=this._attackC,this._envelope+=(1-this._attackC)*n):(this._envelope*=this._releaseC,this._envelope+=(1-this._releaseC)*n),this._callback(this._target,this._envelope)}}}),R.prototype.LFO=function(e){e||(e=this.getDefaults()),this.input=P.createGain(),this.output=P.createScriptProcessor(256,1,1),this.activateNode=P.destination,this.frequency=I(e.frequency,this.defaults.frequency.value),this.offset=I(e.offset,this.defaults.offset.value),this.oscillation=I(e.oscillation,this.defaults.oscillation.value),this.phase=I(e.phase,this.defaults.phase.value),this.target=e.target||{},this.output.onaudioprocess=this.callback(e.callback||function(){}),this.bypass=e.bypass||this.defaults.bypass.value},R.prototype.LFO.prototype=Object.create(D,{name:{value:"LFO"},bufferSize:{value:256},sampleRate:{value:44100},defaults:{value:{frequency:{value:1,min:0,max:20,automatable:!1,type:G},offset:{value:.85,min:0,max:22049,automatable:!1,type:G},oscillation:{value:.3,min:-22050,max:22050,automatable:!1,type:G},phase:{value:0,min:0,max:2*Math.PI,automatable:!1,type:G},bypass:{value:!1,automatable:!1,type:L}}},frequency:{get:function(){return this._frequency},set:function(e){this._frequency=e,this._phaseInc=2*Math.PI*this._frequency*this.bufferSize/this.sampleRate}},offset:{get:function(){return this._offset},set:function(e){this._offset=e}},oscillation:{get:function(){return this._oscillation},set:function(e){this._oscillation=e}},phase:{get:function(){return this._phase},set:function(e){this._phase=e}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){e?(this.output.connect(P.destination),this.activateCallback&&this.activateCallback(e)):this.output.disconnect()}},callback:{value:function(e){var t=this;return function(){t._phase+=t._phaseInc,t._phase>2*Math.PI&&(t._phase=0),e(t._target,t._offset+t._oscillation*Math.sin(t._phase))}}}}),R.toString=R.prototype.toString=function(){return"Please visit https://github.com/Theodeus/tuna/wiki for instructions on how to use Tuna.js"};class V{constructor(e,t=V.createDefaults()){if(this._chainNodes=[],this.id=m(),this._context=e,this._settings=t,this._tuna=R(e),this._preGain=this._context.createGain(),this._preGain.gain.value=this._settings.preGain,this._postGain=this._context.createGain(),this._postGain.gain.value=this._settings.postGain,this._settings.effects.length>0){let e=this.IEffectToEffectObject(this._settings.effects[0]);this._chainNodes.push(e),this._preGain.connect(e);for(let t=1;t<this._settings.effects.length;t++)e=this.IEffectToEffectObject(this._settings.effects[t]),this._chainNodes[t-1].connect(e),this._chainNodes.push(e);this._chainNodes[this._chainNodes.length-1].connect(this._postGain)}else this._preGain.connect(this._postGain)}get input(){return this._preGain}get effectCount(){return this._chainNodes.length}get effects(){return this._settings.effects}get effectNodes(){return this._chainNodes}get chainName(){return this._settings.chainName}set chainName(e){this._settings.chainName=e}get preGain(){return this._preGain.gain.value}set preGain(e){this._preGain.gain.value=e}get postGain(){return this._postGain.gain.value}set postGain(e){this._preGain.gain.value=e}destroy(){this._preGain.disconnect();for(let e=0;e<this._chainNodes.length;e++)this._chainNodes[e].disconnect();this._postGain.disconnect()}connect(e){e instanceof AudioNode?this._postGain.connect(e):this._postGain.connect(e.input)}disconnect(e){e instanceof AudioNode?this._postGain.disconnect(e):this._postGain.disconnect(e.input)}disconnectAll(){this._postGain.disconnect()}addEffect(e,t){if(e<0||e>this._chainNodes.length)throw new RangeError("Index out of range:"+e.toString());let i=this.IEffectToEffectObject(t);this._connectEffect(e,i),this._settings.effects.splice(e,0,t)}removeEffect(e){if(!(e>=0&&e<this._chainNodes.length))throw new RangeError("Index out of range");this._disconnectEffect(e),this._settings.effects.splice(e,1)}moveEffect(e,t){if((e=Math.max(Math.min(this.effectCount,e),0))!=(t=Math.max(Math.min(this.effectCount,t),0))){let i=this._disconnectEffect(e);this._connectEffect(t,i);let n=this._settings.effects[e];this._settings.effects.splice(e,1),this._settings.effects.splice(t,0,n)}}getDelayTime(){let e=0;return this._settings.effects.forEach((t=>{let i=0;if("Delay"==t.effectType){let e=t.properties.find((e=>"feedback"==e.propertyName)).value,n=t.properties.find((e=>"delayTime"==e.propertyName)).value/1e3;i=Math.log(.005)/Math.log(e)*n}else if("PingPongDelay"==t.effectType){let e=t.properties.find((e=>"feedback"==e.propertyName)).value,n=t.properties.find((e=>"delayTimeLeft"==e.propertyName)).value/1e3,s=t.properties.find((e=>"delayTimeRight"==e.propertyName)).value/1e3;i=Math.log(.005)/Math.log(e)*Math.max(n+s)}else"Convolver"==t.effectType&&(i=3);e+=i})),e}serialise(){return this._settings}static createDefaults(){return{chainName:"",effects:[],preGain:1,postGain:1,connections:["Context"]}}IEffectToEffectObject(e){let t=this._convertPropertyToObject(e.properties);switch(e.effectType){case"Chorus":return new this._tuna.Chorus(t);case"Delay":return new this._tuna.Delay(t);case"Overdrive":return new this._tuna.Overdrive(t);case"Compressor":return new this._tuna.Compressor(t);case"Convolver":return new this._tuna.Convolver(t);case"Filter":return new this._tuna.Filter(t);case"Cabinet":return new this._tuna.Cabinet(t);case"Tremolo":return new this._tuna.Tremolo(t);case"WahWah":return new this._tuna.WahWah(t);case"Phaser":return new this._tuna.Phaser(t);case"Bitcrusher":return new this._tuna.Bitcrusher(t);case"Moog":return new this._tuna.MoogFilter(t);case"PingPongDelay":return new this._tuna.PingPongDelay(t);case"Panner":return new this._tuna.Panner(t);case"Gain":return new this._tuna.Gain(t);default:throw new Error("Invalid effect name.")}}_convertPropertyToObject(e){let t={};return e.forEach((e=>{t[e.propertyName]=e.value})),t}_connectEffect(e,t){if(e<0||e>this._chainNodes.length)throw new Error("Invalid index to disconnect effect.");e>0?(this._chainNodes[e-1].disconnect(),this._chainNodes[e-1].connect(t)):(this._preGain.disconnect(),this._preGain.connect(t)),e===this._chainNodes.length?(t.connect(this._postGain),this._chainNodes.push(t)):(t.connect(this._chainNodes[e]),this._chainNodes.splice(e,0,t))}_disconnectEffect(e){if(e<0||e>=this._chainNodes.length||0===this._chainNodes.length)throw new Error("Invalid index to disconnect effect.");this._chainNodes[e].disconnect();let t=null;return t=e>0?this._chainNodes[e-1]:this._preGain,t.disconnect(),e===this._chainNodes.length-1?t.connect(this._postGain):t.connect(this._chainNodes[e+1]),this._chainNodes.splice(e,1)[0]}static Chorus(){return{id:m(),effectType:"Chorus",properties:[{type:"number",propertyName:"rate",value:1.5,editable:!0,step:.01,min:.01,max:8},{type:"number",propertyName:"feedback",value:.4,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"depth",value:.7,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"delay",value:.0045,editable:!0,step:.01,min:0,max:1},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Delay(){return{id:m(),effectType:"Delay",properties:[{type:"number",propertyName:"feedback",value:.45,editable:!0,step:.01,min:0,max:.999},{type:"number",displayName:"Delay Time",propertyName:"delayTime",value:100,editable:!0,step:1,min:1,max:1e4},{type:"number",displayName:"Wet Level",propertyName:"wetLevel",value:.5,editable:!0,step:.01,min:0,max:1},{type:"number",displayName:"Dry Level",propertyName:"dryLevel",value:1,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"cutoff",value:2e4,editable:!0,step:1,min:20,max:22050},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Phaser(){return{id:m(),effectType:"Phaser",properties:[{type:"number",propertyName:"rate",value:.1,editable:!0,step:.01,min:0,max:8},{type:"number",propertyName:"depth",value:.6,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"feedback",value:.7,editable:!0,step:.01,min:0,max:.999},{type:"number",displayName:"Stereo Phase",propertyName:"stereoPhase",value:40,editable:!0,step:1,min:0,max:180},{type:"number",displayName:"Base Modulation Frequency",propertyName:"baseModulationFrequency",value:700,editable:!0,step:1,min:500,max:1500},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Overdrive(){return{id:m(),effectType:"Overdrive",properties:[{type:"number",displayName:"Output Gain",propertyName:"outputGain",value:0,editable:!0,step:1,min:-42,max:0},{type:"number",propertyName:"drive",value:1,editable:!0,step:.01,min:0,max:1},{type:"number",displayName:"Curve Amount",propertyName:"curveAmount",value:.725,editable:!0,step:.01,min:0,max:.99},{type:"number",displayName:"Algorithm Index",propertyName:"algorithmIndex",value:0,editable:!0,step:1,min:0,max:5},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Compressor(){return{id:m(),effectType:"Compressor",properties:[{type:"number",propertyName:"threshold",value:-20,editable:!0,step:1,min:-100,max:0},{type:"number",displayName:"Makeup Gain",propertyName:"makeupGain",value:1,editable:!0,step:1,min:0,max:200},{type:"number",propertyName:"attack",value:1,editable:!0,step:1,min:0,max:1e3},{type:"number",propertyName:"release",value:250,editable:!0,step:1,min:0,max:3e3},{type:"number",propertyName:"ratio",value:4,editable:!0,step:1,min:1,max:20},{type:"number",propertyName:"knee",value:5,editable:!0,step:1,min:0,max:40},{type:"boolean",displayName:"Auto Makeup",propertyName:"automakeup",value:!1,editable:!0},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Convolver(){return{id:m(),effectType:"Convolver",properties:[{type:"number",displayName:"High Cut",propertyName:"highCut",value:22050,editable:!0,step:1,min:20,max:22050},{type:"number",displayName:"Low Cut",propertyName:"lowCut",value:20,editable:!0,step:1,min:20,max:22050},{type:"number",displayName:"Wet Level",propertyName:"wetLevel",value:1,editable:!0,step:.01,min:0,max:1},{type:"number",displayName:"Dry Level",propertyName:"dryLevel",value:1,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"level",value:.7,editable:!0,step:.01,min:0,max:1},{type:"string",propertyName:"impulse",value:"/dependencies/impulses/impulse_rev.wav",editable:!1},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Filter(){return{id:m(),effectType:"Filter",properties:[{type:"number",propertyName:"frequency",value:22050,editable:!0,step:1,min:20,max:22050},{type:"number",propertyName:"Q",value:1,editable:!0,step:.001,min:.001,max:100},{type:"number",propertyName:"gain",value:0,editable:!0,step:1,min:-40,max:40},{type:"list",displayName:"Filter Type",propertyName:"filterType",value:"lowpass",editable:!0,options:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Cabinet(){return{id:m(),effectType:"Cabinet",properties:[{type:"number",displayName:"Makeup Gain",propertyName:"makeupGain",value:1,editable:!0,step:.1,min:0,max:20},{type:"string",displayName:"Impulse Path",propertyName:"impulsePath",value:"/dependencies/impulses/impulse_guitar.wav",editable:!1},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Tremolo(){return{id:m(),effectType:"Tremolo",properties:[{type:"number",propertyName:"intensity",value:1,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"rate",value:5,editable:!0,step:.001,min:.001,max:8},{type:"number",propertyName:"stereoPhase",value:0,editable:!0,step:1,min:0,max:180},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static WahWah(){return{id:m(),effectType:"WahWah",properties:[{type:"boolean",displayName:"Auto",propertyName:"automode",value:!0,editable:!0},{type:"number",displayName:"Base Frequency",propertyName:"baseFrequency",value:.5,editable:!0,step:.01,min:0,max:1},{type:"number",displayName:"Excursion Octaves",propertyName:"excursionOctaves",value:2,editable:!0,step:1,min:1,max:6},{type:"number",propertyName:"sweep",value:.2,editable:!0,step:.01,min:0,max:1},{type:"number",propertyName:"resonance",value:10,editable:!0,step:1,min:1,max:100},{type:"number",propertyName:"sensitivity",value:.5,editable:!0,step:.01,min:-1,max:1},{type:"boolean",propertyName:"bypass",value:!1,editable:!0}]}}static Bitcrusher(){return{id:m(),effectType:"Bitcrusher",properties:[{type:"number",propertyName:"bits",value:4,editable:!0,step:1,min:1,max:16},{type:"number",displayName:"Normal Frequency",propertyName:"normFreq",value:.1,editable:!0,step:.01,min:0,max:1},{type:"number",displayName:"Buffer Size",propertyName:"bufferSize",value:4096,editable:!0,step:1,min:256,max:16384}]}}static Moog(){return{id:m(),effectType:"Moog",properties:[{type:"number",propertyName:"cutoff",value:.065,editable:!0,step:.001,min:0,max:1},{type:"number",propertyName:"resonance",value:3.5,editable:!0,step:.01,min:0,max:4},{type:"number",displayName:"Buffer Size",propertyName:"bufferSize",value:4096,editable:!0,step:1,min:256,max:16384}]}}static PingPongDelay(){return{id:m(),effectType:"PingPongDelay",properties:[{type:"number",propertyName:"wetLevel",value:1.5,editable:!0,step:.01,min:.01,max:8},{type:"number",propertyName:"feedback",value:.4,editable:!0,step:.01,min:0,max:1},{type:"number",displayName:"Delay Time (Left)",propertyName:"delayTimeLeft",value:200,editable:!0,step:1,min:1,max:1e4},{type:"number",displayName:"Delay Time (Right)",propertyName:"delayTimeRight",value:400,editable:!0,step:1,min:1,max:1e4}]}}static Panner(){return{id:m(),effectType:"Panner",properties:[{type:"number",propertyName:"pan",value:0,editable:!0,step:.01,min:-1,max:1}]}}static Gain(){return{id:m(),effectType:"Gain",properties:[{type:"number",propertyName:"gain",value:1,editable:!0,step:.01,min:0,max:2}]}}}V.possibleEffects=new Map([["Chorus",V.Chorus],["Delay",V.Delay],["Ping Pong Delay",V.PingPongDelay],["Overdrive",V.Overdrive],["Gain",V.Gain],["Compressor",V.Compressor],["Pan",V.Panner],["Convolver Reverb",V.Convolver],["Tremolo",V.Tremolo],["Filter",V.Filter],["Bitcrusher",V.Bitcrusher],["Phaser",V.Phaser],["Wah",V.WahWah],["Moog Filter",V.Moog],["Cabinet Emulator",V.Cabinet]]);class q{constructor(e){this.effectsDeserialised=new f,this._context=e,this._outputGain=this._context.createGain(),this._outputGain.connect(e.destination),this._bus=new V(e),this._bus.chainName="Bus",this._possibleConnections={Context:this._outputGain,Bus:this._bus},this._possibleConnectionStrings=["Context","Bus"],this._currentConnections={},this._chains=[],this.createConnections(this._bus,["Context"])}get possibleConnections(){return this._possibleConnections}get possibleConnectionStrings(){return this._possibleConnectionStrings}get outputGain(){return this._outputGain}get bus(){return this._bus}get chains(){return this._chains}getConnections(e){if(e.id in this._currentConnections)return this._currentConnections[e.id];throw new Error("Object not found")}createConnections(e,t){e.id in this._currentConnections&&e.disconnectAll();for(let i=0;i<t.length;i++){if(!(t[i]in this._possibleConnections))throw new Error("Invalid connection name: "+t[i]);e.connect(this._possibleConnections[t[i]])}this._currentConnections[e.id]=t}addConnection(e,t){if(!(t in this._possibleConnections))throw new Error("Invalid connection name: "+t);if(e.id in this._currentConnections){if(-1!=this._currentConnections[e.id].indexOf(t))return;this._currentConnections[e.id].push(t)}else this._currentConnections[e.id]=[t];e.connect(this._possibleConnections[t])}removeConnection(e,t){if(!(e.id in this._currentConnections))throw new Error("Object does not have any connections.");{let i=this._currentConnections[e.id].indexOf(t);if(-1==i)throw new Error("Object does not have this connection");e.disconnect(this._possibleConnections[t]),this._currentConnections[e.id].splice(i,1)}}removeAllConnections(e){e.disconnectAll(),delete this._currentConnections[e.id]}addChain(e){let t=new V(this._context,e);if(void 0===e){let e=0;for(;"Chain "+e in this._possibleConnections;)e++;let i="Chain "+e.toString();t.chainName=i,this.createConnections(t,V.createDefaults().connections)}else this.createConnections(t,e.connections);return this._possibleConnectionStrings.push(t.chainName),this._possibleConnections[t.chainName]=t,this._chains.push(t),t}removeChain(e){if(!e.startsWith("Chain ")||!(e in this._possibleConnections))throw new Error("Object not in ConnectionManager");{let t=this._chains.indexOf(this._possibleConnections[e]);this._chains.splice(t,1),delete this._possibleConnections[e],this._possibleConnectionStrings.splice(this._possibleConnectionStrings.indexOf(e),1)}}getChain(e){if("Bus"==e)return this._bus;{let e=this._chains.find((e=>{e.chainName}));if(void 0!==e)return e;throw new Error("Invalid chain name")}}getChainDelayTime(e){let t=this.getChain(e),i=t.getDelayTime();return"bus"in this._currentConnections[t.id]&&(i+=this._bus.getDelayTime()),i}serialiseChains(){let e=[];return this.chains.concat(this.bus).forEach((t=>{let i=t.serialise();t.id in this._currentConnections?i.connections=this._currentConnections[t.id]:i.connections=["Context"],e.push(i)})),e}deserialiseChains(e){this._possibleConnectionStrings=["Context"],this._possibleConnections={Context:this._outputGain};for(let e=0;e<this._chains.length;e++)delete this._possibleConnections[this._chains[e].chainName],this._possibleConnectionStrings.splice(this._possibleConnectionStrings.indexOf(this._chains[e].chainName),1),this._chains[e].destroy();this._chains=[],e.forEach((e=>{"Bus"===e.chainName?(this._bus=new V(this._context,e),this._possibleConnectionStrings.push("Bus"),this._possibleConnections[e.chainName]=this._bus,this.createConnections(this._bus,e.connections)):this.addChain(e)})),this.effectsDeserialised.emit()}}var W=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((n=n.apply(e,t||[])).next())}))};class U{constructor(e){this.lookaheadTime=.125,this._playing=!1,this._startTime=0,this._quarterNotePosition=0,this.playingIntervalIDs=null,this.metadata=new y,this.context=void 0===e?new AudioContext:e,this.connectionManager=new q(this.context),this.scheduleEvent=new f,this.playingChangedEvent=new f,this.quarterNotePositionChangedEvent=new f,this._tracks=[],this._boundQuarterNoteUpdateFunction=this.quarterNoteUpdateFunction.bind(this)}get playing(){return this._playing}get quarterNotePosition(){return this._quarterNotePosition}set quarterNotePosition(e){this._internalQuarterNotePosition=e,this._startTime=this.context.currentTime-this.metadata.positionQuarterNoteToSeconds(this._quarterNotePosition),this._scheduleStop(),this._playing&&this._tracks.forEach((e=>{e.start(this._quarterNotePosition)}))}set _internalQuarterNotePosition(e){this._quarterNotePosition=e,this.quarterNotePositionChangedEvent.emit(e)}get tracks(){return this._tracks}addOscillatorTrack(e){let t=new w(this.metadata,this.context,this.scheduleEvent,this.connectionManager,e);return this._tracks.push(t),t}addSoundFileTrack(e){return W(this,void 0,void 0,(function*(){let t=yield x.create(this.metadata,this.context,this.scheduleEvent,this.connectionManager,e);return this._tracks.push(t),t}))}removeTrack(e){let t=this._tracks.indexOf(e);-1!=t&&this._tracks.splice(t,1),e.destroy()}start(e=this.quarterNotePosition){return W(this,void 0,void 0,(function*(){"suspended"===this.context.state&&(yield this.context.resume()),this._playing=!0,this.playingChangedEvent.emit(this._playing),this.quarterNotePosition=e,this._startTime=0==e?this.context.currentTime:this.context.currentTime-this.metadata.positionQuarterNoteToSeconds(e),this.connectionManager.outputGain.gain.setTargetAtTime(.9999,this.context.currentTime,.03),this.playingIntervalIDs=setInterval((()=>{this.scheduleNotes()}),50),requestAnimationFrame(this._boundQuarterNoteUpdateFunction),this._tracks.forEach((e=>{e.start(this._quarterNotePosition)})),this._scheduleStop()}))}stop(){this._playing=!1,this.playingChangedEvent.emit(this._playing),this.connectionManager.outputGain.gain.setTargetAtTime(1e-4,this.context.currentTime,.03),this._startSongLength=null,clearInterval(this.playingIntervalIDs),this._tracks.forEach((e=>{e.stop()}))}stopToBeginning(){this.stop(),this.quarterNotePosition=0}serialise(){let e=[];this._tracks.forEach((t=>{let i=t.serialise();e.push(i)}));let t=this.connectionManager.serialiseChains();return{fileType:"SequencerSongSettings",version:U.saveFileVersion,metadataEvents:this.metadata.serialise(),tracks:e,chains:t}}deserialise(e){return W(this,void 0,void 0,(function*(){e.version!=U.saveFileVersion&&console.log("WARNING: Save file is an old version, loading may not function correctly."),this._tracks.forEach((e=>{e.destroy()})),this._tracks=[],this.connectionManager.deserialiseChains(e.chains),this.metadata.deserialise(e.metadataEvents);for(let t=0;t<e.tracks.length;t++){let i=e.tracks[t];switch(i.source.type){case"oscillator":this.addOscillatorTrack(i);break;case"soundFile":yield this.addSoundFileTrack(i);break;default:throw new Error("Invalid track type.")}}}))}destroy(){this.scheduleEvent.removeAllListeners(),this.playingChangedEvent.removeAllListeners()}saveToWAV(){return W(this,void 0,void 0,(function*(){let e=this.getPlaybackLength();if(e>0){let i=this.serialise(),n=new z(e+.1);yield n.deserialise(i);let s=yield n.saveToWAV();return t=this.context,P=t,s}throw new Error("Song Length must be greater than 0 to save to WAV.");var t}))}getPlaybackLength(){let e=0,t={};return this._tracks.forEach((i=>{let n=this.metadata.positionQuarterNoteToSeconds(i.timeline.playbackTime),s=this.connectionManager.getConnections(i.audioSource)[0];if("Context"!=s)if(s in t)n+=t[s];else{let e=this.connectionManager.getChainDelayTime(s);n+=e,t[s]=e}n>e&&(e=n)})),e>0?e+.01:0}scheduleNotes(){let e=this.quarterNotePosition+this.lookaheadTime/this.metadata.getSecondsPerBeat(this.quarterNotePosition)/this.metadata.getQuarterNoteMultiplier(this.quarterNotePosition);this.scheduleEvent.emit(e)}quarterNoteUpdateFunction(){if(this.playing){let e=this.context.currentTime-this._startTime;this._internalQuarterNotePosition=this.metadata.positionSecondsToQuarterNote(e),this._startSongLength&&e>this._startSongLength&&this.stopToBeginning(),requestAnimationFrame(this._boundQuarterNoteUpdateFunction)}}_scheduleStop(){let e=this.getPlaybackLength();this._startSongLength=e>0?e:null}}U.saveFileVersion="1.0.0";class z extends U{constructor(e){super(new OfflineAudioContext(2,44100*e,44100))}saveToWAV(){return W(this,void 0,void 0,(function*(){this._tracks.forEach((e=>{e.scheduleAllEvents()})),console.log("Starting AudioBuffer render");let e=yield this.context.startRendering();console.log("Finished AudioBuffer render");const[t,i]=[e.getChannelData(0),e.getChannelData(1)],n=new Float32Array(2*t.length);for(let e=0,s=0;e<t.length;e++,s+=2)n[s]=t[e],n[s+1]=i[e];const s=function(e,t){const i=t.isFloat?Float32Array:Uint16Array,n=e.byteLength/i.BYTES_PER_ELEMENT,s=function(e){const t=e.numFrames,i=e.numChannels||2,n=e.sampleRate||44100,s=e.isFloat?4:2,a=e.isFloat?3:1,r=i*s,o=n*r,l=t*r,h=new ArrayBuffer(44),c=new DataView(h);let u=0;function p(e){for(let t=0;t<e.length;t++)c.setUint8(u+t,e.charCodeAt(t));u+=e.length}function d(e){c.setUint32(u,e,!0),u+=4}function m(e){c.setUint16(u,e,!0),u+=2}return p("RIFF"),d(l+36),p("WAVE"),p("fmt "),d(16),m(a),m(i),d(n),d(o),m(r),m(8*s),p("data"),d(l),new Uint8Array(h)}(Object.assign({},t,{numFrames:n})),a=new Uint8Array(s.length+e.byteLength);return a.set(s,0),a.set(new Uint8Array(e),s.length),a}(n.buffer,{isFloat:!0,numChannels:2,sampleRate:44100});return new Blob([s],{type:"audio/wav"})}))}}const Q=new class{constructor(){this._viewStack=[]}get viewDepth(){return this._viewStack.length}get currentElement(){return this._viewStack[this._viewStack.length-1]}setStageRenderer(e,t){this.controlledStage=e,this.renderer=t,this.controlledStage.removeChildren(0,this.controlledStage.children.length)}setDefaultElement(e){0==this._viewStack.length?(this.controlledStage.addChild(e),this._viewStack.push(e)):this._viewStack.splice(0,1,e)}show(e){this._viewStack.length>0&&this.controlledStage.removeChild(this.currentElement),this._viewStack.push(e),this.controlledStage.addChild(this.currentElement)}back(){if(this._viewStack.length<=1)throw new Error("Cannot bring view stack below 1 element.");this.controlledStage.removeChild(this.currentElement),this._viewStack.pop().destroy(),this.controlledStage.addChild(this.currentElement),this.currentElement.resize(this.renderer.width,this.renderer.height)}passWheelEvent(e,t,i){null!=this.currentElement&&this.currentElement.mouseWheelHandler(e,t,i)}};class X{}X.bgColor=3158064,X.fgColor=6250335,X.timelineMarkerColor=15658734,X.metadataEventColor=30207,X.trackEventColor=3250585,X.trackEventSelectedColor=17733,X.trackEventHoveredColor=619122,X.trackEventDeleteColor=16711680,X.trackEventHighlightColor=5552055;class Y{}Y.trackFont={fontFamily:"Arial",fontSize:15,fill:16777215};class K{}K.timelineHeaderHeight=40,K.sequencerSidebarWidth=100,K.timelineSidebarWidth=200;class ${constructor(e,t,i,n){this.name=e,this.startY=t,this.height=i,this.track=n}destroy(){this.track.destroy()}serialise(){return{type:"base",name:this.name,startY:this.startY,height:this.height,modelTrackID:this.track.id}}}class Z extends ${constructor(e,t){super(e.name,e.startY,e.height,t),null!=e.noteGroups?this._noteGroups=e.noteGroups:this._noteGroups=[],this.noteGroupsChanged=new f}get noteGroups(){return this._noteGroups}serialise(){let e=super.serialise();return Object.assign(Object.assign({},e),{type:"oscillator",noteGroups:this._noteGroups})}getNoteGroupsStartingBetweenTime(e,t){let i=[];for(let n=0;n<this._noteGroups.length;n++){let s=this._noteGroups[n];if(s[0]>=e&&s[0]<=t)i.push(s);else if(s[0]>t)break}return i}getNoteGroupsWithinTime(e,t){let i=[];for(let n=0;n<this._noteGroups.length;n++){let s=this._noteGroups[n];if(s[1]>e&&s[0]<t)i.push(s);else if(s[0]>t)break}return i}getNoteGroupIndex(e){for(let t=0;t<this._noteGroups.length;t++)if(e[0]==this._noteGroups[t][0]&&e[1]==this._noteGroups[t][1])return t;return null}addNoteGroup(e,t){if(e<0||t<0)throw new RangeError("StartTime and EndTime must both be greater than 0.");if(e>t)throw new RangeError("StartTime cannot be greater than endTime");if(this.noteGroupsChanged.emit(),0===this._noteGroups.length)return this._noteGroups.push([e,t]),0;if(t<=this._noteGroups[0][0])return this._noteGroups.splice(0,0,[e,t]),0;if(e>=this._noteGroups[this._noteGroups.length-1][1])return this._noteGroups.push([e,t]),this._noteGroups.length-1;for(let i=0;i<this._noteGroups.length-1;i++)if(e>=this._noteGroups[i][1]&&t<=this._noteGroups[i+1][0])return this._noteGroups.splice(i+1,0,[e,t]),i;throw new RangeError("Region invalid, likely collides with other existing region.")}removeNoteGroup(e){let t=0,i=this._noteGroups.length-1,n=0;for(;t<=i;){if(n=Math.floor((t+i)/2),e-this._noteGroups[n][0]==0)return this._noteGroups.splice(n,1),void this.noteGroupsChanged.emit();e-this._noteGroups[n][0]>0?t=n+1:i=n-1}throw new RangeError("Element with given startTime does not exist.")}updateNoteGroups(e){if(0==this._noteGroups.length)return void this.addNoteGroup(e.startPosition,e.endPosition);let t=this.getNoteGroupsWithinTime(e.startPosition,e.endPosition),i=null;if(t.length>1)i=[t[0][0],t[t.length-1][1]],t.forEach((e=>{this.removeNoteGroup(e[0])})),this.addNoteGroup(i[0],i[1]);else if(1==t.length)i=t[0];else if(this.noteGroups[0][0]>e.endPosition)i=this.noteGroups[0];else{let t=1;for(;t<this.noteGroups.length&&this.noteGroups[t][1]<e.startPosition;)t++;i=t==this.noteGroups.length||Math.abs(this.noteGroups[t-1][1]-e.endPosition)<=Math.abs(this.noteGroups[t][0]-e.startPosition)?this.noteGroups[t-1]:this.noteGroups[t]}let n=i;n[0]>e.startPosition&&(n[0]=e.startPosition),n[1]<e.endPosition&&(n[1]=e.endPosition),n!=i?(this.removeNoteGroup(i[0]),this.addNoteGroup(n[0],n[1]),this.noteGroupsChanged.emit()):this.checkNoteGroupBoundaries(this.getNoteGroupIndex(i))}checkNoteGroupBoundaries(e){let t=this.getNoteGroupNotes(e);if(0==t.length)return void this.removeNoteGroup(this._noteGroups[e][0]);let i=t[0].endPosition;for(let e=1;e<t.length;e++)i=Math.max(i,t[e].endPosition);this._noteGroups[e][0]=t[0].startPosition,this._noteGroups[e][1]=i,this.noteGroupsChanged.emit()}getNoteGroupNotes(e){let t=this._noteGroups[e];return this.track.timeline.getEventsBetweenTimes(t[0],t[1])}addEvent(e,t,i){let n=this.track.addNote(e,t,i);return this.updateNoteGroups(n),n}editEvent(e,t,i,n){e.pitchString=i,this.track.timeline.editEvent(this.track.timeline.getIndexOfEvent(e),t,n),this.updateNoteGroups(e)}removeEvent(e){let t=this.getNoteGroupIndex(this.getNoteGroupsWithinTime(e.startPosition,e.endPosition)[0]);this.track.removeNote(e),this.checkNoteGroupBoundaries(t)}destroy(){this.noteGroupsChanged.removeAllListeners(),super.destroy()}}class J extends ${constructor(e,t){super(e.name,e.startY,e.height,t),this.displayActualWidth=!0,this.displayActualWidth=e.displayActualWidth}get eventDuration(){return this.track.soundFileDuration}serialise(){let e=super.serialise();return Object.assign(Object.assign({},e),{type:"soundFile",displayActualWidth:this.displayActualWidth})}getOneShotsBetweenTime(e,t){return this.track.timeline.getEventsBetweenTimes(e,t)}}var ee,te,ie,ne;!function(e){e[e.Beat=0]="Beat",e[e.HalfBeat=1]="HalfBeat",e[e.QuarterBeat=2]="QuarterBeat",e[e.EighthBeat=3]="EighthBeat",e[e.None=4]="None"}(ee||(ee={})),function(e){e[e.Playback=0]="Playback",e[e.Edit=1]="Edit"}(te||(te={})),function(e){e[e.LeftClick=0]="LeftClick",e[e.RightClick=1]="RightClick",e[e.MiddleClick=2]="MiddleClick",e[e.None=3]="None"}(ie||(ie={})),function(e){e[e.Whole=0]="Whole",e[e.Half=1]="Half",e[e.Quarter=2]="Quarter",e[e.Eighth=3]="Eighth",e[e.Sixteenth=4]="Sixteenth",e[e.ThirtySecond=5]="ThirtySecond"}(ne||(ne={}));class se extends n.Container{constructor(){super(),this.mouseIsOver=!1,this.interactive=!0,this.on("pointerdown",this.pointerDownHandler.bind(this)),this.on("pointermove",this.pointerMoveHandler.bind(this)),this.on("pointerup",this.pointerUpHandler.bind(this)),this.on("pointerupoutside",this.pointerUpHandler.bind(this)),this.on("pointerover",this.pointerOverHandler.bind(this)),this.on("pointerout",this.pointerOutHandler.bind(this))}pointerOverHandler(e){this.mouseIsOver=!0}pointerOutHandler(e){this.mouseIsOver=!1}}class ae extends se{pointerDownHandler(e){if(this.mouseIsOver){switch(e.data.button){case 0:this._mouseClickType=ie.LeftClick;break;case 1:this._mouseClickType=ie.MiddleClick;break;case 2:this._mouseClickType=ie.RightClick;break;default:return void(this._mouseClickType=ie.None)}this._startPointerPosition=e.data.getLocalPosition(this.parent)}}pointerMoveHandler(e){}pointerUpHandler(e){this._mouseClickType!=ie.None&&null!=this._mouseClickType&&(class{static distance(e,t){let i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}static distanceSquared(e,t){let i=e.x-t.x,n=e.y-t.y;return i*i+n*n}}.distanceSquared(e.data.getLocalPosition(this.parent),this._startPointerPosition)<10?this.pointerUpClickHandler(e):this.pointerUpDragHandler(e),this._mouseClickType=ie.None,this._startPointerPosition=void 0)}pointerUpClickHandler(e){}pointerUpDragHandler(e){}}class re{constructor(){this._availableObjects=[]}get objectCount(){return this._availableObjects.length}getObject(){return this._availableObjects.length>0?this._availableObjects.pop():null}returnObject(e){this._availableObjects.push(e)}}var oe=i(322),le=i.n(oe);class he extends e.PureComponent{constructor(e){super(e),this.state={currentValue:this.props.value}}render(){return this.props.onRelease?e.createElement(le(),{classNames:he.classNames,minValue:this.props.min,maxValue:this.props.max,step:this.props.step,value:this.state.currentValue,onChange:e=>this.setState({currentValue:e}),onChangeComplete:this.props.onChange}):e.createElement(le(),{classNames:he.classNames,minValue:this.props.min,maxValue:this.props.max,step:this.props.step,value:this.props.value,onChange:this.props.onChange})}}he.classNames={activeTrack:"sliderTrackActive",disabledInputRange:"sliderDisabled",inputRange:"slider",labelContainer:"sliderLabelContainer",maxLabel:"sliderMaxLabel",minLabel:"sliderMinLabel",slider:"sliderHandle",sliderContainer:"sliderHandleContainer",track:"sliderTrack",valueLabel:"sliderValueLabel"};e.PureComponent;class ce extends e.PureComponent{handleClick(){this._inputRef.click()}render(){return e.createElement("div",null,e.createElement("button",{className:this.props.className,title:this.props.title,onClick:this.handleClick.bind(this)},e.createElement("i",{className:this.props.iconName})),e.createElement("input",{style:{position:"absolute",zIndex:-1,opacity:0},type:"file",ref:e=>{this._inputRef=e},onChange:e=>this.props.onChange(e.target.files),accept:this.props.accept}))}}class ue extends e.PureComponent{render(){return e.createElement("div",{className:this.props.className,onClick:()=>{this.props.onChange(!this.props.state)}},e.createElement("p",null,this.props.label),e.createElement("input",{type:"checkbox",name:this.props.label,checked:this.props.state,onChange:e=>{this.props.onChange(e.target.checked)}}))}}class pe extends e.PureComponent{render(){return e.createElement("button",{title:this.props.title,className:this.props.className,onClick:()=>{this.props.onClick()},disabled:this.props.disabled},e.createElement("i",{className:this.props.iconName}))}}class de extends e.PureComponent{constructor(e){super(e),this.state={dropdownVisible:!1}}_handleDropdownClick(){this.setState({dropdownVisible:!this.state.dropdownVisible})}render(){const t="dropdown"+(null==this.props.optionsDivClassName?"":" "+this.props.optionsDivClassName);return e.createElement("div",null,e.createElement(pe,{className:this.props.buttonClassName,title:this.props.title,iconName:this.props.iconName,onClick:()=>{this._handleDropdownClick()}}),this.state.dropdownVisible&&e.createElement(_e,{callback:()=>this.setState({dropdownVisible:!1})},e.createElement("div",{className:t},this.props.optionTitles.map(((t,i)=>e.createElement(me,{key:i,index:i,className:this.props.optionClassName,title:t,callback:e=>{this._handleDropdownClick(),this.props.optionClickCallback(e)}}))))))}}class me extends e.Component{render(){const t="dropdownItem buttonColorAnim"+(null==this.props.className?"":" "+this.props.className);return e.createElement("button",{className:t,onClick:()=>{this.props.callback(this.props.index)}},this.props.title)}}class fe extends e.PureComponent{constructor(t){super(t),this._selectOptionClicked=this._selectOptionClicked.bind(this),this.state={selectVisible:!1},this._selectButton=e.createRef()}_selectOptionClicked(e){this.props.selectedCallback(e,this.props.options[e]),this.setState({selectVisible:!1})}render(){const t="boxSelectButton"+(this.props.selectButtonClassName?" "+this.props.selectButtonClassName:"");return e.createElement("div",{className:this.props.className,style:{display:"flex",flexDirection:"column",alignItems:"center",position:"relative"}},e.createElement("div",null,e.createElement("button",{className:this.props.mainButtonClassName?this.props.mainButtonClassName:"mainBoxSelectButton",title:this.props.title,ref:this._selectButton,onClick:()=>{this.setState({selectVisible:!this.state.selectVisible})}},void 0!==this.props.selected?this.props.options[this.props.selected]:this.props.boxSelectTitle?this.props.boxSelectTitle:this.props.children)),this.state.selectVisible&&e.createElement(_e,{className:"boxSelectWatcher",callback:()=>{this.setState({selectVisible:!1})}},e.createElement(ge,{buttonClassName:t,selectButton:this._selectButton,options:this.props.options,selectOptionClickedCallback:this._selectOptionClicked})))}}class ge extends e.Component{constructor(t){super(t),this.state={renderAbove:!1},this._overlayContainer=e.createRef()}componentDidMount(){this._overlayContainer.current.getBoundingClientRect().bottom>window.innerHeight&&this.setState({renderAbove:!0})}render(){const t="boxSelectOverlay"+(this.props.className?" "+this.props.className:"");let i=this.props.options.map(((t,i)=>e.createElement("button",{className:this.props.buttonClassName,key:i,onClick:()=>{this.props.selectOptionClickedCallback(i)}},t))),n=this.props.selectButton.current;return this.state.renderAbove?e.createElement("div",{className:"boxSelectOverlayContainer",ref:this._overlayContainer,style:{top:-this._overlayContainer.current.offsetHeight-1}},e.createElement("div",{className:t},i),e.createElement("div",{className:"boxSelectOverlayArrow bottom"})):e.createElement("div",{className:"boxSelectOverlayContainer",ref:this._overlayContainer,style:{top:n.offsetHeight+1}},e.createElement("div",{className:"boxSelectOverlayArrow top"}),e.createElement("div",{className:t},i))}}class ve extends e.Component{render(){return e.createElement("div",{className:this.props.className},this.props.buttonContents.map(((t,i)=>{let n,s=!1;return i===this.props.selectedButton&&(s=!0),this.props.buttonTitles&&this.props.buttonTitles.length>i&&(n=this.props.buttonTitles[i]),e.createElement(be,{key:i,title:n,className:this.props.buttonClassName,disabled:this.props.disabled,selected:s,content:t,onClick:()=>{this.props.onButtonClick(i)}})})))}}class be extends e.Component{render(){const t="selectionButton"+(this.props.selected?" selected":"")+(null!=this.props.className?" "+this.props.className:"");return e.createElement("button",{className:t,title:this.props.title,onClick:()=>{this.props.onClick()},disabled:this.props.disabled},this.props.content)}}class _e extends e.Component{constructor(t){super(t),this._childRef=e.createRef(),this.handleClick=this.handleClick.bind(this)}handleClick(e){this._childRef&&e.target instanceof Element&&!this._childRef.current.contains(e.target)&&this.props.callback()}componentDidMount(){document.addEventListener("pointerdown",this.handleClick)}componentWillUnmount(){document.removeEventListener("pointerdown",this.handleClick)}render(){return e.createElement("div",{className:this.props.className,ref:this._childRef},this.props.children," ")}}const ye=document.getElementById("root");class Ce extends e.PureComponent{constructor(e){super(e),this._modalRootChild=document.createElement("div"),this._modalRootChild.className="fullScreen modal"}componentDidMount(){ye.appendChild(this._modalRootChild)}componentWillUnmount(){this._modalRootChild.className+=" hide",setTimeout((()=>{ye.removeChild(this._modalRootChild)}),500)}render(){return this.props.outsideClick?(0,t.createPortal)(e.createElement(_e,{callback:this.props.outsideClick},this.props.children),this._modalRootChild):(0,t.createPortal)(this.props.children,this._modalRootChild)}}function ke(t){return e.createElement("div",{className:"loadDetails"},e.createElement("p",{className:"loadTitle"},t.title),e.createElement("div",{className:"sequencerSpinner"},e.createElement("span",null,"𝅝"),e.createElement("span",null,"𝅗𝅥"),e.createElement("span",null,"𝅘𝅥"),e.createElement("span",null,"𝅘𝅥𝅮")))}function Ee(t){return e.createElement("div",null,e.createElement(pe,{className:"errorModalClose buttonAnim",iconName:"fa fa-close",onClick:t.onClose}),e.createElement("div",{className:"errorModal"},e.createElement("div",{className:"errorModalTitle"},e.createElement("i",{className:"fa fa-exclamation-circle"})),e.createElement("p",{className:"errorModalContent"},t.error)))}class we extends e.Component{render(){return e.createElement(Ce,null,e.createElement(Ee,Object.assign({},this.props)))}}class Ne extends e.Component{render(){return e.createElement(Ce,{outsideClick:this.props.loading?void 0:this.props.onClose},this.props.loading?e.createElement(ke,{title:this.props.title}):e.createElement(Ee,{error:this.props.title,onClose:this.props.onClose}))}}class Te extends e.Component{constructor(e){super(e),this.state={numerator:this.props.numerator.toString(),denominator:this.props.denominator,bpm:this.props.bpm.toString(),modalShown:!1,errorString:""},this.handleNumeratorChange=this.handleNumeratorChange.bind(this),this.handleNumeratorBlur=this.handleNumeratorBlur.bind(this),this.handleDenominatorChange=this.handleDenominatorChange.bind(this),this.handleSubmit=this.handleSubmit.bind(this)}handleNumeratorChange(e){this.setState({numerator:e})}handleNumeratorBlur(e){let t=parseInt(e,10);Number.isNaN(t)||t<=0||t>32?this.setState({numerator:this.props.numerator,modalShown:!0,errorString:"Invalid numerator value - please enter a number between 1 and 32."}):this.setState({numerator:t})}handleDenominatorChange(e){let t=parseInt(e,10);this.setState({denominator:t})}handleBPMChange(e){this.setState({bpm:e})}handleBPMBlur(e){let t=parseInt(e,10);Number.isNaN(t)||t<=0||t>300?this.setState({bpm:this.props.bpm,modalShown:!0,errorString:"Invalid BPM value - please enter a number between 1 and 300."}):this.setState({bpm:t})}handleSubmit(){if(!this.state.modalShown){let e=parseInt(this.state.numerator),t=parseInt(this.state.bpm);this.props.onSubmit(e,this.state.denominator,t)}}render(){return e.createElement("div",{className:"metadataDiv"},e.createElement("div",{className:"boxSelectOverlayArrow top"}),e.createElement("div",{className:"metadataInnerDiv"},e.createElement("div",{className:"metadataProperty"},e.createElement("p",null,"Time Signature:"),e.createElement(Se,{numerator:this.state.numerator,onNumeratorBlur:e=>{this.handleNumeratorBlur(e)},onNumeratorChange:this.handleNumeratorChange,denominator:this.state.denominator,onDenominatorChange:this.handleDenominatorChange})),e.createElement("div",{className:"metadataProperty"},e.createElement("p",null,"BPM:"),e.createElement("input",{className:"metadataBPM",type:"text",size:2,value:this.state.bpm,pattern:"[0-9]*",onBlur:e=>{this.handleBPMBlur(e.target.value)},onChange:e=>{this.handleBPMChange(e.target.value)}})),e.createElement("button",{className:"metadataSubmit",onClick:this.handleSubmit},"Submit")),this.state.modalShown&&e.createElement(we,{error:this.state.errorString,onClose:()=>this.setState({modalShown:!1})}))}}class Se extends e.Component{render(){return e.createElement("div",{className:"metadataTimeSignature",style:{display:"inline-block"}},e.createElement("input",{className:"metadataNumerator",type:"text",value:this.props.numerator,onBlur:e=>{this.props.onNumeratorBlur(e.target.value)},onChange:e=>{this.props.onNumeratorChange(e.target.value)}}),e.createElement("div",{className:"metadataDivider"}),e.createElement(fe,{mainButtonClassName:"metadataDenominator buttonAnim",boxSelectTitle:this.props.denominator.toString(),options:Se.timeSignatureStrings,selectedCallback:e=>{this.props.onDenominatorChange(Se.timeSignatureNumbers[e])}}))}}Se.timeSignatureStrings=["2","4","8","16","32"],Se.timeSignatureNumbers=[2,4,8,16,32];class xe extends ae{constructor(e){super(),this.timeline=e,this._eventEdited=this._eventEdited.bind(this),this._unmountEditDiv=this._unmountEditDiv.bind(this),this._graphics=new n.Graphics,this._graphics.beginFill(X.metadataEventColor).drawRect(0,0,4,K.timelineHeaderHeight).endFill(),this.addChild(this._graphics),this._editDiv=document.createElement("div"),this._editDiv.style.position="absolute",this._editDiv.style.top=K.timelineHeaderHeight.toString()+"px",this._editDivMounted=!1}get active(){return this._active}set active(e){this._active=e,this.alpha=e?1:.4}initialise(e,t){this.active=t;let i=this.timeline.metadata.events[this.timeline.metadata.events.binarySearch(e,!0)];t?(this.event=i,this.alpha=1):this.event=new _(e,i.bpm,i.timeSignature)}pointerOverHandler(e){super.pointerOverHandler(e),this.active||(this.alpha=.7)}pointerOutHandler(e){super.pointerOutHandler(e),this.active||(this.alpha=.4)}pointerUpClickHandler(e){if(this._mouseClickType==ie.LeftClick)this.active||(this.active=!0,this.event=this.timeline.metadata.addMetadataEvent(this.event.startPosition,this.event.bpm,this.event.timeSignature)),this._editDiv.style.left=(this.getGlobalPosition().x+2).toString()+"px",this._mountEditDiv();else if(this.active&&this._mouseClickType==ie.RightClick&&0!=this.event.startPosition){this.active=!1,this.timeline.metadata.removeMetadataEvent(this.event.startPosition),this._unmountEditDiv();let e=this.event.startPosition,t=this.timeline.metadata.events[this.timeline.metadata.events.binarySearch(this.event.startPosition,!0)];this.event=new _(this.event.startPosition,t.bpm,t.timeSignature),this.timeline.regenerateAroundPosition(this.timeline.metadata.positionQuarterNoteToBars(e))}}setVisible(e){this.visible=e,e||this._unmountEditDiv()}destroy(){this._unmountEditDiv(),this._editDiv=null,super.destroy()}_eventEdited(e,t,i){this.event=this.timeline.metadata.addMetadataEvent(this.event.startPosition,i,[e,t]),this._unmountEditDiv(),this.timeline.regenerateAroundPosition(this.timeline.metadata.positionQuarterNoteToBars(this.event.startPosition))}_mountEditDiv(){this._editDivMounted||(document.getElementById("applicationContainer").appendChild(this._editDiv),this._editDivMounted=!0,(0,t.render)(e.createElement(_e,{callback:this._unmountEditDiv},e.createElement(Te,{numerator:this.event.timeSignature[0],denominator:this.event.timeSignature[1],bpm:this.event.bpm,onSubmit:this._eventEdited})),this._editDiv))}_unmountEditDiv(){this._editDivMounted&&((0,t.unmountComponentAtNode)(this._editDiv),document.getElementById("applicationContainer").removeChild(this._editDiv),this._editDivMounted=!1)}}class Pe extends n.Container{constructor(e){super(),this._headerText=new n.Text("",Y.trackFont),this._headerText.x=15,this._headerText.y=11,this._headerGraphics=new n.Graphics,this._metadataTimelineEvent=new xe(e),this.addChild(this._headerGraphics,this._headerText,this._metadataTimelineEvent)}initialise(e,t,i,n,s){return this.setX(e),this._headerGraphics.clear(),this._headerGraphics.beginFill(X.bgColor).drawRect(1,0,t,K.timelineHeaderHeight).endFill().beginFill(X.fgColor).drawRect(1,0,2,K.timelineHeaderHeight).drawRect(1,K.timelineHeaderHeight,t,2).endFill(),this._headerText.text=(i+1).toString(),this._metadataTimelineEvent.initialise(n,s),this}setX(e){this.x=e}setVisible(e){this.visible=e,this._metadataTimelineEvent.setVisible(e)}}class Me extends n.Container{constructor(e,t){super(),this._graphics=new n.Graphics,this.addChild(this._graphics),this._header=new Pe(t),e.addChild(this._header)}get leftBound(){return this.x}get rightBound(){return this.x+this.width}get barNumber(){return this._barNumber}get numberOfBeats(){return this._numberOfBeats}get verticalScrollPosition(){return this._verticalScrollPosition}set verticalScrollPosition(e){this._verticalScrollPosition=e,this._graphics.y=this._verticalScrollPosition}resize(e){this._graphics.clear(),this._graphics.beginFill(X.fgColor),this._graphics.drawRect(1,0,2,e);for(let t=1;t<this._numberOfBeats+1;t++)this._graphics.drawRect(this._beatWidth*t,0,1,e);this._graphics.endFill()}setX(e){this.x=e,this._header.setX(e)}initialise(e,t,i,n,s,a,r,o=!0){return this.x=o?e:e-s*n,this._barNumber=i,this._numberOfBeats=n,this._beatWidth=s,this.resize(t),this._header.initialise(this.x,n*this._beatWidth,this.barNumber,a,r),this}setVisible(e){this.visible=e,this._header.visible=e}}class Oe extends n.Graphics{constructor(){super()}redraw(e,t,i,s){this.clear(),this.beginFill(X.timelineMarkerColor).drawPolygon([new n.Point(e,t),new n.Point(e-4,t-4),new n.Point(e+i+5,t-4),new n.Point(e+i,t)]).drawRect(e,t,i,s).endFill()}}const De=new class{constructor(){this.snapType=ee.Beat,this.noteLength=ne.Quarter,this._noteLengthDisabled=!0,this.noteLengthDisabledChange=new f,this.markerCenteredChanged=new f}get noteLengthDisabled(){return this._noteLengthDisabled}set noteLengthDisabled(e){this._noteLengthDisabled=e,this.noteLengthDisabledChange.emit(e)}get markerCentered(){return this._markerCentered}set markerCentered(e){this._markerCentered=e,this.markerCenteredChanged.emit(e)}};class Ge extends ae{get dragType(){return De.snapType}constructor(e,t,i,s,a){super(),this.timelineMode=te.Edit,this._zoomScale=1,this._verticalScrollPosition=0,this._mouseClickType=ie.None,this._selected=[],this.startX=e,this.startY=i,this.endX=t,this.endY=s,this.songManager=a,this._onScreen=!0,this.timelineViewChange=new f,this._scrollObjects=[],this._barPool=new re,this._maskGraphics=new n.Graphics,this.mask=this._maskGraphics,this._maskGraphics.beginFill(16777215).drawRect(this.startX,this.startY,this.endX,this.endY).endFill(),this._interactivityRect=new n.Graphics,this.addChild(this._interactivityRect),this.resizeInteractiveArea(t,s),this._barContainer=new n.Container,this._headerContainer=new n.Container,this._metadataEventContainer=new n.Container,this._eventContainer=new n.Container,this._timelineMarker=new Oe,this.addChild(this._barContainer,this._eventContainer,this._headerContainer,this._metadataEventContainer,this._timelineMarker),this._timelineMarkerAnim=this._timelineMarkerAnim.bind(this),this._playingStateChanged=this._playingStateChanged.bind(this),this._repositionTimelineMarker=this._repositionTimelineMarker.bind(this),this.songManager.playingChangedEvent.addListener(this._playingStateChanged)}get metadata(){return this.songManager.metadata}get beatWidth(){return Ge.beatWidth*this._zoomScale}resize(e,t){this.resizeInteractiveArea(e,t),this._maskGraphics.clear().beginFill(16777215).drawRect(this.startX,this.startY,e,t).endFill(),this.endX=Math.max(e,this.startX+1),this.endY=Math.max(t,this.startY+1);let i=Math.max(this.contentHeight,this.endY);for(let e=0;e<this._barContainer.children.length;e++){this._barContainer.children[e].resize(i)}let n=this.x+this._scrollObjects[this._scrollObjects.length-1].rightBound-this.endX;for(;n<100;){let e=this._scrollObjects[this._scrollObjects.length-1],t=this._initialiseScrollableBar(e.rightBound,e.barNumber+1,!0);this._scrollObjects.push(t),n=this.x+this._scrollObjects[this._scrollObjects.length-1].rightBound-this.endX}for(;n>800&&this._scrollObjects.length>1;){let e=this._scrollObjects.pop();this._returnScrollableBar(e),n=this.x+this._scrollObjects[this._scrollObjects.length-1].rightBound-this.endX}}resizeInteractiveArea(e,t){this._interactivityRect.clear(),this._interactivityRect.beginFill(0,1),this._interactivityRect.drawRect(0,0,e,t),this._interactivityRect.endFill(),this._interactivityRect.alpha=0}pointerDownHandler(e){super.pointerDownHandler(e),this._mouseClickType!=ie.None&&(this._mouseClickType==ie.LeftClick&&this.timelineViewChange.emit(),this._startPointerPosition=e.data.getLocalPosition(this.parent),this._startXPosition=this.x)}pointerMoveHandler(e){if(this._mouseClickType==ie.RightClick&&this.timelineMode==te.Edit);else if(this._mouseClickType==ie.LeftClick){let t=e.data.getLocalPosition(this.parent).x-this._startPointerPosition.x;this.x=this._startXPosition+t,0===this._scrollObjects[0].barNumber&&this.x+this._scrollObjects[0].leftBound>this.startX&&(this.x=-this._scrollObjects[0].leftBound+this.startX);let i=this.x-this.endX,n=i+this._scrollObjects[this._scrollObjects.length-1].rightBound;for(;n<100;){let e=this._scrollObjects[this._scrollObjects.length-1],t=this._initialiseScrollableBar(e.rightBound,e.barNumber+1,!0);this._scrollObjects.push(t),n=i+this._scrollObjects[this._scrollObjects.length-1].rightBound}for(n=i+this._scrollObjects[this._scrollObjects.length-1].leftBound;n>800;){let e=this._scrollObjects.pop();this._returnScrollableBar(e),n=i+this._scrollObjects[this._scrollObjects.length-1].leftBound}i=this.startX-this.x;let s=i-this._scrollObjects[0].leftBound;for(;s<100&&0!=this._scrollObjects[0].barNumber;){let e=this._scrollObjects[0],t=this._initialiseScrollableBar(e.leftBound,e.barNumber-1,!1);this._scrollObjects.splice(0,0,t),s=i-this._scrollObjects[0].leftBound}for(s=i-this._scrollObjects[0].rightBound;s>800;){let e=this._scrollObjects.splice(0,1)[0];this._returnScrollableBar(e),s=i-this._scrollObjects[0].rightBound}}}pointerUpHandler(e){super.pointerUpHandler(e),this._startXPosition=void 0,this._startPointerPosition=void 0}pointerUpClickHandler(e){if(this._mouseClickType==ie.LeftClick&&(this.x=this._startXPosition,(this.timelineMode==te.Playback||this._startPointerPosition.y<K.timelineHeaderHeight)&&this._startPointerPosition.x>this.startX)){let[e,t,i]=this._getBarFromStageCoordinates(this._startPointerPosition.x);e+=t/i,this.songManager.quarterNotePosition=this.metadata.positionBarsToQuarterNote(e)}}pointerUpDragHandler(e){this._mouseClickType==ie.LeftClick&&(this._offsetChildren(-this.x),this.x=0,De.markerCentered&&(De.markerCentered=!1))}mouseWheelHandler(e,t,i){let n=e.clientX-t,s=e.clientY-i;if(n<this.startX||n>this.endX||s<0||s>this.endY)return;this.timelineViewChange.emit();let[a,r,o]=this._getBarFromStageCoordinates(n);a+=r/o,this._zoomScale=Math.max(.5,Math.min(5,this._zoomScale-e.deltaY/1e3)),this._regenerateTimeline(this._scrollObjects[0].barNumber,Math.floor(a));let l=this._getStageCoordinatesFromBar(a)-n;0===this._scrollObjects[0].barNumber&&this._scrollObjects[0].leftBound-l>this.startX&&(l=this.startX-this._scrollObjects[0].leftBound),this._offsetChildren(l)}updateVerticalScroll(e){this._scrollObjects.forEach((t=>{t.verticalScrollPosition=e})),this._eventContainer.y=e,this._verticalScrollPosition=e}regenerateAroundPosition(e){let t=this._getStageCoordinatesFromBar(e);if(-1===t)this._regenerateTimeline(Math.floor(e));else{this._regenerateTimeline(this._scrollObjects[0].barNumber,Math.floor(e));let i=this._getStageCoordinatesFromBar(e)-t;0===this._scrollObjects[0].barNumber&&this._scrollObjects[0].leftBound-i>this.startX&&(i=this.startX-this._scrollObjects[0].leftBound),this._offsetChildren(i)}}addedHandler(){this._onScreen=!0,this.regenerateAroundPosition(this._scrollObjects[0].barNumber),this._playingStateChanged(this.songManager.playing)}removedHandler(){this._onScreen=!1,this._playingStateChanged(!1),this._mouseClickType=ie.None}destroy(){this.songManager.playingChangedEvent.removeListener(this._playingStateChanged),super.destroy({children:!0})}_getBarFromStageCoordinates(e){for(let t=0;t<this._scrollObjects.length;t++)if(this._scrollObjects[t].leftBound<=e&&this._scrollObjects[t].rightBound>e)return[this._scrollObjects[t].barNumber,(e-this._scrollObjects[t].leftBound)/this.beatWidth,this._scrollObjects[t].numberOfBeats]}_getStageCoordinatesFromBar(e){for(let t=0;t<this._scrollObjects.length;t++)if(this._scrollObjects[t].barNumber===Math.floor(e))return this._scrollObjects[t].leftBound+e%1*this._scrollObjects[t].numberOfBeats*this.beatWidth;return-1}_offsetChildren(e){this._scrollObjects.forEach((t=>{t.setX(t.x-e)}));for(let t=0;t<this._eventContainer.children.length;t++)this._eventContainer.children[t].x-=e;for(let t=0;t<this._metadataEventContainer.children.length;t++)this._metadataEventContainer.children[t].x-=e;this._checkBarsFillScreen(),this._repositionTimelineMarker(this.songManager.quarterNotePosition)}_regenerateTimeline(e,t){let i=e;for(;this._scrollObjects.length>0;)this._returnScrollableBar(this._scrollObjects[0]),this._scrollObjects.splice(0,1);let n=this.startX,s=!1;for(;n<this.endX||!s;){s=!0;let e=this._initialiseScrollableBar(n,i,!0);this._scrollObjects.push(e),i++,n=e.rightBound}if(null!=t)for(;i<=t;){let e=this._initialiseScrollableBar(n,i,!0);this._scrollObjects.push(e),i++,n=e.rightBound}if(0==this._eventContainer.children.length)this._initialiseTrackTimelineEvents();else for(let e=0;e<this._eventContainer.children.length;e++){this._eventContainer.children[e].reinitialise()}this._redrawTimelineMarker()}_checkBarsFillScreen(){for(;this._scrollObjects[0].leftBound>this.startX&&0!=this._scrollObjects[0].barNumber;){let e=this._initialiseScrollableBar(this._scrollObjects[0].leftBound,this._scrollObjects[0].barNumber-1,!1);this._scrollObjects.splice(0,0,e)}for(;this._scrollObjects[this._scrollObjects.length-1].rightBound<this.endX;){let e=this._initialiseScrollableBar(this._scrollObjects[this._scrollObjects.length-1].rightBound,this._scrollObjects[this._scrollObjects.length-1].barNumber+1,!0);this._scrollObjects.push(e)}}_scrollToPosition(e){let t=Math.floor(e);this._regenerateTimeline(t);let i=this.metadata.getTimeSignature(e)[0]*(e%1)*this.beatWidth;this._offsetChildren(i)}_initialiseScrollableBar(e,t,i){let n=null;this._barPool.objectCount>0?(n=this._barPool.getObject(),n.setVisible(!0)):(n=new Me(this._headerContainer,this),this._barContainer.addChild(n));let s=this.metadata.positionBarsToQuarterNote(t),a=this.metadata.getTimeSignature(s)[0],r=!(-1==this.metadata.events.binarySearch(s));return n.initialise(e,Math.max(this.contentHeight,this.endY),t,a,this.beatWidth,s,r,i),n.verticalScrollPosition=this._verticalScrollPosition,n}_returnScrollableBar(e){e.setVisible(!1),this._barPool.returnObject(e)}snapCoordinateToDragType(e){return e-this.getPixelOffsetFromDragType(e)}getPixelOffsetFromDragType(e){switch(this.dragType){case ee.Beat:return e%this.beatWidth;case ee.HalfBeat:return e%(this.beatWidth/2);case ee.QuarterBeat:return e%(this.beatWidth/4);case ee.EighthBeat:return e%(this.beatWidth/8);case ee.None:return 0}}snapBeatToDragType(e){switch(this.dragType){case ee.None:break;case ee.Beat:e-=e%1;break;case ee.HalfBeat:e=((e*=2)-e%1)/2;break;case ee.QuarterBeat:e=((e*=4)-e%1)/4;break;case ee.EighthBeat:e=((e*=8)-e%1)/8}return e}getTimelineEventXWidth(e,t){return[this.getTimelineEventX(e),(this.metadata.positionQuarterNoteToBeats(t)-this.metadata.positionQuarterNoteToBeats(e))*this.beatWidth]}getTimelineEventX(e){return(this.metadata.positionQuarterNoteToBeats(e)-this.metadata.positionQuarterNoteToBeats(this.metadata.positionBarsToQuarterNote(this._scrollObjects[0].barNumber)))*this.beatWidth+this._scrollObjects[0].leftBound}_playingStateChanged(e){1==e&&this._onScreen?(this.timelineMode=te.Playback,requestAnimationFrame(this._timelineMarkerAnim)):(this.timelineMode=te.Edit,this.songManager.quarterNotePositionChangedEvent.hasListener(this._repositionTimelineMarker)||this.songManager.quarterNotePositionChangedEvent.addListener(this._repositionTimelineMarker))}_timelineMarkerAnim(){if(this._repositionTimelineMarker(this.songManager.quarterNotePosition),1==this.songManager.playing)try{if(De.markerCentered&&(this._timelineMarker.x>this.endX||this._timelineMarker.x<this.startX)){let e=this.metadata.positionQuarterNoteToBars(this.songManager.quarterNotePosition);this._scrollToPosition(e)}requestAnimationFrame(this._timelineMarkerAnim)}catch(e){return}}_redrawTimelineMarker(){this._timelineMarker.redraw(0,K.timelineHeaderHeight,2,this.endY),this._repositionTimelineMarker(this.songManager.quarterNotePosition)}_repositionTimelineMarker(e){this._onScreen&&(this._timelineMarker.x=Math.round(this.getTimelineEventX(e)))}}Ge.beatWidth=50;class Le extends n.Container{constructor(e){super(),this.timeline=e,this.y=K.timelineHeaderHeight-Le.triangleSize,this._leftHandle=new Be,this._rightHandle=new Be,this._graphics=new n.Graphics,this.addChild(this._graphics,this._leftHandle,this._rightHandle)}reinitialise(e,t){this.noteGroup=e,null!=t&&(this.y=t);let[i,n]=this.timeline.getTimelineEventXWidth(this.noteGroup[0],this.noteGroup[1]);this.x=i+1,this.redraw(n)}redraw(e){let t=Le.triangleSize;this._graphics.clear().beginFill(X.trackEventColor).drawRect(0,t-Le.lineHeight,e,Le.lineHeight).moveTo(0,0).lineTo(0,t).lineTo(t,t).lineTo(0,0).moveTo(e,0).lineTo(e,t).lineTo(e-t,t).lineTo(e,0).endFill()}}Le.triangleSize=10,Le.lineHeight=4;class Be extends ae{constructor(){super()}}const Re=new class{constructor(){this.buttons=0,document.addEventListener("pointerdown",this._pointerDownHandler.bind(this)),document.addEventListener("pointerup",this._pointerUpHandler.bind(this))}_pointerDownHandler(){this.buttons=1}_pointerUpHandler(){this.buttons=0}};class Fe extends Ge{get noteLength(){return De.noteLength}constructor(e,t,i,s,a,r,o){super(e,t,0,i,a),this.timelineMode=te.Edit,this.track=r,this._contentHeight=s,this._initialiseNoteGroups=this._initialiseNoteGroups.bind(this),this.track.noteGroupsChanged.addListener(this._initialiseNoteGroups),this._noteGroupContainer=new n.Container,this._noteGroupPool=new re,this._newEventGraphics=new n.Graphics,this.addChildAt(this._newEventGraphics,this.children.length-3),this.addChildAt(this._noteGroupContainer,this.children.length-1),this._regenerateTimeline(o)}get contentHeight(){return this._contentHeight}get offsetContentHeight(){return this.contentHeight-Fe.noteHeight}pointerMoveHandler(e){if(this._newEventGraphics.visible=!1,super.pointerMoveHandler(e),this.timelineMode==te.Edit&&0===Re.buttons){this._newEventData=void 0;let t=e.data.getLocalPosition(this.parent);if(t.x<this.startX||t.x>this.endX||t.y<this.startY+K.timelineHeaderHeight||t.y>this.endY)return;let i=t.y-this._verticalScrollPosition;i-=i%20;let n=a.noteNumberToNoteString(Math.max(0,(this.offsetContentHeight-i)/Fe.noteHeight)),[s,r,o]=this._getBarFromStageCoordinates(t.x);r=this.snapBeatToDragType(r),s+=r/o;let l=this.metadata.positionBarsToQuarterNote(s),h=Fe.noteLengthDict[this.noteLength],c={pitchString:n,startPosition:l,duration:h},u=this.track.track.timeline.getEventsBetweenTimes(l,l+h);for(let e=0;e<u.length;e++)if(u[e].pitchString===c.pitchString)return;let p=this._getStageCoordinatesFromBar(s);i+=this._verticalScrollPosition;let d=(this.metadata.positionQuarterNoteToBeats(l+h)-this.metadata.positionQuarterNoteToBeats(l))*this.beatWidth;this._newEventGraphics.clear().beginFill(X.trackEventColor).drawRect(p,i+1,d,Fe.noteHeight-1).endFill().beginHole().drawRect(p+2,i+3,d-4,Fe.noteHeight-5).endHole(),this._newEventData=c,this._newEventGraphics.visible=!0}}pointerUpClickHandler(e){if(super.pointerUpClickHandler(e),this._mouseClickType==ie.LeftClick&&this.timelineMode==te.Edit&&null!=this._newEventData){let e=this.track.addEvent(this._newEventData.startPosition,this._newEventData.pitchString,this._newEventData.duration);this._initialiseNoteGroups(),this._initialiseNote(e),this._newEventData=void 0}}mouseWheelHandler(e,t,i){this._newEventGraphics.visible=!1,super.mouseWheelHandler(e,t,i)}addedHandler(){super.addedHandler(),De.noteLengthDisabled=!1}destroy(){this.track.noteGroupsChanged.removeListener(this._initialiseNoteGroups),super.destroy()}_regenerateTimeline(e,t){super._regenerateTimeline(e,t),this._initialiseNoteGroups()}_offsetChildren(e){super._offsetChildren(e),this._noteGroupContainer.children.forEach((t=>{t.x-=e}))}_initialiseTrackTimelineEvents(){this.track.track.timeline.events.forEach((e=>{this._initialiseNote(e)}))}_initialiseNote(e){let t=this.offsetContentHeight-a.noteStringToNoteNumber(e.pitchString)*Fe.noteHeight,i=new Ie(this,this.track,e,t,Fe.noteHeight-1);return i.borderHeight=1,this._eventContainer.addChild(i),i}_initialiseNoteGroups(){this._noteGroupContainer.children.forEach((e=>{e.visible=!1,this._noteGroupPool.returnObject(e)})),this.track.noteGroups.forEach((e=>{let t=this._noteGroupPool.getObject();null==t&&(t=new Le(this),this._noteGroupContainer.addChild(t)),t.visible=!0,t.reinitialise(e)}))}}Fe.noteHeight=20,Fe.noteLengthDict={[ne.Whole]:4,[ne.Half]:2,[ne.Quarter]:1,[ne.Eighth]:.5,[ne.Sixteenth]:.25,[ne.ThirtySecond]:.125};class Ae extends ae{constructor(e,t,i,s,a,r){super(),this.borderLeft=1,this.borderRight=2,this.borderHeight=2,this.paddingHeight=2,this.selectedBorderWidth=3,this._hovered=!1,this._opacity=1,this._hoveredColor=X.trackEventHoveredColor,this.timeline=e,this.track=t,this._contentGraphics=new n.Graphics,this._selectedGraphics=new n.Graphics,this._selectedGraphics.zIndex=1,this.addChild(this._contentGraphics,this._selectedGraphics),this.x=i+this.borderLeft,this.assignedWidth=Math.max(s-this.borderRight,5),this.assignedHeight=r-this.borderHeight,this.y=a+this.borderHeight}reinitialise(e,t){let[i,n]=this.timeline.getTimelineEventXWidth(this.eventStartPosition,this.eventStartPosition+this.eventDuration);this.x=i+this.borderLeft,this.assignedWidth=Math.max(n-this.borderRight,5),null!=e&&(this.y=e),null!=t&&(this.assignedHeight=t),this.redraw()}get leftBound(){return this.x}get rightBound(){return this.x+this.width}get hovered(){return this._hovered}set hovered(e){this._hovered=e,this.redrawSelected()}get hoveredColor(){return this._hoveredColor}set hoveredColor(e){null==e&&(e=X.trackEventHoveredColor),this._hoveredColor=e,this.redrawSelected()}get opacity(){return this._opacity}set opacity(e){if(e<0||e>1)throw new RangeError("Opacity must be between 0 and 1.");this._opacity=e,this.redraw()}destroy(){super.destroy({children:!0})}redraw(){this._contentGraphics.clear(),this._contentGraphics.beginFill(X.trackEventColor,this._opacity).drawRect(0,0,this.assignedWidth,this.assignedHeight).endFill(),this.redrawSelected()}redrawSelected(){this._selectedGraphics.clear(),this.hovered&&this._selectedGraphics.beginFill(this._hoveredColor,this.opacity).drawRect(0,0,this.assignedWidth,this.assignedHeight).endFill().beginHole().drawRect(this.selectedBorderWidth,this.selectedBorderWidth,this.assignedWidth-2*this.selectedBorderWidth,this.assignedHeight-2*this.selectedBorderWidth).endHole()}pointerDownHandler(e){super.pointerDownHandler(e),this._mouseClickType!=ie.None&&this.timeline.timelineMode==te.Edit&&(e.stopPropagation(),this._mouseClickType==ie.LeftClick?this.hoveredColor=X.trackEventSelectedColor:this._mouseClickType==ie.RightClick&&(this.hoveredColor=X.trackEventDeleteColor),this._startXPosition=this.x,this._startYPosition=this.y,this._startPointerPosition=e.data.getLocalPosition(this.parent),this._snappedStartPointerPosition=this._startPointerPosition.clone(),this._snappedStartPointerPosition.x=this.timeline.snapCoordinateToDragType(this._snappedStartPointerPosition.x))}pointerMoveHandler(e){if(this._mouseClickType==ie.LeftClick&&this.timeline.timelineMode==te.Edit){e.stopPropagation();let t=this.timeline.snapCoordinateToDragType(e.data.getLocalPosition(this.parent).x)-this._snappedStartPointerPosition.x,i=this.timeline.metadata.positionQuarterNoteToBeats(this.eventStartPosition)+t/this.timeline.beatWidth;i<0&&(t-=i*this.timeline.beatWidth),this.x=this._startXPosition+t}}pointerUpHandler(e){super.pointerUpHandler(e),this._destroyed||(this.hoveredColor=X.trackEventHoveredColor,this._startXPosition=void 0,this._startYPosition=void 0,this._startPointerPosition=void 0,this._snappedStartPointerPosition=void 0)}pointerUpClickHandler(e){e.stopPropagation(),this._mouseClickType==ie.LeftClick?(this.x=this._startXPosition,this.clickHandler()):this.timeline.timelineMode==te.Edit&&this._mouseClickType==ie.RightClick&&this.deleteEvent()}pointerUpDragHandler(e){if(this.timeline.timelineMode==te.Edit)if(this._mouseClickType==ie.LeftClick){let t=e.data.getLocalPosition(this.parent),i=this.timeline.snapCoordinateToDragType(t.x)-this._snappedStartPointerPosition.x,s=t.y-this._snappedStartPointerPosition.y,a=this.timeline.metadata.positionQuarterNoteToBeats(this.eventStartPosition)+i/this.timeline.beatWidth;a<0&&(i-=a*this.timeline.beatWidth);let r=new n.Point(i,s);this.dragHandler(r)}else this._mouseClickType==ie.RightClick&&this.mouseIsOver&&this.deleteEvent()}pointerOverHandler(e){super.pointerOverHandler(e),this._hovered=!0,this.redrawSelected()}pointerOutHandler(e){super.pointerOutHandler(e),this._hovered=!1,this.redrawSelected()}deleteEvent(){this.destroy()}}class je extends Ae{constructor(e,t,i,n){let[s,a]=e.getTimelineEventXWidth(i[0],i[1]);super(e,t,s,a,t.startY,t.height),this._noteGroup=i,this._clickCallback=n,this.redraw()}get noteGroup(){return this._noteGroup}get eventStartPosition(){return this._noteGroup[0]}get eventDuration(){return this._noteGroup[1]-this._noteGroup[0]}redraw(){super.redraw(),this._notes=this.track.track.timeline.getEventsBetweenTimes(this._noteGroup[0],this._noteGroup[1]),this.setNotes(this._notes,this.track.track.highestPitch,this.track.track.lowestPitch,this._noteGroup)}setNotes(e,t,i,n){let s=a.distanceBetweenNotes(t,i)+1,r=this.timeline.metadata,o=r.positionQuarterNoteToBeats(n[0]),l=r.positionQuarterNoteToBeats(n[1]),h=(this.track.height-2*this.paddingHeight)/s,c=e=>(r.positionQuarterNoteToBeats(e)-o)/(l-o);this._contentGraphics.beginFill(X.trackEventHighlightColor,this._opacity),e.forEach((e=>{let i=c(e.startPosition)*this.assignedWidth,n=c(e.endPosition)*this.assignedWidth;this._contentGraphics.drawRect(i,a.distanceBetweenNotes(t,e.pitchString)*h+this.paddingHeight+je.noteMarginHeight,n-i-2,h-2*je.noteMarginHeight)})),this._contentGraphics.endFill()}dragHandler(e){let t=this.timeline.metadata,i=Object.assign([],this._noteGroup),n=e.x/this.timeline.beatWidth;i[0]=t.positionBeatsToQuarterNote(t.positionQuarterNoteToBeats(i[0])+n);let s=i[0]-this._noteGroup[0];i[1]=i[1]+s;let a=this.track.getNoteGroupsWithinTime(i[0],i[1]),r=!0;for(let e=0;e<a.length;e++)if(a[e][0]!=this._noteGroup[0]||a[e][1]!=this._noteGroup[1]){r=!1;break}r?(this._notes.forEach((e=>{this.track.track.timeline.removeEvent(e),e.startPosition=e.startPosition+s,this.track.track.timeline.addEvent(e)})),this.track.removeNoteGroup(this._noteGroup[0]),this.track.addNoteGroup(i[0],i[1]),this._noteGroup=i,this.reinitialise()):this.x=this._startXPosition}deleteEvent(){this._notes.forEach((e=>{this.track.track.removeNote(e)})),delete this._notes,this.track.removeNoteGroup(this.noteGroup[0]),super.deleteEvent()}clickHandler(){this._clickCallback(this.track,this.eventStartPosition)}}je.noteMarginHeight=2;class He extends Ae{constructor(e,t,i){let[n,s]=e.getTimelineEventXWidth(i.startPosition,i.endPosition);t.displayActualWidth||(s=0),super(e,t,n,s,t.startY,t.height),this.event=i,this._modelEventRemoved=this._modelEventRemoved.bind(this),this.event.removed.addListener(this._modelEventRemoved),this.redraw()}get eventStartPosition(){return this.event.startPosition}get eventDuration(){return this.track.displayActualWidth?this.event.duration:0}destroy(){this.event.removed.removeListener(this._modelEventRemoved),super.destroy()}deleteEvent(){this.track.track.timeline.removeEvent(this.event),super.deleteEvent()}_modelEventRemoved(){this.event.removed.removeListener(this._modelEventRemoved),super.deleteEvent()}dragHandler(e){let t=e.x/this.timeline.beatWidth,i=this.timeline.metadata.positionBeatsToQuarterNote(this.timeline.metadata.positionQuarterNoteToBeats(this.event.startPosition)+t),n=this.track.track.timeline.getEventsBetweenTimes(i,i+this.event.duration),s=!0;for(let e=0;e<n.length;e++)if(n[e]!=this.event){s=!1;break}if(s){let e=this.track.track.timeline.getIndexOfEvent(this.event);this.track.track.timeline.editEvent(e,i),this.reinitialise()}else this.x=this._startXPosition}clickHandler(){}}class Ie extends Ae{constructor(e,t,i,n,s){let[a,r]=e.getTimelineEventXWidth(i.startPosition,i.endPosition);super(e,t,a,r,n,s),this.event=i,this._modelEventRemoved=this._modelEventRemoved.bind(this),this.event.removed.addListener(this._modelEventRemoved),this.redraw()}get eventStartPosition(){return this.event.startPosition}get eventDuration(){return this.event.duration}pointerDownHandler(e){super.pointerDownHandler(e),this._snappedStartPointerPosition.y=this._snappedStartPointerPosition.y-this._snappedStartPointerPosition.y%Fe.noteHeight+Fe.noteHeight}pointerMoveHandler(e){if(super.pointerMoveHandler(e),this._mouseClickType==ie.LeftClick){let t=e.data.getLocalPosition(this.parent).y-this._snappedStartPointerPosition.y,i=a.noteStringToNoteNumber(this.event.pitchString),n=Math.min(this.timeline.offsetContentHeight-K.timelineHeaderHeight,Math.max(0,i*Fe.noteHeight-t));this._lastNoteNumber=Math.floor(n/Fe.noteHeight),this.y=this._startYPosition-(this._lastNoteNumber-i)*Fe.noteHeight}}destroy(){this.event.removed.removeListener(this._modelEventRemoved),super.destroy()}deleteEvent(){this.track.removeEvent(this.event),super.deleteEvent()}_modelEventRemoved(){this.event.removed.removeListener(this._modelEventRemoved),super.deleteEvent()}dragHandler(e){let t=e.x/this.timeline.beatWidth,i=a.noteNumberToNoteString(this._lastNoteNumber),n=this.timeline.metadata.positionBeatsToQuarterNote(this.timeline.metadata.positionQuarterNoteToBeats(this.event.startPosition)+t),s=this.track.track.timeline.getEventsBetweenTimes(n,n+this.event.duration),r=!0;for(let e=0;e<s.length;e++)if(s[e]!=this.event&&s[e].pitchString==i){r=!1;break}r?(this.track.editEvent(this.event,n,i),this.reinitialise()):(this.x=this._startXPosition,this.y=this._startYPosition)}clickHandler(){}}var Ve=i(121),qe=function(){return Math.random().toString(36).substring(7).split("").join(".")},We={INIT:"@@redux/INIT"+qe(),REPLACE:"@@redux/REPLACE"+qe(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+qe()}};function Ue(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}const ze={tracks:[]};const Qe=function e(t,i,n){var s;if("function"==typeof i&&"function"==typeof n||"function"==typeof n&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function.");if("function"==typeof i&&void 0===n&&(n=i,i=void 0),void 0!==n){if("function"!=typeof n)throw new Error("Expected the enhancer to be a function.");return n(e)(t,i)}if("function"!=typeof t)throw new Error("Expected the reducer to be a function.");var a=t,r=i,o=[],l=o,h=!1;function c(){l===o&&(l=o.slice())}function u(){if(h)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return r}function p(e){if("function"!=typeof e)throw new Error("Expected the listener to be a function.");if(h)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribelistener for more details.");var t=!0;return c(),l.push(e),function(){if(t){if(h)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribelistener for more details.");t=!1,c();var i=l.indexOf(e);l.splice(i,1),o=null}}}function d(e){if(!Ue(e))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(h)throw new Error("Reducers may not dispatch actions.");try{h=!0,r=a(r,e)}finally{h=!1}for(var t=o=l,i=0;i<t.length;i++){(0,t[i])()}return e}function m(e){if("function"!=typeof e)throw new Error("Expected the nextReducer to be a function.");a=e,d({type:We.REPLACE})}function f(){var e,t=p;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function i(){e.next&&e.next(u())}return i(),{unsubscribe:t(i)}}})[Ve.Z]=function(){return this},e}return d({type:We.INIT}),(s={dispatch:d,subscribe:p,getState:u,replaceReducer:m})[Ve.Z]=f,s}((function(e=ze,t){switch(t.type){case"ADD_TRACK":return{tracks:[...e.tracks,t.track]};case"REMOVE_TRACK":let i=e.tracks.filter(((e,i)=>i!=t.index));if(i.length>0){i[0].startY=K.timelineHeaderHeight;for(let e=1;e<i.length;e++)i[e].startY=i[e-1].startY+i[e-1].height}return{tracks:i};case"SET_TRACKS":return{tracks:t.tracks};default:return e}}));class Xe extends Ge{constructor(e,t,i,s,a){super(e,t,0,i,s),this.songManager=s,this._noteGroupTimelineEvents=[],this._showSequencerCallback=a,this._newEventGraphics=new n.Graphics,this.addChildAt(this._newEventGraphics,this.children.length-3),this._regenerateTimeline(0),this._UITrackUpdateHandler=this._UITrackUpdateHandler.bind(this),this._cleanupListener=Qe.subscribe(this._UITrackUpdateHandler)}get contentHeight(){let e=Qe.getState().tracks;return 0==e.length?0:e[e.length-1].startY+e[e.length-1].height}destroy(){this._cleanupListener(),super.destroy()}pointerMoveHandler(e){let t=Qe.getState().tracks;if(this._newEventGraphics.visible=!1,super.pointerMoveHandler(e),this.timelineMode==te.Edit&&0===Re.buttons){this._newEventData=void 0;let i=e.data.getLocalPosition(this.parent);i.y-=this._newEventGraphics.y;for(let e=0;e<t.length;e++)if(t[e].startY+this._verticalScrollPosition<i.y&&t[e].startY+t[e].height+this._verticalScrollPosition>i.y){let n=t[e];if(i.x<this.startX||i.x>this.endX)return;let[s,a,r]=this._getBarFromStageCoordinates(i.x);a=this.snapBeatToDragType(a),s+=a/r;let o=this.metadata.positionBarsToQuarterNote(s),l=o,h=this._getStageCoordinatesFromBar(s),c=n.startY+this._verticalScrollPosition,u=0,p=n.height;if(n instanceof Z){if(l=o+4,n.getNoteGroupsWithinTime(o,l).length>0)return}else if(n instanceof J){l=o+n.eventDuration;let e=n.getOneShotsBetweenTime(o,l);if(!n.track.allowOverlaps&&e.length>0)return;if(1==e.length&&e[0].startPosition==o&&e[0].endPosition==l)return}u=(this.metadata.positionQuarterNoteToBeats(l)-this.metadata.positionQuarterNoteToBeats(o))*this.beatWidth,u=Math.max(u,5),this._newEventGraphics.clear(),this._newEventGraphics.beginFill(X.trackEventColor).drawRect(h,c+2,u,p-2).endFill().beginHole().drawRect(h+2,c+4,u-4,p-6).endHole(),this._newEventGraphics.visible=!0,this._newEventData={track:n,startPosition:o};break}}else this._newEventGraphics.visible=!1}pointerUpClickHandler(e){if(super.pointerUpClickHandler(e),this._mouseClickType==ie.LeftClick&&this.timelineMode==te.Edit&&null!=this._newEventData){let e=this._newEventData.track,t=this._newEventData.startPosition;if(e instanceof Z)e.addNoteGroup(t,t+4),this._initialiseNoteGroup([t,t+4],e);else if(e instanceof J){let i=e.track.addOneShot(t);this._initialiseOneShotTimelineEvent(i,e)}this._newEventData=void 0}}mouseWheelHandler(e,t,i){this._newEventGraphics.visible=!1,super.mouseWheelHandler(e,t,i)}regenerateTracks(){for(;this._eventContainer.children[0];){this._eventContainer.children[0].destroy()}this._noteGroupTimelineEvents=[],this._initialiseTrackTimelineEvents()}reinitialiseTrack(e){for(let t=0;t<this._eventContainer.children.length;t++){let i=this._eventContainer.children[t];i.track===e&&i.reinitialise()}}regenerateNoteGroups(){this._noteGroupTimelineEvents.forEach((e=>{e.destroy()})),this._noteGroupTimelineEvents=[],Qe.getState().tracks.forEach((e=>{e instanceof Z&&e.noteGroups.forEach((t=>{this._initialiseNoteGroup(t,e)}))}))}addedHandler(){this.regenerateNoteGroups(),De.noteLengthDisabled=!0,super.addedHandler()}_initialiseTrackTimelineEvents(){let e=Qe.getState().tracks;for(let t=0;t<e.length;t++){let i=e[t];i instanceof Z?i.noteGroups.forEach((e=>{this._initialiseNoteGroup(e,i)})):i instanceof J&&i.track.timeline.events.forEach((e=>{this._initialiseOneShotTimelineEvent(e,i)}))}}_initialiseNoteGroup(e,t){let i=new je(this,t,e,this._showSequencerCallback);return this._eventContainer.addChild(i),this._noteGroupTimelineEvents.push(i),i}_initialiseOneShotTimelineEvent(e,t){let i=new He(this,t,e);return this._eventContainer.addChild(i),i}_UITrackUpdateHandler(){let e=Math.max(this.contentHeight,this.endY);for(let t=0;t<this._barContainer.children.length;t++){this._barContainer.children[t].resize(e)}this.regenerateTracks()}}var Ye=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((n=n.apply(e,t||[])).next())}))};const Ke=document.getElementById("root");class $e extends n.Container{constructor(e,t,i,s){super(),this._verticalScroll=0,this.songManager=s,this._sidebarWidth=e,this.trackEdited=new f,this._gainChanged=this._gainChanged.bind(this),this._nameChanged=this._nameChanged.bind(this),this._soundFileChanged=this._soundFileChanged.bind(this),this._allowOverlapChanged=this._allowOverlapChanged.bind(this),this._displayActualWidthChanged=this._displayActualWidthChanged.bind(this),this._updateSoundFile=this._updateSoundFile.bind(this),this._deleteTrack=this._deleteTrack.bind(this),this._connectionChanged=this._connectionChanged.bind(this),this.drawTracks=this.drawTracks.bind(this),this._envelopeEnabledChanged=this._envelopeEnabledChanged.bind(this),this._envelopeAttackChanged=this._envelopeAttackChanged.bind(this),this._envelopeReleaseChanged=this._envelopeReleaseChanged.bind(this),this._oscillatorTypeChanged=this._oscillatorTypeChanged.bind(this),this._trackListGraphics=new n.Graphics,this._trackLineGraphics=new n.Graphics,this.addChild(this._trackListGraphics,this._trackLineGraphics),this._trackSettingsContainer=document.createElement("div"),this._trackSettingsContainer.style.position="absolute",this._trackSettingsContainer.style.width=this._sidebarWidth.toString()+"px",this._trackSettingsContainer.style.overflow="hidden",document.getElementById("applicationContainer").appendChild(this._trackSettingsContainer),this.resize(t,i),this._cleanupListener=Qe.subscribe(this.drawTracks)}resize(e,t){this.endX=e,this.endY=t,this._trackListGraphics.clear().beginFill(X.bgColor).drawRect(0,0,this._sidebarWidth,this.endY).endFill(),this._trackListGraphics.beginFill(X.fgColor).drawRect(this._sidebarWidth-2,0,3,this.endY).drawRect(0,K.timelineHeaderHeight,this._sidebarWidth,2).endFill(),this.drawTracks()}updateVerticalScroll(e){this._trackLineGraphics.y=e,this._verticalScroll=e,this._rerenderList()}destroy(){(0,t.unmountComponentAtNode)(this._trackSettingsContainer),this._cleanupListener(),super.destroy({children:!0})}addedHandler(){this._trackSettingsContainer.style.removeProperty("display")}removedHandler(){this._trackSettingsContainer.style.display="none"}drawTracks(){let e=Qe.getState().tracks;this._trackLineGraphics.clear(),e.length>0?(this._trackLineGraphics.beginFill(X.fgColor),e.forEach((e=>{this._trackLineGraphics.drawRect(0,e.startY+e.height,this.endX,2)})),this._trackLineGraphics.endFill(),this._trackLineGraphics.mask=(new n.Graphics).beginFill(16777215).drawRect(0,K.timelineHeaderHeight,this.endX,this.endY).endFill(),this._trackSettingsContainer.style.top=e[0].startY.toString()+"px",this._trackSettingsContainer.style.height=(this.endY-e[0].startY).toString()+"px",this._rerenderList()):(0,t.unmountComponentAtNode)(this._trackSettingsContainer)}_nameChanged(e,t){Qe.getState().tracks[e].name=t,this._rerenderList()}_gainChanged(e,t){Qe.getState().tracks[e].track.audioSource.masterGain=t,this._rerenderList()}_soundFileChanged(i,n){let s=document.createElement("div");Ke.appendChild(s),(0,t.render)(e.createElement(Ne,{loading:!0,title:"Loading Sound File...",onClose:()=>{(0,t.unmountComponentAtNode)(s)}}),s);let a=n[0];const r=URL.createObjectURL(a);var o=new XMLHttpRequest;o.open("GET",r,!0),o.responseType="blob";let l=this._updateSoundFile;o.onload=function(n){200==this.status?(l(i,this.response),(0,t.unmountComponentAtNode)(s),Ke.removeChild(s)):(0,t.render)(e.createElement(Ne,{loading:!1,title:"Unknown error. Please try again.",onClose:()=>{(0,t.unmountComponentAtNode)(s),Ke.removeChild(s)}}),s)},o.send()}_updateSoundFile(e,t){return Ye(this,void 0,void 0,(function*(){let i=Qe.getState().tracks[e].track;yield i.setSoundFile(t),this.trackEdited.emit(e)}))}_allowOverlapChanged(e,t){Qe.getState().tracks[e].track.allowOverlaps=t,this._rerenderList()}_displayActualWidthChanged(e,t){Qe.getState().tracks[e].displayActualWidth=t,this.trackEdited.emit(e),this._rerenderList()}_connectionChanged(e,t){let i=Qe.getState().tracks;i[e].track.connectTo(i[e].track.possibleConnections[t]),this._rerenderList()}_deleteTrack(e){let t=Qe.getState().tracks;this.songManager.removeTrack(t[e].track),Qe.dispatch({type:"REMOVE_TRACK",index:e})}_oscillatorTypeChanged(e,t){let i=Qe.getState().tracks[e];i instanceof Z&&(i.track.audioSource.oscillatorType=t.toLowerCase(),this._rerenderList())}_envelopeEnabledChanged(e,t){let i=Qe.getState().tracks[e];i instanceof Z&&(i.track.audioSource.envelopeEnabled=t,this._rerenderList())}_envelopeAttackChanged(e,t){let i=Qe.getState().tracks[e];i instanceof Z&&(t=Math.max(0,Math.min(4,t)),i.track.audioSource.envelope.attack=t,this._rerenderList())}_envelopeReleaseChanged(e,t){let i=Qe.getState().tracks[e];i instanceof Z&&(t=Math.max(0,Math.min(4,t)),i.track.audioSource.envelope.release=t,this._rerenderList())}_rerenderList(){let i=Qe.getState().tracks;i.length>0&&(0,t.render)(e.createElement(Ze,{tracks:i,possibleConnections:this.songManager.connectionManager.possibleConnectionStrings,onNameChange:this._nameChanged,onGainChange:this._gainChanged,onSoundFileUpdate:this._soundFileChanged,onAllowOverlapChange:this._allowOverlapChanged,onDisplayActualWidthChange:this._displayActualWidthChanged,onDeleteTrack:this._deleteTrack,onConnectionChanged:this._connectionChanged,width:this._sidebarWidth,verticalScroll:this._verticalScroll,onOscillatorTypeChanged:this._oscillatorTypeChanged,onEnvelopeEnabledChanged:this._envelopeEnabledChanged,onEnvelopeAttackChanged:this._envelopeAttackChanged,onEnvelopeReleaseChanged:this._envelopeReleaseChanged}),this._trackSettingsContainer)}}class Ze extends e.Component{render(){return e.createElement("div",{style:{position:"absolute",top:this.props.verticalScroll.toString()+"px"}},this.props.tracks.map(((t,i)=>{if(t instanceof J)return e.createElement(Je,{key:i,index:i,name:t.name,onNameChange:this.props.onNameChange,gain:t.track.audioSource.masterGain,onGainChange:this.props.onGainChange,deleteTrack:this.props.onDeleteTrack,width:this.props.width,height:t.height,soundFileChange:this.props.onSoundFileUpdate,displayActualWidth:t.displayActualWidth,displayActualWidthChange:this.props.onDisplayActualWidthChange,allowOverlap:t.track.allowOverlaps,allowOverlapChange:this.props.onAllowOverlapChange,connection:t.track.connection,connectionOptions:this.props.possibleConnections,connectionChanged:this.props.onConnectionChanged});if(t instanceof Z){let s=t.track.audioSource,a={enabled:s.envelopeEnabled,enabledChanged:this.props.onEnvelopeEnabledChanged,attack:s.envelope.attack,attackChanged:this.props.onEnvelopeAttackChanged,release:s.envelope.release,releaseChanged:this.props.onEnvelopeReleaseChanged};return e.createElement(et,{key:i,index:i,name:t.name,onNameChange:this.props.onNameChange,gain:t.track.audioSource.masterGain,onGainChange:this.props.onGainChange,deleteTrack:this.props.onDeleteTrack,width:this.props.width,height:t.height,oscillatorType:(n=t.track.audioSource.oscillatorType,n.charAt(0).toUpperCase()+n.slice(1)),oscillatorTypeChanged:this.props.onOscillatorTypeChanged,envelopeSettings:a,connection:t.track.connection,connectionOptions:this.props.possibleConnections,connectionChanged:this.props.onConnectionChanged})}var n})))}}class Je extends e.PureComponent{constructor(e){super(e),this.handleNameChange=this.handleNameChange.bind(this),this.handleGainChange=this.handleGainChange.bind(this),this.handleConnectionChanged=this.handleConnectionChanged.bind(this)}handleNameChange(e){this.props.onNameChange(this.props.index,e)}handleGainChange(e){this.props.onGainChange(this.props.index,e)}handleConnectionChanged(e){this.props.connectionChanged(this.props.index,e)}render(){return e.createElement("div",{style:{position:"relative"}},e.createElement(pe,{className:"trackSettingsDeleteButton buttonColorAnim",title:"Delete Track",iconName:"fa fa-close",onClick:()=>{this.props.deleteTrack(this.props.index)}}),e.createElement("div",{className:"trackSettingsDiv",style:{width:this.props.width,height:this.props.height}},e.createElement("input",{className:"trackSettingsName",type:"text",value:this.props.name,size:Math.max(1,this.props.name.length),onChange:e=>{this.handleNameChange(e.target.value)}}),e.createElement(he,{min:0,max:1,step:.01,value:this.props.gain,onChange:this.handleGainChange}),e.createElement(ce,{className:"trackSettingsIconInput buttonColorAnim",title:"Set Sound File",iconName:"fa fa-music",onChange:e=>{this.props.soundFileChange(this.props.index,e)},accept:"audio/*"}),e.createElement(ue,{className:"trackSettingsInteractable pointer",label:"Display Actual Width:",state:this.props.displayActualWidth,onChange:e=>{this.props.displayActualWidthChange(this.props.index,e)}}),e.createElement(ue,{className:"trackSettingsInteractable pointer",label:"Allow Overlaps:",state:this.props.allowOverlap,onChange:e=>{this.props.allowOverlapChange(this.props.index,e)}}),e.createElement(fe,{className:"trackSettingsBoxSelect",boxSelectTitle:this.props.connection,options:this.props.connectionOptions,selectedCallback:this.handleConnectionChanged})))}}class et extends e.PureComponent{constructor(e){super(e),this.handleNameChange=this.handleNameChange.bind(this),this.handleGainChange=this.handleGainChange.bind(this),this.handleConnectionChanged=this.handleConnectionChanged.bind(this)}handleNameChange(e){this.props.onNameChange(this.props.index,e)}handleGainChange(e){this.props.onGainChange(this.props.index,e)}handleConnectionChanged(e){this.props.connectionChanged(this.props.index,e)}render(){let t=this.props.envelopeSettings;return e.createElement("div",{style:{position:"relative"}},e.createElement(pe,{className:"trackSettingsDeleteButton buttonColorAnim",title:"Delete Effect",iconName:"fa fa-close",onClick:()=>{this.props.deleteTrack(this.props.index)}}),e.createElement("div",{className:"trackSettingsDiv",style:{width:this.props.width,height:this.props.height}},e.createElement("input",{className:"trackSettingsName",type:"text",value:this.props.name,size:Math.max(1,this.props.name.length),onChange:e=>{this.handleNameChange(e.target.value)}}),e.createElement(he,{min:0,max:1,step:.01,value:this.props.gain,onChange:this.handleGainChange}),e.createElement("div",{className:"trackSettingsInteractable"},e.createElement("p",null,"Type:"),e.createElement(fe,{boxSelectTitle:this.props.oscillatorType,options:et.oscillatorOptions,selectedCallback:e=>{this.props.oscillatorTypeChanged(this.props.index,et.oscillatorOptions[e])}})),e.createElement(tt,{enabled:t.enabled,enabledChanged:e=>{t.enabledChanged(this.props.index,e)},attack:t.attack,attackChanged:e=>{t.attackChanged(this.props.index,e)},release:t.release,releaseChanged:e=>{t.releaseChanged(this.props.index,e)}}),e.createElement(fe,{className:"trackSettingsBoxSelect",boxSelectTitle:this.props.connection,options:this.props.connectionOptions,selectedCallback:this.handleConnectionChanged})))}}et.oscillatorOptions=["Sine","Square","Sawtooth","Triangle"];class tt extends e.PureComponent{constructor(t){super(t),this.state={detailsVisible:!1},this._openCloseButton=e.createRef()}render(){return e.createElement("div",{className:"oscillatorEnvelopeContainer"},e.createElement("button",{className:"mainBoxSelectButton",ref:this._openCloseButton,onClick:()=>{this.setState({detailsVisible:!this.state.detailsVisible})}},"Envelope Settings"),this.state.detailsVisible&&e.createElement(_e,{callback:()=>this.setState({detailsVisible:!1})},e.createElement(it,Object.assign({},this.props,{mainButton:this._openCloseButton}))))}}class it extends e.Component{constructor(e){super(e),this.state={lastAttackValue:"",lastReleaseValue:""}}render(){let t=!this.props.enabled;return e.createElement("div",{className:"envelopeOverlayOuterContainer",style:{left:this.props.mainButton.current.offsetWidth+2}},e.createElement("div",{className:"envelopeOverlayInnerContainer"},e.createElement("div",{className:"boxSelectOverlayArrow left"}),e.createElement("div",{className:"boxSelectOverlay envelopeOverlayContent"},e.createElement("div",{className:"effectProperty"},e.createElement("p",null,"Enabled:"),e.createElement("input",{type:"checkbox",checked:this.props.enabled,onChange:e=>{this.props.enabledChanged(e.target.checked)}})),e.createElement("div",{className:"effectProperty"},e.createElement("p",null,"Attack:"),e.createElement("input",{type:"number",step:"0.01",value:parseFloat(this.state.lastAttackValue)===this.props.attack?this.state.lastAttackValue:this.props.attack.toString(),onChange:e=>{this.setState({lastAttackValue:e.target.value}),this.props.attackChanged(e.target.value)},disabled:t})),e.createElement("div",{className:"effectProperty"},e.createElement("p",null,"Release:"),e.createElement("input",{type:"number",step:"0.01",value:parseFloat(this.state.lastReleaseValue)===this.props.release?this.state.lastReleaseValue:this.props.release.toString(),onChange:e=>{this.setState({lastReleaseValue:e.target.value}),this.props.releaseChanged(e.target.value)},disabled:t})))))}}class nt extends ae{constructor(e,t){super(),this.scrollingEnabled=!0,this._sidebarPosition=K.sequencerSidebarWidth,this._verticalScrollPosition=0,this._interactivityRect=new n.Graphics,this.addChild(this._interactivityRect),this.endX=e,this.endY=t,this.resizeInteractiveArea(e,t),this.on("added",this.addedHandler),this.on("removed",this.removedHandler)}resize(e,t){this.endX=e,this.endY=t,this.resizeInteractiveArea(e,t),this.timeline.resize(e,t)}get verticalScrollPosition(){return this._verticalScrollPosition}set verticalScrollPosition(e){let t=this._verticalScrollPosition;this._verticalScrollPosition=Math.min(0,Math.max(-this.contentHeight+this.endY-2,e)),t!=this._verticalScrollPosition&&this.updateVerticalScroll(this._verticalScrollPosition)}resizeInteractiveArea(e,t){this._interactivityRect.clear(),this._interactivityRect.beginFill(0,1),this._interactivityRect.drawRect(0,0,e,t),this._interactivityRect.endFill(),this._interactivityRect.alpha=0}pointerDownHandler(e){super.pointerDownHandler(e),this._mouseClickType!=ie.None&&(this._startPointerPosition=e.data.getLocalPosition(this),this._startVerticalScrollPosition=this._verticalScrollPosition)}pointerMoveHandler(e){this._mouseClickType==ie.LeftClick&&this.scrollingEnabled&&(this.verticalScrollPosition=e.data.getLocalPosition(this).y-this._startPointerPosition.y+this._startVerticalScrollPosition)}pointerUpHandler(e){super.pointerUpHandler(e),this._startPointerPosition=void 0,this._startVerticalScrollPosition=void 0}pointerUpDragHandler(e){this._mouseClickType==ie.LeftClick&&this.scrollingEnabled&&(this.verticalScrollPosition=e.data.getLocalPosition(this).y-this._startPointerPosition.y+this._startVerticalScrollPosition)}mouseWheelHandler(e,t,i){this.timeline.mouseWheelHandler(e,t,i)}addedHandler(){this.timeline.addedHandler()}removedHandler(){this.timeline.removedHandler()}destroy(){super.destroy({children:!0})}}class st extends nt{constructor(i,s,a,r,o){super(i,s),this.timeline=new Fe(this._sidebarPosition,i,s,this.contentHeight,r,a,o),this._sidebarUI=(new n.Graphics).beginFill(X.bgColor).drawRect(0,0,this._sidebarPosition,s).endFill(),this._sidebarUI.beginFill(X.fgColor).drawRect(0,K.timelineHeaderHeight,this._sidebarPosition,2).drawRect(this._sidebarPosition-4,0,4,s).endFill(),this._noteList=new at(this._sidebarPosition,i,s,st.numNotes),this.addChild(this._sidebarUI,this._noteList,this.timeline),this._backButtonContainer=document.createElement("div"),Object.assign(this._backButtonContainer.style,{position:"absolute",top:"5px",left:"5px"}),document.getElementById("applicationContainer").appendChild(this._backButtonContainer),(0,t.render)(e.createElement(pe,{iconName:"fa fa-arrow-left",onClick:()=>{Q.back()}}),this._backButtonContainer)}get contentHeight(){return Fe.noteHeight*st.numNotes}resize(e,t){super.resize(e,t),this._sidebarUI.clear(),this._sidebarUI.beginFill(X.bgColor).drawRect(0,0,this._sidebarPosition,t).endFill(),this._sidebarUI.beginFill(X.fgColor).drawRect(this._sidebarPosition-4,0,4,t).endFill(),this._noteList.resize(e,t)}destroy(){(0,t.unmountComponentAtNode)(this._backButtonContainer),document.getElementById("applicationContainer").removeChild(this._backButtonContainer),super.destroy()}updateVerticalScroll(e){e=Math.min(0,e),this.timeline.updateVerticalScroll(e),this._noteList.y=e}}st.numNotes=99;class at extends n.Container{constructor(e,t,i,s){super(),this._numNotes=s-2,this._horizontalLines=new n.Graphics,this._horizontalLines.y=K.timelineHeaderHeight;for(let t=0;t<this._numNotes;t++){let i=t*Fe.noteHeight,s=new n.Text(a.noteNumberToNoteString(this._numNotes-1-t),Y.trackFont);s.x=e/2-s.width/2,s.y=K.timelineHeaderHeight+i+Fe.noteHeight/2-s.height/2+1,this.addChild(s)}this.addChild(this._horizontalLines),this.resize(t,i)}resize(e,t){this._horizontalLines.beginFill(X.fgColor);for(let t=0;t<this._numNotes;t++){let i=t*Fe.noteHeight;this._horizontalLines.drawRect(0,i,e,1)}this._horizontalLines.endFill(),this.mask=(new n.Graphics).beginFill(16777215).drawRect(0,K.timelineHeaderHeight,e,t).endFill()}}var rt=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((n=n.apply(e,t||[])).next())}))};class ot extends nt{constructor(e,t,i){super(e,t),this._sidebarPosition=K.timelineSidebarWidth,this._songManager=i,this.interactive=!0,this.showSequencer=this.showSequencer.bind(this),this.addedHandler=this.addedHandler.bind(this),this.removedHandler=this.removedHandler.bind(this),this._trackEdited=this._trackEdited.bind(this),this._UITrackUpdateHandler=this._UITrackUpdateHandler.bind(this),this.on("added",this.addedHandler),this.on("removed",this.removedHandler),this.trackList=new $e(this._sidebarPosition,e,t,i),this.trackList.trackEdited.addListener(this._trackEdited),this.addChild(this.trackList),this.timeline=new Xe(this._sidebarPosition,e,t,i,this.showSequencer),this.addChild(this.timeline),this._newTrackDropdownContainer=document.createElement("div"),document.getElementById("applicationContainer").appendChild(this._newTrackDropdownContainer),Object.assign(this._newTrackDropdownContainer.style,{position:"absolute",top:"5px",left:"5px"}),this._renderNewTrackObject(),this._cleanupListener=Qe.subscribe(this._UITrackUpdateHandler)}get contentHeight(){let e=Qe.getState().tracks;return 0==e.length?0:e[e.length-1].startY+e[e.length-1].height}resize(e,t){super.resize(e,t),this.trackList.resize(e,t)}destroy(){(0,t.unmountComponentAtNode)(this._newTrackDropdownContainer),document.getElementById("applicationContainer").removeChild(this._newTrackDropdownContainer),this.removeAllListeners(),this._cleanupListener(),super.destroy()}showSequencer(e,t){let i=new st(this.endX,this.endY,e,this._songManager,Math.floor(this.timeline.metadata.positionQuarterNoteToBars(t)));Q.show(i)}addedHandler(){super.addedHandler(),this.trackList.addedHandler(),this._renderNewTrackObject()}removedHandler(){super.removedHandler(),this.trackList.removedHandler(),(0,t.unmountComponentAtNode)(this._newTrackDropdownContainer)}addOscillatorTrack(){let e=Qe.getState().tracks,t=this._songManager.addOscillatorTrack(),i=0!=this.contentHeight?this.contentHeight:K.timelineHeaderHeight,n={name:"Track "+(e.length+1).toString(),startY:i,height:250,modelTrackID:t.id,noteGroups:[]};Qe.dispatch({type:"ADD_TRACK",track:new Z(n,t)})}addSoundFileTrack(){return rt(this,void 0,void 0,(function*(){let e=Qe.getState().tracks,t=yield this._songManager.addSoundFileTrack(),i=0!=this.contentHeight?this.contentHeight:K.timelineHeaderHeight,n={type:"soundFile",name:"Track "+(e.length+1).toString(),startY:i,height:250,displayActualWidth:!0,modelTrackID:t.id};Qe.dispatch({type:"ADD_TRACK",track:new J(n,t)})}))}updateVerticalScroll(e){e=Math.min(0,e),this.timeline.updateVerticalScroll(e),this.trackList.updateVerticalScroll(e)}_trackEdited(e){let t=Qe.getState().tracks;this.timeline.reinitialiseTrack(t[e])}_UITrackUpdateHandler(){let e=Qe.getState().tracks;if(e.length>0){let t=e[e.length-1],i=t.startY+t.height+this.verticalScrollPosition;i<this.endY&&(this.verticalScrollPosition+=this.endY-i)}else this.verticalScrollPosition=0;this._renderNewTrackObject()}_renderNewTrackObject(){let i="addTrackButton";0==Qe.getState().tracks.length&&(i+=" highlight"),(0,t.render)(e.createElement(de,{title:"New Track",iconName:"fa fa-plus",optionTitles:["New Oscillator Track","New Sound File Track"],buttonClassName:i,optionsDivClassName:"addTrackOptionsDiv",optionClassName:"addTrackItem",optionClickCallback:e=>rt(this,void 0,void 0,(function*(){0==e?this.addOscillatorTrack():1==e&&(yield this.addSoundFileTrack())}))}),this._newTrackDropdownContainer)}}class lt extends e.Component{constructor(e){super(e),this._snapTypeChanged=this._snapTypeChanged.bind(this),this._lengthTypeChanged=this._lengthTypeChanged.bind(this),this._lengthEnabledChanged=this._lengthEnabledChanged.bind(this),this.state={selectedSnapButton:De.snapType,selectedLengthButton:De.noteLength,lengthEnabled:De.noteLengthDisabled}}componentDidMount(){De.noteLengthDisabledChange.addListener(this._lengthEnabledChanged)}componentWillUnmount(){De.noteLengthDisabledChange.removeListener(this._lengthEnabledChanged)}_snapTypeChanged(e){this.setState({selectedSnapButton:e}),De.snapType=e}_lengthTypeChanged(e){this.setState({selectedLengthButton:e}),De.noteLength=e}_lengthEnabledChanged(e){this.setState({lengthEnabled:e})}render(){return e.createElement("div",{className:"editPanel"},e.createElement("div",{className:"selectionGroup"},e.createElement("p",{className:"selectionGroupTitle"},"Snap Type:"),e.createElement(ve,{className:"snapTypeGroup",buttonClassName:"panelButton buttonAnim",disabled:!1,selectedButton:this.state.selectedSnapButton,buttonContents:["1",e.createElement(ht,{n:1,d:2}),e.createElement(ht,{n:1,d:4}),e.createElement(ht,{n:1,d:8}),e.createElement("p",null,"✖")],buttonTitles:["Snap to Whole Beat","Snap To Half Beat","Snap To Quarter Beat","Snap to Eighth Beat","No Snapping"],onButtonClick:this._snapTypeChanged})),e.createElement("div",{className:"selectionGroup"},e.createElement("p",{className:"selectionGroupTitle"},"Note Length:"),e.createElement(ve,{className:"lengthTypeGroup",buttonClassName:"panelButton buttonAnim noteButton",disabled:this.state.lengthEnabled,selectedButton:this.state.selectedLengthButton,buttonContents:[e.createElement("span",null,"𝅝"),e.createElement("span",null,"𝅗𝅥"),e.createElement("span",null,"𝅘𝅥"),e.createElement("span",null,"𝅘𝅥𝅮"),e.createElement("span",null,"𝅘𝅥𝅯"),e.createElement("span",null,"𝅘𝅥𝅰")],buttonTitles:["Whole Note","Half Note","Quarter Note","8th Note","16th Note","32nd Note"],onButtonClick:this._lengthTypeChanged})))}}class ht extends e.PureComponent{render(){return e.createElement("p",{style:{fontFamily:"Arial, Helvetica, sans-serif"}},e.createElement("sup",null,this.props.n),"⁄",e.createElement("sub",null,this.props.d))}}class ct extends e.Component{constructor(e){super(e),this._markerCenteredChanged=this._markerCenteredChanged.bind(this),this._playingStateChanged=this._playingStateChanged.bind(this),De.markerCenteredChanged.addListener(this._markerCenteredChanged),this.state={playing:this.props.songManager.playing,markerCentred:De.markerCentered}}_playingStateChanged(e){this.setState({playing:e})}_markerCenteredChanged(e){this.setState({markerCentred:e})}componentDidMount(){this.props.songManager.playingChangedEvent.addListener(this._playingStateChanged)}componentWillUnmount(){this.props.songManager.playingChangedEvent.removeListener(this._playingStateChanged)}render(){let t="panelButton buttonAnim";return e.createElement("div",{className:"playbackPanel"},e.createElement("div",{className:"playbackButtons"},e.createElement(ut,{className:t,playing:this.state.playing,playFunction:()=>{this.props.songManager.start()},pauseFunction:()=>{this.props.songManager.stop()}}),e.createElement(pe,{className:t,title:"Stop",iconName:"fa fa-stop",onClick:()=>{this.props.songManager.stopToBeginning(),this.setState({playing:this.props.songManager.playing})}})),e.createElement("button",{className:"recentreButton buttonAnim",onClick:()=>{De.markerCentered=!0},style:{visibility:!this.state.markerCentred&&this.props.songManager.playing?"visible":"hidden"}},"Recentre Marker"))}}class ut extends e.Component{constructor(e){super(e)}render(){let t=null,i=null,n="";return this.props.playing?(n="Pause",t="fa fa-pause",i=this.props.pauseFunction):(n="Play",t="fa fa-play",i=this.props.playFunction),e.createElement(pe,{title:n,className:this.props.className,iconName:t,onClick:i})}}const pt=ReactBeautifulDnd;class dt extends e.Component{constructor(e){super(e),this._deserialiseFunction=()=>{this.forceUpdate()},this._effectChanged=this._effectChanged.bind(this),this._effectRemoved=this._effectRemoved.bind(this),this._newEffect=this._newEffect.bind(this),this._moveEffect=this._moveEffect.bind(this),this._selectedChainChanged=this._selectedChainChanged.bind(this),this._deleteCurrentChain=this._deleteCurrentChain.bind(this),this._preGainChanged=this._preGainChanged.bind(this),this._postGainChanged=this._postGainChanged.bind(this),this._connectionChanged=this._connectionChanged.bind(this),this.state={currentChainNumber:0,hidden:!1}}get currentChain(){return 0===this.state.currentChainNumber?this.props.connectionManager.bus:this.props.connectionManager.chains[this.state.currentChainNumber-1]}get chainsAndBus(){return[this.props.connectionManager.bus].concat(this.props.connectionManager.chains)}_newEffect(e){this.currentChain.addEffect(this.currentChain.effects.length,V.possibleEffects.get(mt.effectTitles[e])()),this.setState({currentChainNumber:this.state.currentChainNumber})}_effectChanged(e,t,i){let n=this.currentChain.effects[e].properties[t];n.value=i,this.currentChain.effectNodes[e][n.propertyName]=i,this.setState({currentChainNumber:this.state.currentChainNumber})}_effectRemoved(e){this.currentChain.removeEffect(e),this.setState({currentChainNumber:this.state.currentChainNumber})}_moveEffect(e,t){this.currentChain.moveEffect(e,t),this.setState({currentChainNumber:this.state.currentChainNumber})}_hidePanel(){this.setState({hidden:!this.state.hidden},(()=>{this.state.hidden?this.props.hideShowCallback():setTimeout((()=>{this.props.hideShowCallback()}),500)}))}_selectedChainChanged(e){e>this.props.connectionManager.chains.length&&this.props.connectionManager.addChain(),this.setState({currentChainNumber:e})}_deleteCurrentChain(){this.props.connectionManager.removeChain(this.currentChain.chainName),this.setState({currentChainNumber:0})}_preGainChanged(e){this.currentChain.preGain=e}_postGainChanged(e){this.currentChain.postGain=e}_connectionChanged(e,t){let i=this.currentChain;i!==this.props.connectionManager.bus&&this.props.connectionManager.getConnections(i)[0]!=t&&(console.log(this.props.connectionManager.getConnections(i)[0]),this.props.connectionManager.removeAllConnections(i),this.props.connectionManager.addConnection(i,t),this.setState({currentChainNumber:this.state.currentChainNumber}))}componentDidMount(){this.props.connectionManager.effectsDeserialised.addListener(this._deserialiseFunction)}componentWillUnmount(){this.props.connectionManager.effectsDeserialised.removeListener(this._deserialiseFunction)}render(){let t=this.chainsAndBus.map((e=>e.chainName));t.push("New Chain...");let i=this.currentChain;return e.createElement("div",{className:"effectsChainPanel"+(this.state.hidden?" hidden":"")},e.createElement(pe,{title:this.state.hidden?"Show Effects":"Hide Effects",className:"effectsChainHideShowButton",iconName:this.state.hidden?"fa fa-caret-left":"fa fa-caret-right",onClick:()=>{this._hidePanel()}}),e.createElement("div",{className:"effectsChainContent"},e.createElement("div",{className:"effectsChainPanelTitle"},e.createElement(fe,{title:"New Chain",mainButtonClassName:"effectsChainTitleButton",selectButtonClassName:"effectsChainSelectButton",selected:this.state.currentChainNumber,options:t,selectedCallback:this._selectedChainChanged}),e.createElement(pe,{title:"Delete Chain",className:"effectsChainButton buttonColorAnim size title",iconName:"fa fa-close",onClick:this._deleteCurrentChain,disabled:"Bus"===i.chainName})),e.createElement(mt,{effectsChain:i.effects,moveEffect:this._moveEffect,effectPropertyChanged:this._effectChanged,newEffect:this._newEffect,effectRemoved:this._effectRemoved,preGainValue:i.preGain,preGainValueChanged:this._preGainChanged,postGainValue:i.postGain,postGainValueChanged:this._postGainChanged,connection:this.props.connectionManager.getConnections(i)[0],connectionOptions:i===this.props.connectionManager.bus?["Context"]:["Context","Bus"],connectionChangedCallback:this._connectionChanged})))}}class mt extends e.Component{constructor(e){super(e),this._onDragEnd=this._onDragEnd.bind(this)}_onDragEnd(e){e.destination&&e.source.index!=e.destination.index&&this.props.moveEffect(e.source.index,e.destination.index)}render(){let t=this.props.effectsChain.map(((t,i)=>e.createElement(ft,Object.assign({key:t.id,effectIndex:i},t,{onPropertyChange:this.props.effectPropertyChanged,onDelete:this.props.effectRemoved}))));return e.createElement("div",{className:"effectsList"},e.createElement("div",{className:"effectsListDivider",style:{marginTop:"0px"}}),e.createElement("div",{className:"effectProperty range"},e.createElement("p",{className:"effectTitleText"},"Input Gain:"),e.createElement(he,{value:this.props.preGainValue,min:0,max:1,step:.01,onRelease:!0,onChange:this.props.preGainValueChanged})),e.createElement("div",{className:"effectProperty range "},e.createElement("p",{className:"effectTitleText"},"Output Gain:"),e.createElement(he,{value:this.props.postGainValue,min:0,max:1,step:.01,onRelease:!0,onChange:this.props.postGainValueChanged})),e.createElement("div",{className:"effectProperty list"},e.createElement("p",{className:"effectTitleText"},"Output:"),e.createElement(fe,{mainButtonClassName:"",boxSelectTitle:this.props.connection,options:this.props.connectionOptions,selectedCallback:this.props.connectionChangedCallback})),e.createElement("div",{className:"effectsListDivider"}),e.createElement("p",{className:"effectTitleText"},"Effects:"),e.createElement(pt.DragDropContext,{onDragEnd:this._onDragEnd},e.createElement(pt.Droppable,{droppableId:"effectsList"},((i,n)=>e.createElement("div",Object.assign({className:"effectsListDroppable effectsListElement"+(n.isDraggingOver?" dragging":""),ref:i.innerRef},i.droppableProps),t,i.placeholder)))),e.createElement(fe,{mainButtonClassName:"effectsChainButton buttonColorAnim dropdownButton",title:"New Effect",options:mt.effectTitles,selectedCallback:this.props.newEffect},e.createElement("i",{className:"fa fa-plus"})))}}mt.effectTitles=Array.from(V.possibleEffects.keys());class ft extends e.Component{constructor(t){super(t),this.state={collapsed:!0},this._contentRef=e.createRef()}render(){return e.createElement(pt.Draggable,{draggableId:this.props.id,index:this.props.effectIndex},((t,i)=>e.createElement("div",Object.assign({className:"chainEffect"+(i.isDragging?" dragging":""),ref:t.innerRef},t.draggableProps),e.createElement("div",Object.assign({className:"chainEffectTitle"},t.dragHandleProps),e.createElement(pe,{className:"effectsChainButton buttonColorAnim size",title:this.state.collapsed?"Expand":"Collapse",iconName:"fa "+(this.state.collapsed?"fa-chevron-right":"fa-chevron-down"),onClick:()=>this.setState({collapsed:!this.state.collapsed})}),e.createElement("p",{className:"effectTitleText",style:{marginRight:"5px"}},this.props.effectType),e.createElement(pe,{className:"effectsChainButton buttonColorAnim size",title:"Delete Effect",iconName:"fa fa-close",onClick:()=>{this.props.onDelete(this.props.effectIndex)}})),e.createElement("div",{ref:this._contentRef,className:"effectContent",style:{maxHeight:this.state.collapsed?void 0:this._contentRef.current?this._contentRef.current.scrollHeight+"px":"initial"}},this.props.properties.map(((t,i)=>{if(t.editable)switch(t.type){case"number":return t.hasOwnProperty("min")?e.createElement(bt,Object.assign({key:i,effectIndex:this.props.effectIndex,propertyIndex:i},t,{onChange:this.props.onPropertyChange})):e.createElement(vt,Object.assign({key:i,effectIndex:this.props.effectIndex,propertyIndex:i},t,{onChange:this.props.onPropertyChange}));case"string":return e.createElement(_t,Object.assign({key:i,effectIndex:this.props.effectIndex,propertyIndex:i},t,{onChange:this.props.onPropertyChange}));case"boolean":return e.createElement(yt,Object.assign({key:i,effectIndex:this.props.effectIndex,propertyIndex:i},t,{onChange:this.props.onPropertyChange}));case"list":return e.createElement(Ct,Object.assign({key:i,effectIndex:this.props.effectIndex,propertyIndex:i},t,{onChange:this.props.onPropertyChange}));default:return console.log("Unknown property type: "+t.type),null}}))))))}}function gt(e){return e.charAt(0).toUpperCase()+e.slice(1)}class vt extends e.PureComponent{render(){let t=gt(this.props.displayName?this.props.displayName:this.props.propertyName)+":";return e.createElement("div",{className:"effectProperty number"},e.createElement("p",null,t),e.createElement("input",{type:"number",name:t,value:this.props.value,step:this.props.step,onChange:e=>{this.props.onChange(this.props.effectIndex,this.props.propertyIndex,e.target.value)}}))}}class bt extends e.PureComponent{render(){let t=gt(this.props.displayName?this.props.displayName:this.props.propertyName)+":";return e.createElement("div",{className:"effectProperty range"},e.createElement("p",null,t),e.createElement(he,{onRelease:!0,min:this.props.min,max:this.props.max,step:this.props.step,value:this.props.value,onChange:e=>{this.props.onChange(this.props.effectIndex,this.props.propertyIndex,e)}}))}}class _t extends e.PureComponent{render(){let t=gt(this.props.displayName?this.props.displayName:this.props.propertyName)+":";return e.createElement("div",{className:"effectProperty string"},e.createElement("p",null,t),e.createElement("input",{type:"text",name:t,value:this.props.value,onChange:e=>{this.props.onChange(this.props.effectIndex,this.props.propertyIndex,e.target.value)}}))}}class yt extends e.PureComponent{render(){let t=gt(this.props.displayName?this.props.displayName:this.props.propertyName)+":";return e.createElement("div",{className:"effectProperty boolean"},e.createElement("p",null,t),e.createElement("input",{type:"checkbox",name:t,checked:this.props.value,onChange:e=>{this.props.onChange(this.props.effectIndex,this.props.propertyIndex,e.target.checked)}}))}}class Ct extends e.PureComponent{render(){let t=gt(this.props.displayName?this.props.displayName:this.props.propertyName)+":";return e.createElement("div",{className:"effectProperty list"},e.createElement("p",null,t),e.createElement(fe,{selected:this.props.options.indexOf(this.props.value),options:this.props.options,selectedCallback:e=>{this.props.onChange(this.props.effectIndex,this.props.propertyIndex,this.props.options[e])}}))}}var kt=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((n=n.apply(e,t||[])).next())}))};class Et extends e.Component{constructor(t){super(t),this._modalCloseFunc=()=>{this.setState({modalShown:!1})},this.state={modalShown:!1,modalLoading:!0,modalText:""},this._serialise=this._serialise.bind(this),this._deserialise=this._deserialise.bind(this),this._getFile=this._getFile.bind(this),this._saveToWAV=this._saveToWAV.bind(this),this._inputRef=e.createRef()}_serialise(){this.setState({modalShown:!0,modalLoading:!0,modalText:"Saving to File..."});let e=Qe.getState().tracks.map((e=>e.serialise())),t=this.props.songManager.serialise(),i=Object.assign(Object.assign({},t),{UITracks:e}),n=JSON.stringify(i),s=document.createElement("a"),a=new Blob([n],{type:"application/web-sequencer"});s.href=URL.createObjectURL(a),s.download=(new Date).toLocaleDateString()+".sqn",s.click(),this.setState({modalShown:!1})}_deserialise(){this._inputRef.current.click()}_getFile(e){this.setState({modalShown:!0,modalLoading:!0,modalText:"Loading File..."});const t=e.target.files[0];if(t){let e=new FileReader;e.onloadend=()=>kt(this,void 0,void 0,(function*(){let t=JSON.parse(e.result);if("object"!=typeof t||!t.hasOwnProperty("fileType")||"SequencerSongSettings"!=t.fileType)return void console.log("Invalid file type.");yield this.props.songManager.deserialise(t);let i=[];for(let e=0;e<t.UITracks.length;e++){let n=t.UITracks[e],s=this.props.songManager.tracks.find((e=>e.id==n.modelTrackID));if(null!=s)switch(n.type){case"oscillator":i.push(new Z(n,s));break;case"soundFile":i.push(new J(n,s));break;default:console.log("Invalid track type: ",n.type)}else console.log("UITrack with missing ID found: ",n)}for(Qe.dispatch({type:"SET_TRACKS",tracks:i});Q.viewDepth>1;)Q.back();this.setState({modalShown:!1})})),e.readAsText(t)}else this.setState({modalLoading:!1,modalText:"Invalid File"})}_saveToWAV(){return kt(this,void 0,void 0,(function*(){this.setState({modalShown:!0,modalLoading:!0,modalText:"Generating WAV..."});let e=null;try{e=yield this.props.songManager.saveToWAV()}catch(e){return void this.setState({modalLoading:!1,modalText:"Please add events to the song before saving."})}let t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=(new Date).toLocaleDateString()+".wav",t.click(),this.setState({modalShown:!1,modalText:""})}))}componentDidMount(){this._inputRef.current.addEventListener("change",this._getFile)}componentWillUnmount(){this._inputRef.current.removeEventListener("change",this._getFile)}render(){let t="panelButton buttonAnim";return e.createElement("div",{className:"serialisePanel"},e.createElement(pe,{className:t,title:"Save File",iconName:"fa fa-save",onClick:this._serialise}),e.createElement(pe,{className:t,title:"Open File",iconName:"fa fa-folder-open",onClick:this._deserialise}),e.createElement(pe,{className:t,title:"Download as WAV",iconName:"fa fa-music",onClick:this._saveToWAV}),this.state.modalShown&&e.createElement(Ne,{loading:this.state.modalLoading,title:this.state.modalText,onClose:this._modalCloseFunc}),e.createElement("input",{type:"file",ref:this._inputRef,accept:".sqn",style:{position:"absolute",top:"-9999px"}}))}}class wt extends e.Component{constructor(t){super(t),this._hideShowCallback=()=>{this._timelineRef.current.resizePIXIApp()},this.state={songManager:new U},this._timelineRef=e.createRef()}componentDidMount(){this.props.hideLoader()}componentWillUnmount(){this.state.songManager.destroy()}render(){return e.createElement("div",{className:"fullScreen"},e.createElement("div",{style:{position:"relative",width:"100%",height:"100%"}},e.createElement("div",{className:"sequencerAppTopBar"},e.createElement(ct,{songManager:this.state.songManager}),e.createElement(lt,null),e.createElement(Et,{songManager:this.state.songManager})),e.createElement("div",{className:"sequencerAppMainPanel"},e.createElement(Nt,{ref:this._timelineRef,className:"sequencerAppMainPanelLeft",songManager:this.state.songManager}),e.createElement(dt,{connectionManager:this.state.songManager.connectionManager,hideShowCallback:this._hideShowCallback}))))}}class Nt extends e.PureComponent{constructor(t){super(t),this.state={pixiApp:null},n.settings.ROUND_PIXELS=!0,this._pixiContainer=e.createRef(),this.resizePIXIApp=this.resizePIXIApp.bind(this)}resizePIXIApp(){const e=this.state.pixiApp.view.parentElement;this.state.pixiApp.renderer.resize(e.clientWidth,e.clientHeight),Q.currentElement.resize(e.clientWidth,e.clientHeight),this.state.pixiApp.render()}componentDidMount(){let e=new n.Application;e.view.setAttribute("oncontextmenu","return false;"),e.view.addEventListener("mousedown",(function(e){e.preventDefault()})),e.renderer.backgroundColor=X.bgColor,this._pixiContainer.current.appendChild(e.view),window.addEventListener("resize",this.resizePIXIApp);const t=e.view.parentElement;e.renderer.resize(t.clientWidth,t.clientHeight);let i=new ot(e.renderer.width,e.renderer.height,this.props.songManager);e.view.addEventListener("wheel",(t=>Q.passWheelEvent(t,e.renderer.view.getBoundingClientRect().left,e.renderer.view.getBoundingClientRect().top))),Q.setStageRenderer(e.stage,e.renderer),Q.show(i),this.setState({pixiApp:e},this.resizePIXIApp)}componentWillUnmount(){window.removeEventListener("resize",this.resizePIXIApp),null!=this.state.pixiApp&&this.state.pixiApp.destroy(!0)}render(){return e.createElement("div",{className:this.props.className},e.createElement("div",{id:"applicationContainer",ref:this._pixiContainer}))}}let Tt=document.getElementById("loader");document.title="WebSequencer",(0,t.render)(e.createElement(wt,{hideLoader:()=>{Tt.className+=" hide",setTimeout((()=>{Tt.parentElement.removeChild(Tt)}),500)}}),document.getElementById("root"))})()})();
//# sourceMappingURL=bundle.js.map